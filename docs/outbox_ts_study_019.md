# ç¬¬19ç« ï¼šDead Letterï¼ˆå¤±æ•—ã‚’éš”é›¢ã—ã¦äººãŒç›´ã›ã‚‹ã‚ˆã†ã«ï¼‰ğŸ“®ğŸ˜¢â¡ï¸ğŸ™‚

## 19.1 Dead Letterã£ã¦ãªã«ï¼Ÿï¼ˆã–ã£ãã‚Šä¸€è¨€ï¼‰ğŸ§ âœ¨

**ä½•å›ãƒªãƒˆãƒ©ã‚¤ã—ã¦ã‚‚ãƒ€ãƒ¡ãªâ€œå•é¡Œå…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸â€ã‚’ã€ã„ã£ãŸã‚“åˆ¥ã®å ´æ‰€ã«éš”é›¢ã™ã‚‹ä»•çµ„ã¿**ã ã‚ˆğŸ“®ğŸ—ƒï¸
ã“ã†ã™ã‚‹ã¨ã€é€šå¸¸ã®å‡¦ç†ãƒ©ã‚¤ãƒ³ãŒæ­¢ã¾ã‚‰ãšã«æµã‚Œç¶šã‘ã¦ã€ã‚ã¨ã§äººãŒè½ã¡ç€ã„ã¦ç›´ã›ã‚‹ğŸ™‚ğŸ«¶

---

## 19.2 ãªãœå¿…è¦ï¼Ÿï¼ˆDead LetterãŒãªã„ä¸–ç•Œã®åœ°ç„ï¼‰ğŸ”¥ğŸ˜µâ€ğŸ’«

Dead LetterãŒãªã„ã¨ã€ã“ã‚“ãªäº‹æ•…ãŒèµ·ããŒã¡ğŸ‘‡

* **æ¯’å…¥ã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆPoison Messageï¼‰**ãŒ1ä»¶æ··ã–ã‚‹
  â†’ ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒæ¯å›ãã“ã§å¤±æ•—
  â†’ **åŒã˜å¤±æ•—ã‚’ç„¡é™ã«ç¹°ã‚Šè¿”ã—ã¦è©°ã¾ã‚‹**ğŸ§±ğŸ”
* ã€Œå¤±æ•—ãƒ­ã‚°ã¯å‡ºã¦ã‚‹ã‘ã©ã€ã©ã®ãƒ‡ãƒ¼ã‚¿ãŒåŸå› ï¼Ÿã€
  â†’ **å†ç¾ã§ããªã„**ï¼**ç›´ã—æ–¹ãŒåˆ†ã‹ã‚‰ãªã„**ğŸ¥¹
* ç›´ã™ãŸã‚ã®ææ–™ï¼ˆå…¥åŠ›ãƒ»å›æ•°ãƒ»ä¾‹å¤–ãƒ»æ™‚åˆ»ï¼‰ãŒæ®‹ã£ã¦ãªã„
  â†’ **é‹ç”¨ãŒç¥ˆã‚Šã‚²ãƒ¼**ğŸ™ğŸ’¥

Dead Letterã¯ã€ã“ã†ã„ã†â€œé‹ç”¨ã®æ³£ããƒã‚¤ãƒ³ãƒˆâ€ã‚’æ¸›ã‚‰ã™ãŸã‚ã®å®‰å…¨è£…ç½®ã ã‚ˆğŸ›¡ï¸

---

## 19.3 â€œã©ã®æ™‚ç‚¹ã§éš”é›¢ã™ã‚‹ã‹â€ã®åŸºæœ¬ãƒ«ãƒ¼ãƒ«ğŸ§­ğŸš¦

ãƒã‚¤ãƒ³ãƒˆã¯ã“ã‚ŒğŸ‘‡
**ã€Œä¸€æ™‚çš„ã«ãƒ€ãƒ¡ã€ãªã®ã‹ã€Œæ§‹é€ çš„ã«ãƒ€ãƒ¡ã€ãªã®ã‹ã‚’åˆ†ã‘ã‚‹**ğŸ§ âœ¨

### A) ã ã„ãŸã„ãƒªãƒˆãƒ©ã‚¤ã§ç›´ã‚‹ï¼ˆï¼ä¸€æ™‚çš„ã‚¨ãƒ©ãƒ¼ï¼‰ğŸŒ§ï¸ğŸ”

* ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸€æ™‚ä¸èª¿
* ç›¸æ‰‹ãŒä¸€æ™‚çš„ã«è½ã¡ã¦ã‚‹ï¼ˆ5xxç³»ï¼‰
* ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
* ä¸€æ™‚çš„ãªãƒ­ãƒƒã‚¯ç«¶åˆ

ğŸ‘‰ ã“ã‚Œã¯ç¬¬15ã€œ16ç« ã®ãƒªãƒˆãƒ©ã‚¤ï¼‹ãƒãƒƒã‚¯ã‚ªãƒ•ã§ç²˜ã‚‹ä¾¡å€¤ã‚ã‚Šâ³ğŸ“ˆ

### B) ãƒªãƒˆãƒ©ã‚¤ã—ã¦ã‚‚ç›´ã‚Šã«ãã„ï¼ˆï¼æ’ä¹…ã‚¨ãƒ©ãƒ¼ï¼‰ğŸ§±ğŸ“›

* payloadã®å¿…é ˆé …ç›®ãŒæ¬ ã‘ã¦ã‚‹
* å‹ã‚„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒå£Šã‚Œã¦ã‚‹
* é€ä¿¡å…ˆãŒã€Œãã®å€¤ã¯å—ã‘ä»˜ã‘ãªã„ã€ï¼ˆ4xxç³»ã§å†…å®¹ãŒåŸå› ï¼‰
* ãƒ“ã‚¸ãƒã‚¹çš„ã«ç¦æ­¢çŠ¶æ…‹ï¼ˆä¾‹ï¼šã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿æ³¨æ–‡ã®â€œç™ºé€å®Œäº†â€é€šçŸ¥ï¼‰ğŸš«

ğŸ‘‰ **ã“ã‚Œã¯éš”é›¢ã—ã¦ã€äººãŒç›´ã™**ã®ãŒæ—©ã„ğŸ™‚ğŸ§°

### C) ã‚°ãƒ¬ãƒ¼ï¼ˆæœ€åˆã¯ãƒªãƒˆãƒ©ã‚¤ã€å›æ•°ã§è¦‹åˆ‡ã‚‹ï¼‰ğŸ¤”ğŸ”â¡ï¸ğŸ“®

* åŸå› ä¸æ˜ä¾‹å¤–
* ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¸å…·åˆã£ã½ã„
* ç’°å¢ƒä¾å­˜ã§ãŸã¾ã«ã ã‘è½ã¡ã‚‹

ğŸ‘‰ ã€Œæœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°ã€ã‚„ã€Œæ™‚é–“åˆ¶é™ã€ã‚’è¶…ãˆãŸã‚‰Dead Letterã¸ğŸ“®

---

## 19.4 â€œå®Ÿä¸–ç•Œã®DLQâ€ã£ã¦ã©ã‚“ãªæ„Ÿã˜ï¼Ÿï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ´ã‚‚ã†ï¼‰ğŸ—ºï¸âœ¨

Dead Letterã¯ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«å‘¼ã³æ–¹ã‚„å½¢ãŒé•ã†ã‘ã©ã€ç›®çš„ã¯åŒã˜ã ã‚ˆğŸ™‚

* **Amazon SQS**ï¼š`maxReceiveCount`ã‚’è¶…ãˆã‚‹ã¨ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒDLQã«ç§»å‹•ã™ã‚‹ï¼ˆredrive policyï¼‰ğŸ“¦â¡ï¸ğŸ“® ([AWS ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][1])
* **Google Cloud Pub/Sub**ï¼šæœ€å¤§é…ä¿¡è©¦è¡Œå›æ•°ã«é”ã™ã‚‹ã¨ dead-letter topic ã«è»¢é€ã§ãã‚‹ğŸ“¨â¡ï¸ğŸ—ƒï¸ ([Google Cloud Documentation][2])

  * ã—ã‹ã‚‚ã€Œæœ€å¤§è©¦è¡Œå›æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆã‚„è»¢é€ã€ã¯ **ãƒ™ã‚¹ãƒˆã‚¨ãƒ•ã‚©ãƒ¼ãƒˆ**ã§ã‚ºãƒ¬ã‚‹ã“ã¨ãŒã‚ã‚‹ã€ã£ã¦æ˜è¨˜ã•ã‚Œã¦ã‚‹ã‚ˆâš ï¸ ([Google Cloud][3])
* **Azure Service Bus**ï¼šé…ä¿¡ã§ããªã„ï¼å‡¦ç†ã§ããªã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’DLQã«ä¿æŒã—ã€å–ã‚Šå‡ºã—ã¦æ¤œæŸ»ãƒ»ä¿®æ­£ãƒ»å†æŠ•å…¥ã§ãã‚‹ğŸ“®ğŸ§¾ğŸ”§ ([Microsoft Learn][4])
* **RabbitMQ**ï¼šdead-lettered ã«ãªã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã€æ¡ä»¶ã«ã‚ˆã‚Š exchange ã«å†ç™ºè¡Œã•ã‚Œã‚‹ï¼ˆDLXï¼‰ğŸ“®â¡ï¸ğŸ“¬ ([rabbitmq.com][5])
* **Kafka Connect**ï¼šã‚³ãƒã‚¯ã‚¿è¨­å®šã§DLQç”¨ãƒˆãƒ”ãƒƒã‚¯åã‚’æŒ‡å®šã§ãã‚‹ï¼ˆ`errors.deadletterqueue.topic.name`ï¼‰ğŸ§¾ ([kafka.apache.org][6])

ã“ã®æ•™æã§ã¯ã€**Outboxãƒ‘ã‚¿ãƒ¼ãƒ³ã«åˆã‚ã›ã¦ã€ŒDBã®Dead Letterãƒ†ãƒ¼ãƒ–ãƒ«ã€**ã¨ã—ã¦ä½œã‚‹ã‚ˆğŸ“¦ğŸ—ƒï¸
ï¼ˆå¾Œã§SQS/Kafkaç­‰ã«ç§»æ¤ã—ã¦ã‚‚è€ƒãˆæ–¹ã¯åŒã˜ï¼ï¼‰

---

## 19.5 Outboxã§Dead Letterã‚’ã©ã†è¨­è¨ˆã™ã‚‹ï¼Ÿï¼ˆ2ã¤ã®ä»£è¡¨æ¡ˆï¼‰ğŸ§©ğŸ“¦

### æ¡ˆ1ï¼šOutboxã« `status = dead` ã‚’æŒãŸã›ã‚‹ï¼ˆç°¡å˜ï¼‰âœ…ğŸ™‚

* Outboxãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ `pending / processing / retrying / sent / dead` ã¿ãŸã„ã«å¢—ã‚„ã™
* `dead` ã«ãªã£ãŸè¡Œã¯é€šå¸¸å‡¦ç†ã‹ã‚‰é™¤å¤–

ğŸ‘ ã‚·ãƒ³ãƒ—ãƒ«
ğŸ‘€ ã§ã‚‚ã€Œæ­»ã‚“ã ç†ç”±ã€ã‚„ã€Œæœ€å¾Œã®ä¾‹å¤–ã€ãªã©ã‚’ã—ã£ã‹ã‚Šæ®‹ã™ãªã‚‰ã€åˆ—ãŒå¢—ãˆãŒã¡

### æ¡ˆ2ï¼šDead Letterå°‚ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã¸â€œãŠå¼•ã£è¶Šã—â€ï¼ˆãŠã™ã™ã‚ï¼‰ğŸŒŸğŸ“®â¡ï¸ğŸ—ƒï¸

* Outboxã¯ã€Œé€ã‚‹ãŸã‚ã®ç®±ã€ğŸ“¦
* Dead Letterã¯ã€Œéš”é›¢ä¿ç®¡åº«ã€ğŸ—ƒï¸
* å¤±æ•—ç¢ºå®šã—ãŸã‚‰ã€**Dead Letterãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã‚³ãƒ”ãƒ¼ã—ã¦**ã€Outboxå´ã¯ `dead` ã«ã™ã‚‹ã‹å‰Šé™¤

ğŸ‘ é‹ç”¨ãŒã‚„ã‚Šã‚„ã™ã„ï¼ˆæ¤œç´¢ã—ã‚„ã™ã„ãƒ»å¾©æ—§ã‚‚ã—ã‚„ã™ã„ï¼‰
ğŸ‘ â€œç›´ã›ã‚‹æƒ…å ±â€ã‚’ãŸã£ã·ã‚Šå…¥ã‚Œã‚‰ã‚Œã‚‹ğŸ§¾âœ¨

ã“ã®ç« ã§ã¯ **æ¡ˆ2**ã§é€²ã‚ã‚‹ã‚ˆğŸ˜Š

---

## 19.6 Dead Letterã«â€œçµ¶å¯¾æ®‹ã™ã¹ãæƒ…å ±â€ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆâœ…ğŸ§¾

ã€ŒäººãŒç›´ã›ã‚‹ã€ãŸã‚ã«ã€æœ€ä½ã“ã‚ŒãŒæ¬²ã—ã„ğŸ‘‡

* **å…ƒã®ã‚¤ãƒ™ãƒ³ãƒˆID**ï¼ˆOutboxã®IDï¼‰ğŸ†”
* **eventType**ï¼ˆä½•ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼Ÿï¼‰ğŸ·ï¸
* **payload**ï¼ˆä¸­èº«ï¼‰ğŸ“„
* **å¤±æ•—ç†ç”±ã‚³ãƒ¼ãƒ‰**ï¼ˆåˆ†é¡ï¼‰ğŸ“›

  * ä¾‹ï¼š`VALIDATION_ERROR`, `HTTP_400`, `SCHEMA_MISMATCH`, `UNKNOWN`
* **ä¾‹å¤–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹**ï¼ˆè¿½è·¡ï¼‰ğŸªµ
* **attemptsï¼ˆè©¦è¡Œå›æ•°ï¼‰**ğŸ”
* **firstFailedAt / lastFailedAt**ï¼ˆã„ã¤ã‹ã‚‰è‹¦ã—ã‚“ã§ã‚‹ï¼Ÿï¼‰ğŸ•’
* **æœ€å¾Œã«å‘¼ã‚“ã é€ä¿¡å…ˆ**ï¼ˆã©ã“ã§å¤±æ•—ï¼Ÿï¼‰ğŸ¯
* **correlationId / traceId**ï¼ˆãƒ­ã‚°æ¨ªæ–­ï¼‰ğŸ§µ

ğŸ’¡æ³¨æ„ï¼špayloadã«å€‹äººæƒ…å ±ãŒå…¥ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãªã‚‰ã€**ãƒã‚¹ã‚¯**ã‚„**æš—å·åŒ–**ã‚‚æ¤œè¨ã—ã‚ˆã†ğŸ”ğŸ™‚ï¼ˆç¬¬21ç« ã®è¦³æ¸¬ãƒ»é‹ç”¨ã«ã‚‚é–¢ä¿‚ã—ã¦ãã‚‹ã‚ˆï¼‰

---

## 19.7 DBã‚¹ã‚­ãƒ¼ãƒä¾‹ï¼ˆå­¦ç¿’ç”¨ã®æœ€å°ï¼‹ã¡ã‚‡ã„å®Ÿæˆ¦ï¼‰ğŸ§±ğŸ—ƒï¸

### Outboxï¼ˆä¾‹ï¼‰

```sql
-- outboxï¼ˆé€ã‚‹ãŸã‚ã®ç®±ï¼‰
create table outbox (
  id           text primary key,
  event_type   text not null,
  payload_json text not null,

  status       text not null,         -- pending / processing / retrying / sent / dead
  attempts     integer not null default 0,
  next_retry_at text null,            -- ISOæ–‡å­—åˆ—ã§OKï¼ˆå­¦ç¿’ç”¨ï¼‰
  last_error   text null,

  created_at   text not null,
  updated_at   text not null
);
```

### Dead Letterï¼ˆä¾‹ï¼‰

```sql
-- dead_lettersï¼ˆéš”é›¢ä¿ç®¡åº«ï¼‰
create table dead_letters (
  id               text primary key,     -- dead letterå´ã®IDï¼ˆåˆ¥ã§ã‚‚OKï¼‰
  original_outbox_id text not null,

  event_type       text not null,
  payload_json     text not null,

  reason_code      text not null,         -- VALIDATION_ERROR ãªã©
  error_message    text not null,
  error_stack      text null,

  attempts         integer not null,
  first_failed_at  text not null,
  last_failed_at   text not null,

  destination      text null,             -- ä¾‹: "webhook:billing"
  created_at       text not null
);

create index idx_dead_letters_original on dead_letters(original_outbox_id);
create index idx_dead_letters_event_type on dead_letters(event_type);
create index idx_dead_letters_created_at on dead_letters(created_at);
```

---

## 19.8 å®Ÿè£…ï¼šå¤±æ•—ã‚’â€œDead Letterã¸é€ã‚‹â€å‡¦ç†ãƒ•ãƒ­ãƒ¼ğŸ“¤ğŸ’¥â¡ï¸ğŸ“®

ã“ã“ãŒã“ã®ç« ã®ãƒ¡ã‚¤ãƒ³ã ã‚ˆâœ¨
Publisherï¼ˆé€ä¿¡ä¿‚ï¼‰ãŒ1ä»¶å‡¦ç†ã™ã‚‹ã¨ãã®æµã‚ŒğŸ‘‡

1. Outboxã‚’1ä»¶æ‹¾ã†ï¼ˆãƒ­ãƒƒã‚¯ã¯ç¬¬14ç« ã®ã‚„ã‚Šæ–¹ï¼‰ğŸ”’
2. é€ä¿¡ã™ã‚‹ğŸ“¤
3. å¤±æ•—ã—ãŸã‚‰ã€ã‚¨ãƒ©ãƒ¼ã‚’åˆ†é¡ã™ã‚‹ğŸ§ 
4. ãƒªãƒˆãƒ©ã‚¤å¯¾è±¡ãªã‚‰ `attempts++` ã¨ `nextRetryAt` ã‚’æ›´æ–°ã—ã¦æˆ»ã™ğŸ”
5. **æ’ä¹…ã‚¨ãƒ©ãƒ¼ or è¦‹åˆ‡ã‚Šå›æ•°è¶…ãˆ**ãªã‚‰ã€Dead Letterã¸éš”é›¢ğŸ“®ğŸ—ƒï¸

---

## 19.9 TypeScriptå®Ÿè£…ä¾‹ï¼ˆé‡è¦éƒ¨åˆ†ã ã‘ã‚®ãƒ¥ãƒƒï¼‰ğŸ› ï¸âœ¨

### 19.9.1 å‹ï¼ˆOutbox / DeadLetterï¼‰

```ts
type OutboxStatus = "pending" | "processing" | "retrying" | "sent" | "dead";

type OutboxRecord = {
  id: string;
  eventType: string;
  payloadJson: string;

  status: OutboxStatus;
  attempts: number;
  nextRetryAt: string | null;
  lastError: string | null;

  createdAt: string;
  updatedAt: string;
};

type DeadLetterRecord = {
  id: string;
  originalOutboxId: string;

  eventType: string;
  payloadJson: string;

  reasonCode: string;
  errorMessage: string;
  errorStack: string | null;

  attempts: number;
  firstFailedAt: string;
  lastFailedAt: string;

  destination: string | null;
  createdAt: string;
};
```

### 19.9.2 ã‚¨ãƒ©ãƒ¼åˆ†é¡ï¼ˆè¶…ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰ğŸ“›ğŸ§ 

```ts
type ErrorClass = {
  isRetryable: boolean;
  reasonCode: string;
};

function classifyError(e: unknown): ErrorClass {
  // å­¦ç¿’ç”¨ã«ã‚·ãƒ³ãƒ—ãƒ«ï¼å¿…è¦ãªã‚‰å¢—ã‚„ã—ã¦OKğŸ™‚
  if (e instanceof Error) {
    const msg = e.message.toLowerCase();

    // ä¾‹: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç³»ã¯æ’ä¹…ã‚¨ãƒ©ãƒ¼å¯„ã‚Š
    if (msg.includes("validation") || msg.includes("invalid payload")) {
      return { isRetryable: false, reasonCode: "VALIDATION_ERROR" };
    }

    // ä¾‹: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¯ãƒªãƒˆãƒ©ã‚¤å¯„ã‚Š
    if (msg.includes("timeout") || msg.includes("econnreset") || msg.includes("network")) {
      return { isRetryable: true, reasonCode: "TRANSIENT_NETWORK" };
    }

    // ã‚ˆãåˆ†ã‹ã‚‰ãªã„ã®ã¯æœ€åˆãƒªãƒˆãƒ©ã‚¤ã€å›æ•°ã§è¦‹åˆ‡ã‚‹ä½œæˆ¦
    return { isRetryable: true, reasonCode: "UNKNOWN" };
  }

  return { isRetryable: true, reasonCode: "UNKNOWN_NON_ERROR_THROWN" };
}
```

### 19.9.3 Dead Letterã¸éš”é›¢ï¼ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§å®‰å…¨ã«ï¼‰ğŸ”ğŸ“®

ã€ŒOutboxã‚’deadã«ã™ã‚‹ã€ã¨ã€ŒDeadLetterã«ä¿å­˜ã™ã‚‹ã€ã‚’**åŒæ™‚ã«æˆåŠŸ**ã•ã›ãŸã„ã‚ˆã­ğŸ™‚
ã ã‹ã‚‰ DBãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§ã¾ã¨ã‚ã‚‹âœ¨ï¼ˆç¬¬11ç« ã®å¾©ç¿’ï¼ï¼‰

```ts
type DbTx = {
  outbox: {
    markDead: (id: string, lastError: string) => Promise<void>;
    markRetrying: (id: string, attempts: number, nextRetryAt: string, lastError: string) => Promise<void>;
    markSent: (id: string) => Promise<void>;
  };
  deadLetters: {
    insert: (r: DeadLetterRecord) => Promise<void>;
  };
};

type Db = {
  transaction: <T>(fn: (tx: DbTx) => Promise<T>) => Promise<T>;
};

function nowIso(): string {
  return new Date().toISOString();
}

function addSeconds(iso: string, sec: number): string {
  return new Date(new Date(iso).getTime() + sec * 1000).toISOString();
}

function newId(): string {
  return crypto.randomUUID();
}

async function moveToDeadLetter(db: Db, o: OutboxRecord, e: Error, reasonCode: string, destination: string | null) {
  const ts = nowIso();

  const dead: DeadLetterRecord = {
    id: newId(),
    originalOutboxId: o.id,
    eventType: o.eventType,
    payloadJson: o.payloadJson,

    reasonCode,
    errorMessage: e.message,
    errorStack: e.stack ?? null,

    attempts: o.attempts,
    firstFailedAt: o.createdAt,     // å­¦ç¿’ç”¨ï¼šåˆå›å¤±æ•—æ™‚åˆ»ã‚’åˆ¥ç®¡ç†ã—ã¦ã‚‚OK
    lastFailedAt: ts,

    destination,
    createdAt: ts,
  };

  await db.transaction(async (tx) => {
    await tx.deadLetters.insert(dead);
    await tx.outbox.markDead(o.id, `${reasonCode}: ${e.message}`);
  });
}
```

### 19.9.4 Publisherã®å‡¦ç†ï¼ˆãƒªãƒˆãƒ©ã‚¤ or Dead Letterï¼‰ğŸ“¤ğŸ”ğŸ“®

```ts
const MAX_ATTEMPTS = 8;

async function handleOutboxOne(db: Db, o: OutboxRecord, destination: string | null) {
  try {
    // é€ä¿¡ï¼ˆã“ã“ã¯ç¬¬13ç« ã®â€œç–‘ä¼¼é€ä¿¡â€ã§ã‚‚OKğŸ™‚ï¼‰
    await sendIntegrationEvent(o.eventType, o.payloadJson);

    await db.transaction(async (tx) => {
      await tx.outbox.markSent(o.id);
    });

  } catch (err) {
    const e = err instanceof Error ? err : new Error("Unknown error");
    const cls = classifyError(e);
    const ts = nowIso();

    const nextAttempts = o.attempts + 1;
    const lastError = `${cls.reasonCode}: ${e.message}`;

    // æ’ä¹…ã‚¨ãƒ©ãƒ¼ â†’ å³Dead Letter
    if (!cls.isRetryable) {
      await moveToDeadLetter(db, { ...o, attempts: nextAttempts }, e, cls.reasonCode, destination);
      return;
    }

    // ãƒªãƒˆãƒ©ã‚¤å›æ•°è¶…ãˆ â†’ Dead Letter
    if (nextAttempts >= MAX_ATTEMPTS) {
      await moveToDeadLetter(db, { ...o, attempts: nextAttempts }, e, "RETRY_EXHAUSTED", destination);
      return;
    }

    // ãƒªãƒˆãƒ©ã‚¤ã¸ï¼ˆãƒãƒƒã‚¯ã‚ªãƒ•ã¯ç¬¬16ç« ã§å¼·åŒ–ï¼ï¼‰
    const nextRetryAt = addSeconds(ts, 30 * nextAttempts);

    await db.transaction(async (tx) => {
      await tx.outbox.markRetrying(o.id, nextAttempts, nextRetryAt, lastError);
    });
  }
}

async function sendIntegrationEvent(eventType: string, payloadJson: string): Promise<void> {
  // å­¦ç¿’ç”¨ï¼šã¾ãšã¯ç–‘ä¼¼é€ä¿¡ã§OKï¼
  // æœ¬ç•ªã¯HTTPã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã¸
  if (eventType === "OrderCreated" && payloadJson.length < 10) {
    throw new Error("validation: invalid payload");
  }
}
```

---

## 19.10 â€œéš”é›¢ã—ãŸå¾Œâ€ãŒæœ¬ç•ªï¼ˆå¾©æ—§ãƒ•ãƒ­ãƒ¼è¨­è¨ˆï¼‰ğŸ§°ğŸ™‚

Dead Letterã¯ã€Œå…¥ã‚ŒãŸã‚‰çµ‚ã‚ã‚Šã€ã˜ã‚ƒãªã„ã‚ˆğŸ“®â¡ï¸ğŸ› ï¸
**æ•‘å‡ºã®é“**ã‚’ä½œã£ã¦åˆã‚ã¦å®Œæˆâœ¨

### ã‚ˆãã‚ã‚‹æ•‘å‡ºãƒ•ãƒ­ãƒ¼3ãƒ‘ã‚¿ãƒ¼ãƒ³

1. **åŸå› ä¿®æ­£ â†’ å†æŠ•å…¥ï¼ˆrequeueï¼‰**ğŸ”

* payloadã‚’ç›´ã™ï¼ˆä¸è¶³é …ç›®ã‚’è£œã†ç­‰ï¼‰
* Outboxã¸æˆ»ã™ï¼ˆæ–°IDã§ã‚‚åŒIDã§ã‚‚æ–¹é‡æ¬¡ç¬¬ï¼‰

2. **åŸå› ä¿®æ­£ â†’ æ‰‹å‹•ã§1å›ã ã‘é€ã‚‹**ğŸ“¤

* ãã®å ´ã§é€ã£ã¦ã€DeadLetterã«ã€Œå¯¾å¿œæ¸ˆã¿ã€ãƒ¡ãƒ¢ã‚’æ®‹ã™

3. **ç ´æ£„ï¼ˆãŸã ã—è¨¼è·¡ã¯æ®‹ã™ï¼‰ğŸ—‘ï¸ğŸ§¾**

* æ˜ã‚‰ã‹ã«ä¸è¦ãªãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ†ã‚¹ãƒˆã‚´ãƒŸç­‰ï¼‰

### â€œå†æŠ•å…¥â€ã™ã‚‹ã¨ãã®æ³¨æ„ï¼ˆå†ªç­‰æ€§ã¨ã‚»ãƒƒãƒˆï¼ï¼‰ğŸ›¡ï¸ğŸ”‘

* **åŒã˜ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚‚ã†ä¸€å›é€ã‚‹**ã“ã¨ã«ãªã‚‹ã‹ã‚‚
* ã ã‹ã‚‰ç¬¬17ç« ã®å†ªç­‰æ€§ï¼ˆidempotency keyï¼‰ãŒåŠ¹ã„ã¦ãã‚‹ğŸ’ªğŸ™‚
* Dead Letterã‹ã‚‰æˆ»ã™ã¨ãã¯ã€

  * ã€ŒåŒã˜ `eventId` ã§é€ã‚‹ã€ã‹
  * ã€Œæ–°ã—ã„ `eventId` ã§é€ã‚‹ã€ã‹
    ã‚’æ±ºã‚ã¦ãŠã“ã†ï¼ˆè¨­è¨ˆåˆ¤æ–­ãƒã‚¤ãƒ³ãƒˆï¼‰ğŸ§ 

---

## 19.11 é‹ç”¨ã§æ³£ã‹ãªã„ãŸã‚ã®â€œè¦‹ãˆã‚‹åŒ–â€ãƒŸãƒ‹è¨­è¨ˆğŸ‘€ğŸ“Š

æœ€ä½é™ã“ã‚Œã‚’å‡ºã™ã¨ã€é‹ç”¨ãŒä¸€æ°—ã«æ¥½ã«ãªã‚‹ã‚ˆğŸ™‚ğŸ«¶

* Dead Letterä»¶æ•°ï¼ˆç·æ•°ãƒ»æ—¥æ¬¡ï¼‰ğŸ“ˆ
* reasonCodeåˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆä½•ãŒå¤šã„ï¼Ÿï¼‰ğŸ·ï¸
* eventTypeåˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆã©ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå¼±ã„ï¼Ÿï¼‰ğŸ“¦
* ã€Œåˆå›å¤±æ•—ã‹ã‚‰ä½•æ—¥æ”¾ç½®ï¼Ÿã€ï¼ˆå¤ã„é †ï¼‰ğŸ•°ï¸
* ã€Œå†æŠ•å…¥ã—ã¦æˆåŠŸã—ãŸç‡ã€ğŸ”âœ…

ç¬¬21ç« ã®è¦³æ¸¬ï¼ˆãƒ­ã‚°ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼‰ã§ã€ã“ã“ã‚’ã¡ã‚ƒã‚“ã¨å½¢ã«ã™ã‚‹ã‚ˆğŸ”âœ¨

---

## 19.12 æ¼”ç¿’ï¼ˆæ‰‹ã‚’å‹•ã‹ã™ãƒ‘ãƒ¼ãƒˆï¼‰ğŸ“ğŸ§ª

### æ¼”ç¿’1ï¼šæ¯’å…¥ã‚Špayloadã‚’ä½œã£ã¦Dead Letterã¸é€ã‚ã†ğŸ§ªğŸ“®

* `payloadJson.length < 10` ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã‚ˆã†ã«ã—ãŸã‚ˆã­ğŸ™‚
* ãã®æ¡ä»¶ã§Outboxã‚’ä½œã£ã¦ã€Publisherã‚’å›ã—ã¦ã¿ã‚ˆã†
* `dead_letters` ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå…¥ã‚‹ã®ã‚’ç¢ºèªâœ…

### æ¼”ç¿’2ï¼šreasonCodeã‚’3ç¨®é¡ã«å¢—ã‚„ãã†ğŸ·ï¸âœ¨

* `VALIDATION_ERROR`
* `TRANSIENT_NETWORK`
* `RETRY_EXHAUSTED`

â€œåˆ†é¡ã§ãã‚‹â€ã ã‘ã§é‹ç”¨ãŒè¶…ãƒ©ã‚¯ã«ãªã‚‹ã‚ˆğŸ™‚ğŸ‘

### æ¼”ç¿’3ï¼šå†æŠ•å…¥ï¼ˆrequeueï¼‰ç”¨ã®é–¢æ•°ã‚’ä½œã‚ã†ğŸ”ğŸ› ï¸

* DeadLetterã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’é¸ã¶
* payloadã‚’ç›´ã—ãŸä½“ã§ï¼ˆæ‰‹å‹•ã§æ–‡å­—åˆ—ã‚’å·®ã—æ›¿ãˆï¼‰
* Outboxã«æˆ»ã™ï¼ˆinsertï¼‰
* DeadLetterå´ã«ã€ŒrequeuedAtã€ã‚’æ®‹ã™ï¼ˆåˆ—è¿½åŠ ã§ã‚‚OKï¼‰

---

## 19.13 AIæ´»ç”¨ãƒŸãƒ‹å‹ï¼ˆã“ã®ç« å‘ã‘ï¼‰ğŸ¤–âœ¨

ãã®ã¾ã¾ã‚³ãƒ”ãƒšã§ä½¿ãˆã‚‹ã‚„ã¤ğŸ‘‡

* **ã‚¨ãƒ©ãƒ¼åˆ†é¡ç›¸è«‡**ğŸ“›
  ã€ŒOutbox Publisherã§èµ·ãã‚‹ã‚¨ãƒ©ãƒ¼ã‚’â€œãƒªãƒˆãƒ©ã‚¤å¯/ä¸å¯â€ã«åˆ†é¡ã—ã¦ã€reasonCodeæ¡ˆã‚’10å€‹å‡ºã—ã¦ã€‚å„reasonCodeã®åˆ¤æ–­åŸºæº–ã‚‚æ·»ãˆã¦ã€
* **DeadLetterãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆãƒ¬ãƒ“ãƒ¥ãƒ¼**ğŸ§¾
  ã€Œã“ã®dead_lettersãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¸è¶³ã—ã¦ã‚‹â€œç›´ã›ã‚‹æƒ…å ±â€ã‚’æŒ‡æ‘˜ã—ã¦ã€‚å€‹äººæƒ…å ±ãŒæ··ã–ã‚‹å ´åˆã®å¯¾ç­–ã‚‚ææ¡ˆã—ã¦ã€
* **å¾©æ—§æ‰‹é †ï¼ˆRunbookï¼‰ä½œæˆ**ğŸ› ï¸
  ã€ŒDead LetterãŒå¢—ãˆãŸæ™‚ã®é‹ç”¨æ‰‹é †ã‚’ã€ä¸€æ¬¡å¯¾å¿œâ†’åŸå› èª¿æŸ»â†’ä¿®æ­£â†’å†æŠ•å…¥â†’å†ç™ºé˜²æ­¢ã®æµã‚Œã§ç®‡æ¡æ›¸ãã«ã—ã¦ã€

---

## 19.14 ã¾ã¨ã‚ï¼ˆã“ã®ç« ã§èº«ã«ã¤ãã“ã¨ï¼‰ğŸâœ¨

* **â€œä½•å›ã‚„ã£ã¦ã‚‚ç„¡ç†â€ã‚’éš”é›¢ã™ã‚‹åˆ¤æ–­**ãŒã§ãã‚‹ğŸ™‚ğŸ“®
* Dead Letterã« **ç›´ã›ã‚‹æƒ…å ±ã‚’æ®‹ã™è¨­è¨ˆ**ãŒã§ãã‚‹ğŸ§¾âœ…
* Outbox Publisherã§ **ãƒªãƒˆãƒ©ã‚¤ã¨Dead Letterã‚’åˆ†å²**ã§ãã‚‹ğŸ”â¡ï¸ğŸ“®
* å†ªç­‰æ€§ãƒ»è¦³æ¸¬ã¨ã¤ãªãŒã‚‹â€œå®Ÿé‹ç”¨ã®å…¥å£â€ã«ç«‹ã¦ã‚‹ğŸ›¡ï¸ğŸ”

[1]: https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-dead-letter-queues.html?utm_source=chatgpt.com "Using dead-letter queues in Amazon SQS"
[2]: https://docs.cloud.google.com/pubsub/docs/dead-letter-topics?utm_source=chatgpt.com "Dead-letter topics | Pub/Sub"
[3]: https://cloud.google.com/pubsub/docs/handling-failures?hl=ja&utm_source=chatgpt.com "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†"
[4]: https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-dead-letter-queues?utm_source=chatgpt.com "Service Bus dead-letter queues - Azure"
[5]: https://www.rabbitmq.com/docs/dlx?utm_source=chatgpt.com "Dead Letter Exchanges"
[6]: https://kafka.apache.org/23/configuration/kafka-connect-configs/?utm_source=chatgpt.com "Kafka Connect Configs"
