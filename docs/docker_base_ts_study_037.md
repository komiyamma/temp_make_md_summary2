# ç¬¬37ç« ï¼šä¾å­˜é–¢ä¿‚ï¼ˆèµ·å‹•é †ï¼‰ã‚’ã–ã£ãã‚Šæ‰±ã†â³

ã“ã®ç« ã¯ã€ŒDBâ†’APIã®é †ã§èµ·å‹•ã—ãŸã¯ãšãªã®ã«ã€APIãŒã‚³ã‚±ã‚‹ğŸ˜µã€ã¿ãŸã„ãª **â€œé †ç•ªå•é¡Œâ€** ã‚’å’æ¥­ã™ã‚‹å›ã ã‚ˆã€œï¼ğŸ“âœ¨
ãƒã‚¤ãƒ³ãƒˆã¯ã“ã‚ŒğŸ‘‡

* **ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ãŸ** â‰  **ä¸­ã®ã‚¢ãƒ—ãƒªãŒåˆ©ç”¨å¯èƒ½ï¼ˆæº–å‚™å®Œäº†ï¼‰** ğŸ™…â€â™‚ï¸
* ã ã‹ã‚‰ã€Œé †ç•ªã€ã ã‘ã˜ã‚ƒãªãã¦ã€Œæº–å‚™å®Œäº†ã¾ã§å¾…ã¤ã€ã‚‚å¿…è¦ã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹â±ï¸

---

## 1) ã¾ãšå¤§äº‹ï¼šèµ·å‹•é †ã§èµ·ãã‚‹â€œã‚ã‚‹ã‚ã‚‹äº‹æ•…â€ğŸª¤ğŸ˜‡

å…¸å‹ãƒ‘ã‚¿ãƒ¼ãƒ³ğŸ‘‡

1. `db`ï¼ˆPostgreSQLï¼‰ãŒç«‹ã¡ä¸ŠãŒã‚‹ğŸ˜
2. ã§ã‚‚å†…éƒ¨åˆæœŸåŒ–ä¸­ã§ã€ã¾ã æ¥ç¶šå—ä»˜ã§ããªã„ğŸ˜´
3. `api` ãŒå…ˆã«DBã¸æ¥ç¶šã—ã‚ˆã†ã¨ã—ã¦å¤±æ•—ğŸ’¥
4. APIãŒçµ‚äº† â†’ ãã®ã¾ã¾è½ã¡ã‚‹ / å†èµ·å‹•ãƒ«ãƒ¼ãƒ—ğŸ”ğŸ˜µâ€ğŸ’«

Composeã® `depends_on` ã¯ **â€œèµ·å‹•é †â€ã¯é¢å€’è¦‹ã¦ãã‚Œã‚‹** ã‘ã©ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ **â€œæº–å‚™å®Œäº†â€ã¾ã§ã¯å¾…ãŸãªã„** ã‚“ã ã€‚([Docker Documentation][1])

---

## 2) è§£æ±ºã¯ã€Œ3ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€æ§‹ãˆãŒæœ€å¼·ğŸ’ªğŸ˜„

### ãƒ¬ã‚¤ãƒ¤ãƒ¼Aï¼šã¨ã‚Šã‚ãˆãšèµ·å‹•é †ã‚’å›ºå®šï¼ˆæœ€ä½é™ï¼‰ğŸ§±

* `depends_on` ã‚’æ›¸ãã¨ã€**ä¾å­˜é–¢ä¿‚ã®é †ã«ä½œæˆãƒ»èµ·å‹•/åœæ­¢** ã—ã¦ãã‚Œã‚‹ğŸ‘([Docker Documentation][1])
* ãŸã ã—ã€Œå‹•ã„ã¦ã‚‹ï¼ˆrunningï¼‰ã€ã¾ã§ã§ã€ã€Œä½¿ãˆã‚‹ï¼ˆreadyï¼‰ã€ã¯åˆ¥å•é¡ŒğŸ™ƒ([Docker Documentation][1])

### ãƒ¬ã‚¤ãƒ¤ãƒ¼Bï¼šæº–å‚™å®Œäº†ã¾ã§å¾…ã¤ï¼ˆã“ã“ãŒæœ¬å‘½ï¼‰ğŸ©ºâœ…

Composeã¯ `depends_on` ã® **é•·ã„æ›¸ãæ–¹** ã§ã€ä¾å­˜ã®æ¡ä»¶ã‚’æŒ‡å®šã§ãã‚‹ã‚ˆğŸ‘‡([Docker Documentation][1])

* `service_started`ï¼šèµ·å‹•ã—ãŸã‚‰OKï¼ˆ=çŸ­ã„æ›¸ãæ–¹ç›¸å½“ï¼‰
* `service_healthy`ï¼š**healthcheckãŒé€šã£ãŸã‚‰OK**ï¼ˆ=æº–å‚™å®Œäº†å¾…ã¡ï¼‰ğŸŸ¢
* `service_completed_successfully`ï¼šä¸€ç™ºå‡¦ç†ãŒæˆåŠŸã—ã¦çµ‚ã‚ã£ãŸã‚‰OKï¼ˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç­‰ï¼‰ğŸ([Docker Documentation][1])

### ãƒ¬ã‚¤ãƒ¤ãƒ¼Cï¼šã‚¢ãƒ—ãƒªå´ã‚‚â€œæ¥ç¶šãƒªãƒˆãƒ©ã‚¤â€ã‚’æŒã¤ï¼ˆç¾å ´åŠ›ï¼‰ğŸ”ğŸ§ 

DBã¯èµ·å‹•æ™‚ã ã‘ã˜ã‚ƒãªãã€å†èµ·å‹•ãƒ»ä¸€ç¬ã®åˆ‡æ–­ã‚‚ã‚ã‚Šå¾—ã‚‹ğŸ˜…
ãªã®ã§ **ã€Œæœ€åˆã®æ¥ç¶šãŒå¤±æ•—ã—ã¦ã‚‚æ•°å›ãƒªãƒˆãƒ©ã‚¤ã™ã‚‹ã€** ã‚’å…¥ã‚Œã¦ãŠãã¨å¼·ã„ğŸ’ª
ï¼ˆã“ã®æ•™æã§ã¯â€œæœ€å°ã§OKâ€ã®æ–¹é‡ã§ã„ãã‚ˆï¼ï¼‰

---

## 3) ãƒãƒ³ã‚ºã‚ªãƒ³ï¼šDBå¾…ã¡å•é¡Œã‚’ã€Œã‚ã–ã¨ã€è¸ã‚“ã§ç›´ã™ğŸ˜ˆâ¡ï¸ğŸ˜‡

ã“ã“ã§ã¯ **Todo APIï¼ˆapiï¼‰ï¼‹Postgresï¼ˆdbï¼‰** ã‚’æƒ³å®šã™ã‚‹ã‚ˆğŸ§©
ï¼ˆPostgreSQLã¯ç¾è¡Œç³»ã¨ã—ã¦ `postgres:18` ã‚’ä¾‹ã«ã™ã‚‹ã­ğŸ˜âœ¨ï¼‰([postgresql.org][2])

---

### 3-1. ã¾ãšã¯ã€Œå¤±æ•—ã™ã‚‹ã€æ§‹æˆï¼ˆç—‡çŠ¶ã‚’è¦³å¯ŸğŸ‘€ï¼‰

`depends_on` ãŒç„¡ã„ or healthcheckç„¡ã—ã ã¨ã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ¬¡ç¬¬ã§APIãŒå…ˆã«DBã¸è¡Œã£ã¦ã‚³ã‚±ã‚‹ã“ã¨ãŒã‚ã‚‹ğŸ˜µ

---

### 3-2. ç›´ã™ï¼šhealthcheck + service_healthy ã‚’å…¥ã‚Œã‚‹âœ…

ä»¥ä¸‹ã¯ â€œæœ€å°ã§åŠ¹ãâ€ ä¾‹ã ã‚ˆï¼ˆè¶…ã‚ˆãä½¿ã†å½¢ï¼‰ğŸ‘‡

```yaml
services:
  db:
    image: postgres:18
    environment:
      POSTGRES_USER: todo
      POSTGRES_PASSWORD: todo
      POSTGRES_DB: todo
    volumes:
      - todo-db:/var/lib/postgresql/data
    healthcheck:
      # Postgreså…¬å¼ã‚¤ãƒ¡ãƒ¼ã‚¸ã«å…¥ã£ã¦ã‚‹ pg_isready ã‚’ä½¿ã†ã®ãŒå®šç•ª ğŸ‘
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  api:
    build: ./api
    environment:
      # ä¾‹ï¼šã‚ãªãŸã®APIå´ã®èª­ã¿æ–¹ã«åˆã‚ã›ã¦ã­ï¼ˆDATABASE_URLã§ã‚‚OKï¼‰
      DB_HOST: db
      DB_PORT: "5432"
      DB_USER: todo
      DB_PASSWORD: todo
      DB_NAME: todo
    depends_on:
      db:
        condition: service_healthy
        restart: true

volumes:
  todo-db:
```

ã“ã“ã§èµ·ãã‚‹ã“ã¨ğŸ‘‡

* Composeã¯ `db` ã‚’å…ˆã«ä½œã£ã¦èµ·å‹•ã™ã‚‹ğŸ˜
* `db` ã« **healthcheckãŒé€šã‚‹ã¾ã§å¾…ã¤**ï¼ˆ=æº–å‚™å®Œäº†å¾…ã¡ï¼‰âœ…([Docker Documentation][1])
* ãã®å¾Œã§ `api` ã‚’èµ·å‹•ã™ã‚‹ğŸš€
* ã•ã‚‰ã« `restart: true` ã‚’ä»˜ã‘ã‚‹ã¨ã€`docker compose restart db` ã¿ãŸã„ã« **Composeæ“ä½œã§dbã‚’å†èµ·å‹•ã—ãŸæ™‚ã«apiã‚‚å†èµ·å‹•** ã•ã‚Œã‚„ã™ããªã‚‹ï¼ˆå†æ¥ç¶šã—ã‚„ã™ããªã‚‹ï¼‰ğŸ”([Docker Documentation][1])

> ğŸ§ è±†çŸ¥è­˜ï¼š`$${POSTGRES_USER}` ã¿ãŸã„ã« `$` ã‚’2å€‹ã«ã—ã¦ã‚‹ã®ã¯ã€Composeã®å¤‰æ•°å±•é–‹ã¨è¡çªã—ãªã„ãŸã‚ã®â€œã‚¨ã‚¹ã‚±ãƒ¼ãƒ—â€ã ã‚ˆğŸ˜ºï¼ˆã“ã“ã€åˆå¿ƒè€…ãŒãƒãƒã‚Šã‚„ã™ã„ï¼ï¼‰

---

### 3-3. å‹•ã‹ã—ã¦ç¢ºèªã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ğŸ§ª

```bash
docker compose up --build
```

ãƒ­ã‚°ã‚’è¦‹ã¦ã€ŒdbãŒhealthyã«ãªã£ã¦ã‹ã‚‰apiãŒèµ·å‹•ã€ã£ã½ã„æµã‚Œã«ãªã£ã¦ã‚Œã°OKğŸ‘

åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ğŸ‘‡

```bash
docker compose ps
docker compose logs -f db
docker compose logs -f api
```

ç‰‡ä»˜ã‘ğŸ‘‡ï¼ˆDBãƒ‡ãƒ¼ã‚¿ã‚‚æ¶ˆã™ãªã‚‰ `-v`ï¼‰ğŸ§¹

```bash
docker compose down -v
```

---

## 4) â€œå¾…ã¦ã‚‹Composeâ€ã«ã™ã‚‹å°ãƒ¯ã‚¶ï¼š`up --wait` â±ï¸âœ¨

ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚„CIã§ã€Œèµ·å‹•ã—ãŸã‚‰æ¬¡ã®å‡¦ç†ã¸é€²ã¿ãŸã„ã€æ™‚ã«ä¾¿åˆ©ãªã®ãŒã“ã‚ŒğŸ‘‡

```bash
docker compose up -d --wait --wait-timeout 60
```

* `--wait`ï¼šã‚µãƒ¼ãƒ“ã‚¹ãŒ **running/healthy ã«ãªã‚‹ã¾ã§å¾…ã¤**ï¼ˆdetachæ‰±ã„ã«ãªã‚‹ï¼‰([Docker Documentation][3])
* `--wait-timeout`ï¼šå¾…ã¡æ™‚é–“ã«ä¸Šé™ã‚’ä»˜ã‘ã‚‹ï¼ˆãƒãƒ³ã‚°é˜²æ­¢ï¼‰([Docker Documentation][3])

> âœ… healthcheckãŒç„¡ã„ã¨ã€Œhealthyã€åˆ¤å®šã§ããªã„ã®ã§ã€çµå±€ healthcheck è¨­è¨ˆãŒå¤§äº‹ã ã‚ˆã€œï¼

---

## 5) ã‚ˆãã‚ã‚‹ç½ ã¾ã¨ã‚ï¼ˆã“ã“ã ã‘èª­ã‚“ã§ã‚‚å¼·ããªã‚‹ğŸ›¡ï¸ğŸ˜„ï¼‰

* `depends_on` ã ã‘ã ã¨ **â€œreadyå¾…ã¡â€ã¯ã§ããªã„**ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã€Œå‹•ã„ãŸã‚‰OKã€ï¼‰ğŸ˜‡([Docker Documentation][1])
* `service_healthy` ã‚’ä½¿ã†ãªã‚‰ **healthcheckå¿…é ˆ** âœ…([Docker Documentation][1])
* `restart: true`ï¼ˆdepends_onå†…ï¼‰ã¨ã€ã‚µãƒ¼ãƒ“ã‚¹ç›´ä¸‹ã® `restart: always` ã¯åˆ¥ç‰©ã ã‚ˆâš ï¸

  * å‰è€…ï¼šComposeæ“ä½œã«é€£å‹•ã—ã¦ä¾å­˜å´ã‚’å†èµ·å‹•ã—ã‚„ã™ãã™ã‚‹ğŸ§©([Docker Documentation][1])
* ã‚‚ã— `condition` ã‚’æ›¸ã„ãŸã‚‰æ€’ã‚‰ã‚Œã‚‹ï¼ˆYAMLãŒç„¡åŠ¹ã£ã¦è¨€ã‚ã‚Œã‚‹ï¼‰å ´åˆã€å¤ã„ `docker-compose` ã‚’è¸ã‚“ã§ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ğŸ˜µ

  * `docker compose version` ã§ç¢ºèªã—ã¦ã€ã§ãã‚Œã° `docker compose`ï¼ˆV2ï¼‰ã«å¯„ã›ã‚ˆã†ğŸ‘

---

## 6) AIæ´»ç”¨ï¼ˆã‚³ãƒ”ãƒšã§ä½¿ãˆã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé›†ğŸ¤–âœ¨ï¼‰

* ã€Œã“ã® compose.yml ã® db ã«ã€**Postgreså‘ã‘ã®healthcheck** ã‚’å…¥ã‚Œã¦ã€‚`depends_on: service_healthy` ã§ api ã‚’å¾…ãŸã›ãŸã„ã€‚åˆå¿ƒè€…å‘ã‘ã«çŸ­ãèª¬æ˜ã‚‚ã¤ã‘ã¦ã€
* ã€ŒNode/TypeScript ã§ã€DBæ¥ç¶šã‚’ **æœ€å¤§10å›ãƒªãƒˆãƒ©ã‚¤**ï¼ˆæŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰ã™ã‚‹æœ€å°ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã€‚ãƒ­ã‚°ã‚‚åˆ†ã‹ã‚Šã‚„ã™ãã€
* ã€Œâ€œèµ·å‹•ã—ãŸâ‰ æº–å‚™å®Œäº†â€ ã‚’ã€æ–‡ç³»å¤§å­¦ç”Ÿå‘ã‘ã®ä¾‹ãˆè©±ã§3ã¤ä½œã£ã¦ğŸ˜‚ã€

---

## 7) ãƒŸãƒ‹æ¼”ç¿’ï¼ˆ3åˆ†ã§OKï¼‰â²ï¸ğŸ“

1. `depends_on` ã ã‘ã®çŠ¶æ…‹ã§ä¸€åº¦ `up` ã—ã¦ã€ãƒ­ã‚°ã«å¤±æ•—ãŒå‡ºã‚‹ã‹è¦³å¯ŸğŸ‘€
2. `healthcheck + service_healthy` ã‚’å…¥ã‚Œã¦ã€å†åº¦ `up` ã—ã¦æ”¹å–„ã‚’ç¢ºèªâœ…
3. `up -d --wait --wait-timeout 60` ã‚’è©¦ã—ã¦ã€Œå¾…ã¦ã¦ã‚‹ã€ä½“é¨“ã‚’ã™ã‚‹â³([Docker Documentation][3])

---

## ã¾ã¨ã‚ğŸ‰

* **èµ·å‹•é †**ã¯ `depends_on` ğŸ§±
* **æº–å‚™å®Œäº†å¾…ã¡**ã¯ `healthcheck` + `condition: service_healthy` ğŸ©ºâœ…([Docker Documentation][1])
* ã‚¹ã‚¯ãƒªãƒ—ãƒˆé‹ç”¨ãªã‚‰ `up -d --wait` ãŒä¾¿åˆ©â±ï¸([Docker Documentation][3])

æ¬¡ã®ç« ï¼ˆç¬¬38ç« ï¼‰ã¯ã€ã“ã®è¾ºã‚’è¸ã¾ãˆã¦ã€Œèµ·å‹•/åœæ­¢/ãƒ­ã‚°/åˆæœŸåŒ–ã€ã‚’ **ã‚³ãƒãƒ³ãƒ‰ä¸€ç™ºåŒ–** ã—ã¦ã€é–‹ç™ºã®å„€å¼ã‚’çŸ­ãã—ã¦ã„ãã‚ˆã€œï¼ğŸ®ğŸš€

[1]: https://docs.docker.com/compose/how-tos/startup-order/ "Control startup order | Docker Docs"
[2]: https://www.postgresql.org/about/news/postgresql-18-released-3142/?utm_source=chatgpt.com "PostgreSQL 18 Released!"
[3]: https://docs.docker.com/reference/cli/docker/compose/up/ "docker compose up | Docker Docs"
