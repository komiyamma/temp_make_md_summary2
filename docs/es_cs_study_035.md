# ç¬¬35ç« ï¼šã‚¤ãƒ™ãƒ³ãƒˆã®é€²åŒ–ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ï¼‰ï¼‹å†ªç­‰æ€§ï¼ˆæœ€å°ï¼‰ğŸ§¬ğŸ§·

## ã“ã®ç« ã§ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ ğŸ¯âœ¨

* ã‚¤ãƒ™ãƒ³ãƒˆãŒä¿å­˜ã•ã‚ŒãŸã‚ã¨ã«ã€Œä»•æ§˜å¤‰æ›´ã€ãŒæ¥ã¦ã‚‚ã€å£Šã•ãšã«å‰ã¸é€²ã‚ã‚‹ã‚ˆã†ã«ãªã‚‹ğŸ§¯âœ…
* â€œéå»ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯åŸºæœ¬ã„ã˜ã‚‰ãªã„â€ç†ç”±ãŒè…¹è½ã¡ã™ã‚‹ğŸ“œğŸ™‚
* ã€Œã‚¤ãƒ™ãƒ³ãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€ã‚’æ‰±ã†æœ€å°ã®è¨­è¨ˆï¼ˆã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ï¼‹Upcastï¼‰ã‚’æ›¸ã‘ã‚‹ğŸ§°ğŸ”
* äºŒé‡å®Ÿè¡Œï¼ˆãƒªãƒˆãƒ©ã‚¤ãƒ»é€£æ‰“ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå†é€ï¼‰ã§ã‚¤ãƒ™ãƒ³ãƒˆãŒäºŒé‡ã«ç©ã¾ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ï¼ˆå†ªç­‰æ€§ã‚­ãƒ¼ï¼‰ã‚’å…¥ã‚Œã‚‰ã‚Œã‚‹ğŸ”ğŸ”’

---

# 1. ç¾å®Ÿã§ã‚ˆãèµ·ãã‚‹2ã¤ã®äº‹æ•… ğŸ˜µâ€ğŸ’«ğŸ’¥

## äº‹æ•…Aï¼šã‚¤ãƒ™ãƒ³ãƒˆã®å½¢ã‚’å¤‰ãˆãŸã‚‰ã€éå»ãŒèª­ã‚ãªã„ğŸ§Š

ä¾‹ï¼‰`CartItemAdded` ã«ã€Œå˜ä¾¡ï¼ˆUnitPriceï¼‰ã€ã‚’å¾Œã‹ã‚‰è¶³ã—ãŸã„

* æ˜”ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼šå˜ä¾¡ãŒç„¡ã„
* æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ï¼šå˜ä¾¡ãŒå¿…é ˆ
  â†’ å¾©å…ƒï¼ˆRehydrateï¼‰ãŒé€”ä¸­ã§è½ã¡ã‚‹ğŸ˜¿

## äº‹æ•…Bï¼šåŒã˜ã‚³ãƒãƒ³ãƒ‰ãŒ2å›å±Šã„ã¦ã€ã‚¤ãƒ™ãƒ³ãƒˆãŒ2å›ç©ã¾ã‚Œã‚‹ğŸ”ğŸ”

åŸå› ã‚ã‚‹ã‚ã‚‹ğŸ‘‡

* ç”»é¢ã®äºŒåº¦æŠ¼ã—ğŸ–±ï¸ğŸ–±ï¸
* APIã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆâ†’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒå†é€ğŸ“¶ğŸ˜µ
* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ã®ãƒªãƒˆãƒ©ã‚¤ğŸ”
  â†’ ã€Œæ•°é‡ãŒ2å€ã€ã¿ãŸã„ãªæ‚²åŠ‡ãŒèµ·ãã‚‹ğŸ¥²

---

# 2. ã¾ãšå¤§åŸå‰‡ï¼šã€Œã‚¤ãƒ™ãƒ³ãƒˆã¯åŸºæœ¬ã€å¤‰ãˆãªã„ã€ğŸ“œğŸ§¡

ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°ã§ã¯ã€ã‚¤ãƒ™ãƒ³ãƒˆã¯â€œå±¥æ­´ãã®ã‚‚ã®â€ãªã®ã§ã€å¾Œã‹ã‚‰æ›¸ãæ›ãˆã‚‹ã¨â€¦

* ç›£æŸ»ãƒ»è¿½è·¡ãŒå´©ã‚Œã‚‹ğŸ•µï¸â€â™€ï¸ğŸ’¦
* å¤ã„ãƒ‡ãƒ¼ã‚¿ãŒèª­ã‚ãªããªã‚‹ğŸ“¦
* åˆ¥ã®èª­ã¿ãƒ¢ãƒ‡ãƒ«ï¼ˆProjectionï¼‰ã‚„åˆ†æãŒå£Šã‚Œã‚‹ğŸ“ŠğŸ’¥

ç‰¹ã«ç¾è¡Œã® .NET 10 ã¯ JSON å‘¨ã‚ŠãŒã‚ˆã‚Šå³æ ¼ã«ãªã£ã¦ã„ã¦ã€æ›–æ˜§ãªJSONã‚’æ—©ã‚ã«å¼¾ãæ–¹å‘ãŒå¼·ã„ã§ã™ï¼ˆä¾‹ï¼šãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿äºˆç´„åã¨ã®è¡çªæ¤œå‡ºãªã©ï¼‰ã€‚([Microsoft Learn][1])
ã¾ãŸã€ç¾è¡ŒLTSã¯ .NET 10ï¼ˆ2025-11-11 ãƒªãƒªãƒ¼ã‚¹ï¼‰ã§ã™ã€‚([Microsoft][2])

---

# 3. ã‚¤ãƒ™ãƒ³ãƒˆé€²åŒ–ã®ã€Œã‚ˆãä½¿ã†3ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ğŸ§¬ğŸ“¦âœ¨

| ãƒ‘ã‚¿ãƒ¼ãƒ³                    | ä½•ã‚’ã™ã‚‹ï¼Ÿ                    | ã„ã¤å‘ãï¼Ÿ           | æ³¨æ„ç‚¹            |
| ----------------------- | ------------------------ | --------------- | -------------- |
| â‘  å¾Œæ–¹äº’æ›ã®è¿½åŠ ï¼ˆAdditiveï¼‰â•    | ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’â€œè¿½åŠ â€ã—ã¦ã€ç„¡ã„ã¨ãã¯æ—¢å®šå€¤ã§æ‰±ã† | è¿½åŠ ãŒè‡ªç„¶ï¼ˆä¾‹ï¼šãƒ¡ãƒ¢æ¬„ï¼‰    | â€œå¿…é ˆåŒ–â€ã™ã‚‹ã¨å´©ã‚Œã‚‹ğŸ˜µ  |
| â‘¡ æ–°ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ï¼ˆNew Eventï¼‰ğŸ†• | æ—§ã‚¤ãƒ™ãƒ³ãƒˆã¯æ®‹ã—ã€æ–°ã‚¤ãƒ™ãƒ³ãƒˆã§è¡¨ç¾ã™ã‚‹      | æ„å‘³ãŒå¤‰ã‚ã‚‹ï¼åˆ†ã‘ãŸã„     | èª­ã¿å´ã®å¯¾å¿œãŒå¢—ãˆã‚‹ğŸ§¹   |
| â‘¢ èª­ã¿å–ã‚Šæ™‚ã«å¤‰æ›ï¼ˆUpcastï¼‰ğŸ”    | æ—§ã‚¤ãƒ™ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã‚“ã ç¬é–“ã«æ–°å½¢ã¸å¤‰æ›ã™ã‚‹    | éå»ã‚¤ãƒ™ãƒ³ãƒˆã‚’æœ€æ–°å½¢ã§æ‰±ã„ãŸã„ | å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆå¿…é ˆğŸ§ª |

ã“ã®ç« ã§ã¯ã€Œâ‘¢ Upcastã€ï¼‹ã€Œå†ªç­‰æ€§ã€ã‚’æœ€å°ã§ã‚„ã‚Šã¾ã™ğŸ˜ŠğŸ§°

---

# 4. æœ€å°ã®é“å…·ï¼šã€Œã‚¤ãƒ™ãƒ³ãƒˆã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ã€ğŸ±ğŸ·ï¸

ã‚¤ãƒ™ãƒ³ãƒˆæœ¬ä½“ã ã‘ã ã¨ã€é€²åŒ–ã‚„é‹ç”¨ã§å›°ã‚ŠãŒã¡ãªã®ã§ã€æœ€ä½é™ã®åŒ…ã¿ï¼ˆEnvelopeï¼‰ã‚’ã¤ã‘ã¾ã™ğŸ§¸âœ¨

* `EventType`ï¼šã‚¤ãƒ™ãƒ³ãƒˆåï¼ˆä¾‹ï¼š`CartItemAdded`ï¼‰
* `SchemaVersion`ï¼šãã®ã‚¤ãƒ™ãƒ³ãƒˆã®å½¢ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆä¾‹ï¼š1, 2â€¦ï¼‰
* `EventId`ï¼šã‚¤ãƒ™ãƒ³ãƒˆè‡ªä½“ã®ä¸€æ„IDï¼ˆé‡è¤‡å¯¾ç­–ã«ã‚‚ä½¿ãˆã‚‹ï¼‰ğŸ†”
* `OccurredAt`ï¼šç™ºç”Ÿæ—¥æ™‚â°
* `DataJson`ï¼šã‚¤ãƒ™ãƒ³ãƒˆæœ¬ä½“ï¼ˆJSONï¼‰ğŸ§¾
* `MetaJson`ï¼šç›¸é–¢IDã‚„å†ªç­‰æ€§ã‚­ãƒ¼ãªã©ï¼ˆJSONï¼‰ğŸ·ï¸

> ãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ãƒƒã‚¯ãª JSONï¼ˆç¶™æ‰¿ã‚¤ãƒ™ãƒ³ãƒˆã‚’ `System.Text.Json` ã§åˆ¤åˆ¥ã—ã¦å¾©å…ƒã™ã‚‹ï¼‰ã‚‚å¯èƒ½ã§ã€.NET 7 ä»¥é™ã¯å±æ€§ã§ã®ã‚µãƒãƒ¼ãƒˆãŒã‚ã‚Šã¾ã™ã€‚([Microsoft Learn][3])
> ãŸã ã—æœ¬ç« ã¯ã€Œã¾ãšå£Šã‚Œã«ãã„æœ€å°ã€ã‚’å„ªå…ˆã—ã¦ã€`EventType + DataJson` æ–¹å¼ã§ã„ãã¾ã™ğŸ˜Š

---

# 5. å®Ÿè£…ï¼šã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ã¨ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆä¾‹ï¼šã‚«ãƒ¼ãƒˆï¼‰ğŸ›’âœ¨

```csharp
using System.Text.Json;

public sealed record EventEnvelope(
    Guid EventId,
    string StreamId,
    long StreamVersion,
    string EventType,
    int SchemaVersion,
    DateTimeOffset OccurredAt,
    string DataJson,
    string MetaJson
);

public sealed record CartItemAddedV1(Guid CartId, string Sku, int Quantity);
public sealed record CartItemAddedV2(Guid CartId, string Sku, int Quantity, decimal UnitPrice);

public static class Json
{
    public static readonly JsonSerializerOptions Options = new()
    {
        PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
        WriteIndented = false
    };
}
```

## ğŸ’¡ãƒã‚¤ãƒ³ãƒˆ

* â€œV1/V2â€ ã¯ã€Œéå»ã‚¤ãƒ™ãƒ³ãƒˆã®å½¢ã€ã‚’è¡¨ã™ãŸã‚ã®å‹ã ã‚ˆğŸ˜Š
* ä»Šã®ã‚¢ãƒ—ãƒªã®å†…éƒ¨ã§ã¯ã€Œæœ€æ–°å½¢ï¼ˆV2ï¼‰ã€ã§çµ±ä¸€ã—ã¦æ‰±ãˆã‚‹ã¨ãƒ©ã‚¯âœ¨

---

# 6. å®Ÿè£…ï¼šUpcastï¼ˆV1â†’V2ã¸å¤‰æ›ï¼‰ğŸ”ğŸ§™â€â™€ï¸

## 6.1 Upcastã®æ–¹é‡ï¼ˆè¶…é‡è¦ï¼‰ğŸ“Œ

* æ—§ã‚¤ãƒ™ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã‚“ã ã‚‰ã€å³åº§ã«â€œæœ€æ–°å½¢â€ã¸å¤‰æ›ã—ã¦ã‹ã‚‰ãƒ‰ãƒ¡ã‚¤ãƒ³ã«æ¸¡ã™
* å¤‰æ›çµæœã¯ã€Œãã®å ´ã ã‘ã€ã§ã‚‚OKï¼ˆæœ€å°ï¼‰

  * ä½™è£•ãŒã‚ã‚Œã°ã€Œå¤‰æ›å¾Œã§ä¿å­˜ã—ç›´ã™ã€æˆ¦ç•¥ã‚‚ã‚ã‚‹ã‘ã©ã€ã“ã®ç« ã¯ã‚„ã‚‰ãªã„ğŸ™‚

## 6.2 Upcasterã‚³ãƒ¼ãƒ‰ï¼ˆæœ€å°ï¼‰ğŸ§°

```csharp
public static class EventUpcaster
{
    public static EventEnvelope UpcastToLatest(EventEnvelope e)
    {
        // ä¾‹ï¼šCartItemAdded ã® v1 â†’ v2
        if (e.EventType == "CartItemAdded" && e.SchemaVersion == 1)
        {
            var v1 = JsonSerializer.Deserialize<CartItemAddedV1>(e.DataJson, Json.Options)
                     ?? throw new InvalidOperationException("Invalid CartItemAdded v1 JSON");

            // v1ã«ã¯UnitPriceãŒç„¡ã„ã®ã§ã€æ—¢å®šå€¤ã§è£œã†ï¼ˆä¾‹ã¨ã—ã¦0ï¼‰
            var v2 = new CartItemAddedV2(v1.CartId, v1.Sku, v1.Quantity, unitPrice: 0m);

            return e with
            {
                SchemaVersion = 2,
                DataJson = JsonSerializer.Serialize(v2, Json.Options)
            };
        }

        return e;
    }
}
```

## 6.3 ã€Œæ—¢å®šå€¤0ã€ã£ã¦ã‚¢ãƒªï¼ŸğŸ¤”

å­¦ç¿’ã§ã¯OKï¼âœ…
å®Ÿå‹™ã§ã¯ã€

* å˜ä¾¡ãŒå¿…é ˆã®æ„å‘³ãªã‚‰ã€Œå¾Œã‹ã‚‰å¿…é ˆåŒ–ã€ã§ã¯ãªãã€ã‚¤ãƒ™ãƒ³ãƒˆè¨­è¨ˆã‚’è¦‹ç›´ã™ï¼ˆâ‘¡æ–°ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ ãªã©ï¼‰ã‚‚æ¤œè¨ã™ã‚‹ã‚ˆğŸ§ âœ¨

---

# 7. ã“ã“ã‹ã‚‰æœ¬é¡Œï¼šå†ªç­‰æ€§ï¼ˆIdempotencyï¼‰ğŸ§·ğŸ”’âœ¨

## 7.1 å†ªç­‰æ€§ã£ã¦ãªã«ï¼ŸğŸ™‚

åŒã˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆåŒã˜æ„å›³ï¼‰ãŒè¤‡æ•°å›æ¥ã¦ã‚‚ã€çµæœãŒä¸€å›åˆ†ã«ãªã‚‹æ€§è³ªã ã‚ˆğŸ”âœ…
å®Ÿå‹™ã®REST APIã§ã‚‚ã€Œå†ªç­‰æ€§ã‚­ãƒ¼ã€ã‚’ä½¿ã£ã¦é‡è¤‡ã‚’é˜²ãè¨­è¨ˆãŒã‚ˆãç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚([Milan JovanoviÄ‡][4])

## 7.2 ä½•ã‚’â€œåŒã˜â€ã¨ã¿ãªã™ï¼ŸğŸ§ 

ã“ã®ç« ã¯æœ€å°ãªã®ã§ğŸ‘‡

* ã€ŒIdempotencyKeyï¼ˆå†ªç­‰æ€§ã‚­ãƒ¼ï¼‰ãŒåŒã˜ãªã‚‰ã€åŒã˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ‰±ã„ã€ã«ã™ã‚‹
* ã•ã‚‰ã«å®‰å…¨ã«ã™ã‚‹ãŸã‚ã€`RequestHash`ï¼ˆå†…å®¹ã®ãƒãƒƒã‚·ãƒ¥ï¼‰ã‚‚ä¿å­˜ã—ã¦ã€Œã‚­ãƒ¼ä½¿ã„å›ã—äº‹æ•…ã€ã‚’æ¤œå‡ºã™ã‚‹ğŸš¨

---

# 8. å®Ÿè£…ï¼šSQLiteã§å†ªç­‰æ€§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œã‚‹ğŸ—„ï¸ğŸ§·

## 8.1 ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæœ€å°DDLï¼‰ğŸ§±

```sql
CREATE TABLE IF NOT EXISTS idempotency (
  idempotency_key TEXT PRIMARY KEY,
  request_hash     TEXT NOT NULL,
  response_json    TEXT,
  status           TEXT NOT NULL,
  created_at       TEXT NOT NULL
);
```

* `PRIMARY KEY` ã«ã‚ˆã‚‹ä¸€æ„åˆ¶ç´„ã§ã€ŒåŒã˜ã‚­ãƒ¼ã®äºŒé‡ç™»éŒ²ã€ã‚’æ­¢ã‚ã‚‹ğŸ”’
* `status` ã¯æœ€å°ã§ `"processing"` / `"completed"` ã‚’æƒ³å®šğŸ™‚

---

# 9. å®Ÿè£…ï¼šå†ªç­‰æ€§ã¤ãã‚³ãƒãƒ³ãƒ‰å‡¦ç†ï¼ˆæœ€å°ã®å‹ï¼‰ğŸ“®âœ…ğŸ”

ã“ã“ã§ã¯ã€ŒAddItemï¼ˆå•†å“è¿½åŠ ï¼‰ã€ã‚’ä¾‹ã«ã™ã‚‹ã­ğŸ›’âœ¨

* 1å›ç›®ï¼šæ™®é€šã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç©ã‚€
* 2å›ç›®ï¼šåŒã˜ã‚­ãƒ¼ãªã‚‰ â€œå‰å›ã®çµæœâ€ ã‚’è¿”ã—ã¦ã€ã‚¤ãƒ™ãƒ³ãƒˆã¯å¢—ã‚„ã•ãªã„

## 9.1 ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨çµæœï¼ˆä¾‹ï¼‰ğŸ§¾

```csharp
public sealed record AddItemCommand(Guid CartId, string Sku, int Quantity, decimal UnitPrice);

public sealed record AddItemResult(bool Success, string Message, long NewStreamVersion);
```

## 9.2 ã–ã£ãã‚Šã®æµã‚Œï¼ˆè¶…å¤§äº‹ï¼‰ğŸ§ âœ¨

1. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
2. `idempotency_key` ã§æ¤œç´¢

* completed ãªã‚‰ response ã‚’è¿”ã™
* processing ãªã‚‰ã€Œå‡¦ç†ä¸­ã€æ‰±ã„ï¼ˆä»Šå›ã¯ä¾‹å¤– or ãƒªãƒˆãƒ©ã‚¤ä¿ƒã—ï¼‰

3. ãªã‘ã‚Œã° processing ã§INSERTï¼ˆäºˆç´„ï¼‰
4. ã‚¤ãƒ™ãƒ³ãƒˆã‚’Append
5. response ã‚’ä¿å­˜ã—ã¦ completed ã«æ›´æ–°
6. ã‚³ãƒŸãƒƒãƒˆâœ…

## 9.3 ã‚³ãƒ¼ãƒ‰ï¼ˆæœ€å°ãƒ»é›°å›²æ°—é‡è¦–ï¼‰ğŸ§¸âœ¨

```csharp
using System.Security.Cryptography;
using System.Text;
using System.Text.Json;
using Microsoft.Data.Sqlite;

public sealed class IdempotencyStore
{
    private readonly SqliteConnection _conn;
    public IdempotencyStore(SqliteConnection conn) => _conn = conn;

    public (string Status, string? ResponseJson, string RequestHash)? Find(string key, SqliteTransaction tx)
    {
        using var cmd = _conn.CreateCommand();
        cmd.Transaction = tx;
        cmd.CommandText = """
            SELECT status, response_json, request_hash
            FROM idempotency
            WHERE idempotency_key = $key
            """;
        cmd.Parameters.AddWithValue("$key", key);

        using var reader = cmd.ExecuteReader();
        if (!reader.Read()) return null;

        return (reader.GetString(0), reader.IsDBNull(1) ? null : reader.GetString(1), reader.GetString(2));
    }

    public void Reserve(string key, string requestHash, SqliteTransaction tx)
    {
        using var cmd = _conn.CreateCommand();
        cmd.Transaction = tx;
        cmd.CommandText = """
            INSERT INTO idempotency(idempotency_key, request_hash, response_json, status, created_at)
            VALUES ($key, $hash, NULL, 'processing', $now)
            """;
        cmd.Parameters.AddWithValue("$key", key);
        cmd.Parameters.AddWithValue("$hash", requestHash);
        cmd.Parameters.AddWithValue("$now", DateTimeOffset.UtcNow.ToString("O"));
        cmd.ExecuteNonQuery();
    }

    public void Complete(string key, string responseJson, SqliteTransaction tx)
    {
        using var cmd = _conn.CreateCommand();
        cmd.Transaction = tx;
        cmd.CommandText = """
            UPDATE idempotency
            SET response_json = $res, status = 'completed'
            WHERE idempotency_key = $key
            """;
        cmd.Parameters.AddWithValue("$key", key);
        cmd.Parameters.AddWithValue("$res", responseJson);
        cmd.ExecuteNonQuery();
    }

    public static string HashRequest(AddItemCommand cmd)
    {
        var canonical = JsonSerializer.Serialize(cmd, Json.Options);
        var bytes = SHA256.HashData(Encoding.UTF8.GetBytes(canonical));
        return Convert.ToHexString(bytes);
    }
}
```

> â€» `INSERT` ãŒã‚­ãƒ¼é‡è¤‡ã§å¤±æ•—ã™ã‚‹ã®ãŒã€ŒäºŒé‡å®Ÿè¡Œã‚’æ­¢ã‚ã‚‹ä»•çµ„ã¿ã€ã ã‚ˆğŸ”’âœ¨

---

# 10. æ¼”ç¿’ï¼šã‚¤ãƒ™ãƒ³ãƒˆé€²åŒ–ï¼‹å†ªç­‰æ€§ã‚’ã¤ãªã„ã§å®Œæˆã•ã›ã‚ˆã† ğŸ§ªğŸ€

## æ¼”ç¿’Aï¼šã‚¤ãƒ™ãƒ³ãƒˆé€²åŒ–ï¼ˆUpcastï¼‰ğŸ”ğŸ§¬

1. `CartItemAdded` ã® `SchemaVersion` ã‚’ 1/2 ã§ä½œã‚‹
2. V1 ã® JSON ã‚’ä¿å­˜ã—ã¦ãŠãï¼ˆUnitPriceç„¡ã—ï¼‰
3. èª­ã¿è¾¼ã¿æ™‚ã« `EventUpcaster.UpcastToLatest` ã‚’é€šã—ã¦ã‹ã‚‰å¾©å…ƒã™ã‚‹
4. ã€ŒV1ã§ã‚‚è½ã¡ãªã„ã€ã“ã¨ã‚’ç¢ºèªâœ…

ãƒã‚§ãƒƒã‚¯âœ…

* Upcastå¾Œã® `SchemaVersion` ãŒ 2 ã«ãªã£ã¦ã‚‹ï¼Ÿ
* `UnitPrice` ãŒæ—¢å®šå€¤ã«ãªã£ã¦ã‚‹ï¼Ÿ

---

## æ¼”ç¿’Bï¼šå†ªç­‰æ€§ï¼ˆIdempotencyKeyï¼‰ğŸ”’ğŸ§·

1. `IdempotencyStore` ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œã‚‹
2. ã‚³ãƒãƒ³ãƒ‰å‡¦ç†ã®æœ€åˆã§ `Find` â†’ æ—¢å­˜ãªã‚‰çµæœã‚’è¿”ã™
3. ç„¡ã‘ã‚Œã° `Reserve` â†’ ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ  â†’ `Complete`
4. åŒã˜ `IdempotencyKey` ã§2å›å‘¼ã³ã€ã‚¤ãƒ™ãƒ³ãƒˆãŒå¢—ãˆãªã„ã“ã¨ã‚’ç¢ºèªâœ…

ãƒã‚§ãƒƒã‚¯âœ…

* 2å›ç›®ã¯ã€Œå‰å›ã®çµæœã€ã‚’è¿”ã—ã¦ã‚‹ï¼Ÿ
* ã‚¤ãƒ™ãƒ³ãƒˆæ•°ãŒ1å›åˆ†ã®ã¾ã¾ï¼Ÿ

---

# 11. ãƒ†ã‚¹ãƒˆï¼ˆGiven-When-Thenï¼‰ã§å®ˆã‚ã†ğŸ§ªğŸŒ¸

## 11.1 æœŸå¾…ã™ã‚‹ãµã‚‹ã¾ã„ âœ…âœ¨

* **Given**ï¼šç©ºã®çŠ¶æ…‹
* **When**ï¼šåŒã˜ã‚³ãƒãƒ³ãƒ‰ï¼ˆåŒã˜å†ªç­‰æ€§ã‚­ãƒ¼ï¼‰ã‚’2å›å®Ÿè¡Œ
* **Then**ï¼šã‚¤ãƒ™ãƒ³ãƒˆã¯1å›ã ã‘ã€çµæœã¯åŒã˜

```csharp
using Xunit;

public sealed class IdempotencyTests
{
    [Fact]
    public void Same_idempotency_key_does_not_append_twice()
    {
        // ã“ã“ã¯æ“¬ä¼¼ï¼šæœ¬å½“ã¯EventStore/SQLiteã‚’ä½¿ã£ã¦
        // ã€ŒAppendã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆæ•°ã€ã‚’æ¤œè¨¼ã™ã‚‹ãƒ†ã‚¹ãƒˆã«ã™ã‚‹ã‚ˆğŸ§ªâœ¨

        var cmd = new AddItemCommand(
            CartId: Guid.NewGuid(),
            Sku: "SKU-001",
            Quantity: 1,
            UnitPrice: 1200m
        );

        var key = Guid.NewGuid().ToString(); // IdempotencyKeyï¼ˆä¾‹ï¼‰

        // 1å›ç›®ï¼šæˆåŠŸã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
        // 2å›ç›®ï¼šåŒã˜keyãªã®ã§ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ ã•ã‚Œãªã„ï¼ˆåŒã˜çµæœãŒè¿”ã‚‹ï¼‰
        Assert.True(true);
    }
}
```

> ãƒ†ã‚¹ãƒˆæœ¬ä½“ã¯ã€å‰ç« ã¾ã§ã§ä½œã£ãŸã€ŒSQLite EventStoreã€ã«åˆã‚ã›ã¦ã€
> â€œã‚¤ãƒ™ãƒ³ãƒˆä»¶æ•°â€ ã‚’ã¡ã‚ƒã‚“ã¨æ•°ãˆã¦ Assert ã—ã‚ˆã†ã­ğŸ“ğŸ˜Š

---

# 12. AIæ´»ç”¨ï¼ˆã“ã®ç« ã§åŠ¹ãä½¿ã„æ–¹ï¼‰ğŸ¤–âœ¨ğŸ’¡

## Upcastç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ ğŸ§™â€â™€ï¸

* ã€ŒV1â†’V2 ã®å¤‰æ›ã§ã€æ—¢å®šå€¤ã®æ±ºã‚æ–¹ã®å€™è£œã‚’3ã¤å‡ºã—ã¦ã€ğŸ§ 
* ã€ŒUpcastã®å˜ä½“ãƒ†ã‚¹ãƒˆè¦³ç‚¹ã‚’Given-When-Thenã§10å€‹ã€ğŸ§ª

## å†ªç­‰æ€§ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ ğŸ”’

* ã€ŒIdempotencyKeyã®ä¿å­˜ã«å¿…è¦ãªã‚«ãƒ©ãƒ è¨­è¨ˆã‚’ã€æœ€å°â†’å®Ÿå‹™å‘ã‘ã§æ¯”è¼ƒã—ã¦ã€ğŸ“‹
* ã€ŒåŒã˜ã‚­ãƒ¼ã§åˆ¥å†…å®¹ãŒæ¥ãŸã¨ãã®æ‰±ã„æ–¹ï¼ˆ409/422/ãƒ­ã‚°ã®ã¿ç­‰ï¼‰ã®ãƒ¡ãƒªãƒ‡ãƒ¡ã€âš–ï¸

ï¼ˆå†ªç­‰æ€§ã‚­ãƒ¼æ–¹å¼ã¯APIè¨­è¨ˆã§ã‚‚å®šç•ªã§ã€â€œé‡è¤‡ã‚’é˜²ã„ã§ä¿¡é ¼æ€§ã‚’ä¸Šã’ã‚‹â€æ–‡è„ˆã§èª¬æ˜ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã‚ˆğŸ“šï¼‰([Milan JovanoviÄ‡][4])

---

# 13. ã‚ˆãã‚ã‚‹ãƒŸã‚¹é›† ğŸ™…â€â™€ï¸ğŸ’¦ï¼ˆã“ã“è¶…ã‚ã‚‹ã‚ã‚‹ï¼ï¼‰

* **ã‚¤ãƒ™ãƒ³ãƒˆã« `$type` ã¿ãŸã„ãªäºˆç´„ã£ã½ã„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã‚’å…¥ã‚Œã¦æ··ä¹±**
  â†’ .NET 10 ã§ã¯äºˆç´„ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨è¡çªã™ã‚‹åå‰ã¸ã®ãƒã‚§ãƒƒã‚¯ãŒå¼·ããªã£ã¦ã‚‹ã®ã§æ³¨æ„âš ï¸([Microsoft Learn][5])
* **ã€Œãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ ã€ã‚’ã—ãŸã®ã«ã€èª­ã¿å´ã§å¿…é ˆæ‰±ã„ã—ã¦è½ã¡ã‚‹**ğŸ˜¿
* **å†ªç­‰æ€§ã‚­ãƒ¼ã¯ã‚ã‚‹ã®ã«ã€çµæœã‚’ä¿å­˜ã—ã¦ãªãã¦2å›ç›®ã«è¿”ã›ãªã„**ğŸ“¦ğŸ’¥
* **åŒã˜ã‚­ãƒ¼ã‚’åˆ¥ç”¨é€”ã«ä½¿ã„å›ã—ã¦äº‹æ•…**ï¼ˆRequestHashã§æ¤œçŸ¥ã—ã‚ˆã†ğŸš¨ï¼‰

---

# 14. ã¾ã¨ã‚ ğŸ§¡ğŸ“˜âœ¨

* ã‚¤ãƒ™ãƒ³ãƒˆã¯â€œå±¥æ­´â€ãªã®ã§ã€åŸºæœ¬ã¯æ›¸ãæ›ãˆãšã€Œé€²åŒ–ã€ã•ã›ã‚‹ğŸ§¬
* æœ€å°ã®é€²åŒ–ã¯ **SchemaVersion + Upcast** ãŒæ‰±ã„ã‚„ã™ã„ğŸ”
* äºŒé‡å®Ÿè¡Œã¯æ™®é€šã«èµ·ãã‚‹ã®ã§ã€**IdempotencyKey + ä¸€æ„åˆ¶ç´„ + çµæœä¿å­˜** ã§å®ˆã‚‹ğŸ”’ğŸ§·
* ç¾è¡Œã® .NET 10 ã¯ JSON ã‚’ã‚ˆã‚Šå³å¯†ã«æ‰±ã†æ–¹å‘ãŒè¦‹ãˆã‚‹ã®ã§ã€ã€Œæ›–æ˜§ã«ã—ãªã„è¨­è¨ˆã€ãŒã‚ˆã‚Šå¤§äº‹ã«ãªã£ã¦ãã‚‹ã‚ˆğŸ™‚âœ¨([Microsoft Learn][1])

[1]: https://learn.microsoft.com/en-us/dotnet/core/whats-new/dotnet-10/overview?utm_source=chatgpt.com "What's new in .NET 10"
[2]: https://dotnet.microsoft.com/ja-jp/platform/support/policy?utm_source=chatgpt.com "å…¬å¼ã® .NET ã‚µãƒãƒ¼ãƒˆ ãƒãƒªã‚·ãƒ¼ | .NET"
[3]: https://learn.microsoft.com/en-us/dotnet/standard/serialization/system-text-json/polymorphism?utm_source=chatgpt.com "How to serialize properties of derived classes with System. ..."
[4]: https://www.milanjovanovic.tech/blog/implementing-idempotent-rest-apis-in-aspnetcore?utm_source=chatgpt.com "Implementing Idempotent REST APIs in ASP.NET Core"
[5]: https://learn.microsoft.com/en-us/dotnet/core/compatibility/serialization/10/property-name-validation?utm_source=chatgpt.com "System.Text.Json checks for property name conflicts - .NET"
