# 第5章：前提③ 最終的整合性 “すぐ一致しない”を怖がらない 🕰️🌈

## この章でわかること 🎯✨

* **最終的整合性**ってなに？（やさしく！）🙂
* 「すぐ一致しない」のに、**ちゃんと安全**にできる理由 🛡️
* ユーザー体験（UX）と整合性の**ちょうどいい折り合い** 🎛️
* Outboxが **“最終的整合性の安全装置”** ってどういうこと？📦🔒

---

## 1. 最終的整合性ってなに？🤔🕰️

最終的整合性（Eventual Consistency）を一言でいうと…

<!-- img: outbox_ts_study_005_timeline.png -->
**「今この瞬間は、場所によって見えてる情報が違うことがある。でも、更新が止まれば、いずれ全部同じになる」**
という考え方だよ〜⏳🌈 ([ウィキペディア][1])

たとえば👇

* アプリAでは「注文完了！」✅
* でも通知サービスではまだ「未通知」📭
* しばらくしたら通知サービスも追いついて「通知済み」📩

こういう “時間差” を **前提として受け入れる**のがポイントだよ🙂✨

---

## 2. なんで「すぐ一致」をあきらめるの？😵‍💫🌍

現実のシステムは、だいたいこう👇

* ネットワークが遅い/切れる📶💥
* 別サービスが落ちる🧯
* 混んでる（負荷）🐈‍⬛💨
* 処理の順番がズレる🌀

「全部が全部、同時に完璧に一致するまで待つ」ってやると…
**遅い・止まりやすい・スケールしにくい** になりがち😇

だから多くの分散システムでは、**一部は非同期にして“追いつかせる”**設計をすることが多いよ🌈 ([ウィキペディア][1])

---

## 3. “すぐ一致” と “あとで一致” の違い（超イメージ）🧠✨

### すぐ一致（強い整合性っぽい）⚡

* 変更したら、どこで見ても即同じ
* ただし、遅くなったり止まりやすいことも🥲

### あとで一致（最終的整合性）🕰️

* 変更が伝わるまでタイムラグがある
* でも、止まりにくくて現実に強い💪

ここで大事なのは👇
**最終的整合性＝テキトー**じゃないよ！🙅‍♀️
「遅れてもいい範囲」を決めて、**安全に遅らせる**のが設計なんだ😊

---

## 4. UX（ユーザー体験）との折り合い 🎛️🙂

最終的整合性で一番大事なのは、ここ！✨
**どこを “即時必須” にして、どこを “あとでOK” にするか** を決めることだよ🧩

### 4.1 即時必須になりがちなところ 🔥

ユーザーが「今この瞬間に合ってないと困る」やつ👇

* 決済結果（支払い成功/失敗）💳
* 残高・在庫・座席数 🪙📦🎫
* 課金や返金の確定表示 💰
* 二重購入を防ぐための確定フラグ ✅

ここは「あとで直るよ〜」だと事故りやすい😱

### 4.2 あとでOKになりがちなところ 🌿

多少遅れてもユーザーが許しやすいもの👇

* メール通知 📩
* プッシュ通知 🔔
* 分析ログ・行動ログ 📊
* 外部サービス連携（CRM登録とか）🤝
* 「一覧の表示」など、数秒遅れても致命傷じゃない画面📄

この領域が、Outboxと相性がいいことが多いよ📦✨

### 4.3 “遅れてる”を優しく見せるUIの工夫 🪄😊

最終的整合性を採用するなら、UIで不安を減らすのが超大事！✨

* 状態を出す：

  * 「処理中…」⏳
  * 「反映まで少し時間がかかる場合があります」🙂
  * 「送信待ち」📭→「送信済み」📩
* リロード頼みをやめる：

  * 自動更新（数秒おき）🔄
  * 「最新に更新」ボタン🔁
* ユーザーの行動ミスを防ぐ：

  * 送信ボタン連打を防止（押したら無効化）🛑
  * 「同じ操作を繰り返しても大丈夫」な設計（冪等性は後の章でやるよ🛡️）

---

## 5. Outboxは最終的整合性の“安全装置”だよ 🛡️📦

ここが超重要ポイント！💡

最終的整合性って、「あとで揃う」前提だよね？
でも…
**“あとで送る” が失敗して、永遠に送られなかったら最悪**😱📭

そこで Outbox！📦✨

Outbox（Transactional Outbox）はざっくり👇

* 業務データ更新と同時に
* 「送るべきイベント」をDBに保存しておいて
* あとから別処理が確実に送る

という考え方だよ🧾📤
（“確実に送る”ための定番パターンとして整理されているよ）([microservices.io][2])

また、最近だと分散アプリ基盤（例：Dapr）でも Outbox の考え方が “How-To” として整理されてたりするよ🧰✨ ([Dapr Docs][3])

---

## 6. 具体例：注文確定 → 通知（時間差で揃う）🛒📩🕰️

### こういう世界観だよ 🌍

* 注文サービス（本体）🛒
* 通知サービス（メール送る）📩
* それぞれ別の処理（別プロセス/別サービス）だと思ってOK🙂

### タイムライン（イメージ）⏱️

1. 注文サービスが「注文確定」をDBに保存 ✅
2. 同じタイミングで Outbox に「OrderConfirmed イベント」を保存 📦🧾
3. Publisher（送信係）が Outbox を見つける 👀📤
4. 通知サービスへイベントが届く 📩
5. 通知サービスがメール送って「通知済み」になる ✅

このとき、ユーザーが見る世界は👇

* 注文画面：すぐ「注文完了」✅
* 通知：ちょっと遅れて届く📩

つまり、**一時的にズレるけど、最後は揃う**🌈
これが最終的整合性だよ🙂 ([ウィキペディア][1])

そして Outbox は👇
**「送るべきものが消えない」**
**「送信失敗しても、後で再挑戦できる」**
を支える仕組みなんだ🛡️📦 ([AWS ドキュメント][4])

---

## 7. よくある落とし穴 😱🌀（最終的整合性あるある）

### 落とし穴①：「さっき更新したのに、一覧に出ない！」📄😵

* 一覧は別サービス or 別キャッシュ参照で遅れてる
  👉 対策：状態表示・自動更新・検索条件の工夫🙂🔄

### 落とし穴②：「メール来ないから、もう一回注文した」🛒🔁

* 通知が遅れてるだけなのに、ユーザーが二重操作しちゃう
  👉 対策：注文の状態（処理中/確定）をはっきり見せる⏳✅

### 落とし穴③：「外部連携だけ失敗して、気づかない」🫥

* 本体はOK、連携だけ失敗…が見えない
  👉 対策：Outboxの状態を観測できるようにする（これは後半の章で強化🔍📊）

---

## 8. 設計ミニチェックリスト ✅🧠

最終的整合性を採用するとき、最低これを決めよう🙂

* 「即時必須」と「遅れてOK」を分けた？⚖️
* 遅れてOKな部分に、ユーザーが安心できる状態表示ある？⏳📩
* “送るべきもの” が失われない仕組みある？（Outbox）📦🧾
* 遅れや失敗が見える手段ある？（ログ/メトリクスは後の章で）🔍

---

## 9. ミニ演習 🎓📝（紙に書くと一気に理解できるよ！）

### 演習A：仕分けゲーム 🧺✨

次の機能を「即時必須」or「遅れてOK」に分けてみよう🙂

1. 決済成功表示 💳
2. 注文確認メール 📩
3. 在庫数の減少 📦
4. 管理画面の集計（売上グラフ）📊
5. 外部CRMへの登録 🤝

### 演習B：状態ラベルを考える 🏷️😊

「遅れてOK」側について、ユーザーに見せる状態を3つ作ろう✨
例：送信待ち📭 / 送信中📤 / 送信済み📩

---

## 10. AI活用ミニ型 🤖✨（Copilot/Codex向けの頼み方例）

そのまま貼って使える系だよ〜🧡

* 状態設計：
  「注文確定→通知送信の最終的整合性を前提に、ユーザーが不安にならない状態名（日本語UI文言）を10個提案して。短くて優しい口調で。」

* 仕分けレビュー：
  「この機能一覧を “即時必須” と “遅れてOK” に分類して、理由も添えて。」

* 画面文言：
  「通知が遅れているときの説明文を、責任逃れに見えない感じで3案出して。女子大生にも読みやすく。」

---

## まとめ 🧁✨

* 最終的整合性は **“今だけズレる”** けど **“最後は揃う”** という現実的な考え方だよ🕰️🌈 ([ウィキペディア][1])
* UXでは **即時必須/遅れてOK** を分けて、遅れは **状態表示** で優しく見せよう🙂🎛️
* Outboxは、最終的整合性の世界で **“送るべきものを失わない”** ための安全装置📦🛡️ ([microservices.io][2])

[1]: https://en.wikipedia.org/wiki/Eventual_consistency?utm_source=chatgpt.com "Eventual consistency"
[2]: https://microservices.io/patterns/data/transactional-outbox.html?utm_source=chatgpt.com "Pattern: Transactional outbox"
[3]: https://docs.dapr.io/developing-applications/building-blocks/state-management/howto-outbox/?utm_source=chatgpt.com "How-To: Enable the transactional outbox pattern"
[4]: https://docs.aws.amazon.com/prescriptive-guidance/latest/cloud-design-patterns/transactional-outbox.html?utm_source=chatgpt.com "Transactional outbox pattern - AWS Prescriptive Guidance"
