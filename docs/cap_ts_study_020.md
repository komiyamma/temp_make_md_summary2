# ç¬¬20ç« ï¼šãƒãƒ¼ã‚¸ã—ã‚„ã™ã„ãƒ‡ãƒ¼ã‚¿è¨­è¨ˆâ‘¡ï¼ˆé›†åˆ/å±¥æ­´/ã‚¤ãƒ™ãƒ³ãƒˆï¼‰ğŸ“šğŸ§©

## 20.1 ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ğŸ¯âœ¨

ã“ã®ç« ãŒçµ‚ã‚ã‚‹ã¨ã€ã“ã‚“ãªæ„Ÿè¦šãŒèº«ã«ã¤ãã¾ã™ğŸ‘‡ğŸ¥°

* ã€Œä¸Šæ›¸ãã€ã—ãªã„è¡¨ç¾ï¼ˆï¼ã‚ã¨ã‹ã‚‰åˆä½“ã—ã‚„ã™ã„è¡¨ç¾ï¼‰ã‚’é¸ã¹ã‚‹ğŸ§ ğŸ’¡
* **é›†åˆï¼ˆSetï¼‰**ãƒ»**å±¥æ­´ï¼ˆHistoryï¼‰**ãƒ»**ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆEventï¼‰**ã®ä½¿ã„åˆ†ã‘ãŒã§ãã‚‹ğŸ§©
* **æ“ä½œãƒ­ã‚° â†’ é›†è¨ˆï¼ˆè¡¨ç¤ºç”¨ã®å½¢ã«å¤‰æ›ï¼‰**ã®æµã‚Œã‚’æ‰‹ã§ä½œã‚Œã‚‹ğŸ› ï¸âœ¨

---

## 20.2 ãªã‚“ã§ã€Œä¸Šæ›¸ãã€ãŒåœ°é›·ãªã®ï¼ŸğŸ’£ğŸ˜±

åˆ†æ•£ã£ã½ã„ä¸–ç•Œã§ã¯ã€**åŒã˜ãƒ‡ãƒ¼ã‚¿ã«è¤‡æ•°ã®æ›´æ–°ãŒåŒæ™‚ã«èµ·ãã‚‹**ã®ãŒæ™®é€šã§ã™ğŸ˜µâ€ğŸ’«
ãã“ã§ã€Œä¸Šæ›¸ãã€ãƒ¢ãƒ‡ãƒ«ã ã¨èµ·ãã‚„ã™ã„äº‹æ•…ãŒã“ã‚ŒğŸ‘‡

### äº‹æ•…â‘ ï¼šç‰‡æ–¹ã®å¤‰æ›´ãŒæ¶ˆãˆã‚‹ï¼ˆLost Updateï¼‰ğŸ«¥ğŸ’¥

ãŸã¨ãˆã°ã€Œæ³¨æ–‡ã«ä»˜ãã‚¿ã‚°ã€ã‚’ã€é…åˆ—ã¾ã‚‹ã”ã¨ä¸Šæ›¸ãã§æŒã£ã¦ã‚‹ã¨ã—ã¾ã™ã€‚

* Aã•ã‚“ãŒã€ŒSALEã€ã‚’è¿½åŠ ğŸ·ï¸
* Bã•ã‚“ãŒã€ŒGIFTã€ã‚’è¿½åŠ ğŸ
* ãŸã¾ãŸã¾æœ€å¾Œã«ä¿å­˜ã—ãŸã»ã†ã ã‘ãŒæ®‹ã‚‹ï¼ˆã‚‚ã†ç‰‡æ–¹ãŒæ¶ˆãˆã‚‹ï¼‰ğŸ˜±

ã¤ã¾ã‚Šã€**ä¸Šæ›¸ãã¯â€œåˆä½“ï¼ˆãƒãƒ¼ã‚¸ï¼‰â€ãŒè‹¦æ‰‹**ãªã‚“ã§ã™ã€‚

---

## 20.3 åˆä½“ã—ã‚„ã™ã„3å…„å¼Ÿï¼šé›†åˆãƒ»å±¥æ­´ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆğŸ‘­âœ¨

ä¸Šæ›¸ãã—ãªã„ä¸–ç•Œã§ã¯ã€ã ã„ãŸã„ã“ã®3ã¤ãŒä¸»å½¹ã§ã™ğŸ‘‡

### A) é›†åˆï¼ˆSetï¼‰ğŸ§ºâœ¨

ã€Œã‚ã‚‹ï¼ãªã„ã€ã‚’è¡¨ã™ã‚„ã¤ã€‚
ä¾‹ï¼šã‚¿ã‚°ã€ã„ã„ã­ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼é›†åˆã€ãƒ–ãƒ­ãƒƒã‚¯ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼é›†åˆã€æ—¢èª­IDé›†åˆğŸ“š

* è¿½åŠ ï¼š`add("SALE")`
* å‰Šé™¤ï¼š`remove("SALE")`
* ãƒãƒ¼ã‚¸ï¼š**åŸºæœ¬ã¯ unionï¼ˆå’Œé›†åˆï¼‰**ã§åˆä½“ã—ã‚„ã™ã„ğŸ¤

---

### B) å±¥æ­´ï¼ˆHistoryï¼‰ğŸ“œâœ¨

ã€Œé †ç•ªã«ç©ã¿ä¸ŠãŒã‚‹è¨˜éŒ²ã€ã€‚
ä¾‹ï¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»å±¥æ­´ã€ä¾¡æ ¼å¤‰æ›´å±¥æ­´ã€é…é€å±¥æ­´ğŸššã€ãƒãƒ£ãƒƒãƒˆå±¥æ­´ğŸ’¬

* æ›¸ãè¾¼ã¿ã¯ **è¿½è¨˜ï¼ˆappendï¼‰**ãŒä¸­å¿ƒâœï¸
* ãƒãƒ¼ã‚¸ã¯ã€Œ**å±¥æ­´ã®åˆä½“ + é‡è¤‡æ’é™¤**ã€ãŒã—ã‚„ã™ã„ğŸ§¹

---

### C) ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆEventï¼‰ğŸ“£âœ¨

ã€Œèµ·ããŸäº‹å®Ÿã€ã‚’**çµ¶å¯¾ã«å¤‰ãˆãªã„å½¢ã§æ®‹ã™**ã‚„ã¤ã€‚
ä¾‹ï¼š`OrderPlaced`ï¼ˆæ³¨æ–‡ãŒä½œã‚‰ã‚ŒãŸï¼‰ / `PaymentAuthorized`ï¼ˆæ”¯æ‰•ã„OKã«ãªã£ãŸï¼‰ãªã©ğŸ’³ğŸ“¦

* â€œçŠ¶æ…‹â€ã˜ã‚ƒãªãã¦ â€œäº‹å®Ÿâ€ ã‚’ä¿å­˜ã™ã‚‹ğŸ“Œ
* è¡¨ç¤ºã—ãŸã„çŠ¶æ…‹ã¯ã€**ã‚¤ãƒ™ãƒ³ãƒˆã‚’é›†è¨ˆã—ã¦ä½œã‚‹ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ï¼‰**ğŸ§®âœ¨

> TypeScriptå‘¨ã‚Šã¯ã€ç¾æ™‚ç‚¹ã®å®‰å®šç‰ˆãŒ 5.9.3 ã§å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚([npmjs.com][1])
> ãã—ã¦ TypeScript 6.0â†’7.0ï¼ˆãƒã‚¤ãƒ†ã‚£ãƒ–ç§»è¡Œï¼‰ã«å‘ã‘ãŸå‹•ããŒé€²ã‚“ã§ã„ã¾ã™ã€‚([Microsoft for Developers][2])

---

## 20.4 ä½¿ã„åˆ†ã‘ã®è¶…ã–ã£ãã‚Šãƒ«ãƒ¼ãƒ«ğŸ§ ğŸ§©

* ã€Œã‚ã¨ã‹ã‚‰åˆä½“ã—ãŸã„ã€ãªã‚‰ **ä¸Šæ›¸ãã—ãªã„**ğŸ§·
* â€œã„ã¾ã®å€¤â€ã ã‘ã˜ã‚ƒãªãã¦
  **ã€Œã©ã†å¤‰ãˆãŸã‹ã€**ï¼ˆæ“ä½œï¼‰ã‚’æ®‹ã™ã¨å¼·ã„ğŸ’ªâœ¨

ã‚ˆãã‚ã‚‹é¸ã³æ–¹ğŸ‘‡

* ã‚¿ã‚°/æ—¢èª­/ãŠæ°—ã«å…¥ã‚Š â†’ **é›†åˆï¼ˆSetï¼‰**ğŸ·ï¸ğŸ“š
* çŠ¶æ…‹é·ç§»/é…é€ã®é€²ã¿ â†’ **å±¥æ­´ï¼ˆHistoryï¼‰**ğŸššğŸ“œ
* æ³¨æ–‡ãƒ»æ”¯æ‰•ã„ãƒ»åœ¨åº«ã®å‡ºæ¥äº‹ â†’ **ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆEventï¼‰**ğŸ“£ğŸ›’

---

## 20.5 ãƒãƒ³ã‚ºã‚ªãƒ³ï¼šæ“ä½œãƒ­ã‚° â†’ é›†è¨ˆã§ç”»é¢è¡¨ç¤ºã‚’ä½œã‚‹ğŸ› ï¸ğŸ–¥ï¸âœ¨

ã“ã“ã‹ã‚‰æ‰‹ã‚’å‹•ã‹ã—ã¾ã™âœ‹ğŸ˜Š
ã‚„ã‚‹ã“ã¨ã¯ã“ã†ğŸ‘‡

1. **ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ“ä½œãƒ­ã‚°ï¼‰**ã‚’è¿½è¨˜ã—ã¦ä¿å­˜ã™ã‚‹ğŸ“
2. ãƒ­ã‚°ã‚’èª­ã‚“ã§ã€**è¡¨ç¤ºç”¨ã®çŠ¶æ…‹ï¼ˆRead Modelï¼‰**ã‚’ä½œã‚‹ğŸ§®
3. ã€Œä¸Šæ›¸ããƒ¢ãƒ‡ãƒ«ã€ã‚ˆã‚Šå£Šã‚Œã«ãã„ã®ã‚’ç¢ºèªã™ã‚‹âœ…âœ¨

å®Ÿè¡Œã« `tsx` ã‚’ä½¿ã†ã¨TypeScriptã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã‚µã‚¯ãƒƒã¨å‹•ã‹ã›ã¾ã™âš¡([GitHub][3])
ãƒ†ã‚¹ãƒˆã¯ `Vitest` ãŒè»½ãã¦ç›¸æ€§ã‚ˆã„ã§ã™ğŸ§ªâœ¨ï¼ˆVitest 4.0ã®ãƒªãƒªãƒ¼ã‚¹ã‚‚å‡ºã¦ã„ã¾ã™ï¼‰([Vitest][4])
Node ã¯ v24 ãŒ Active LTS ã¨ã—ã¦æ¡ˆå†…ã•ã‚Œã¦ã„ã¾ã™ğŸ“Œ([Node.js][5])

---

### 20.5.1 è¿½åŠ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ğŸ“¦âœ¨

```bash
npm i -D typescript tsx vitest
```

---

### 20.5.2 ã‚¤ãƒ™ãƒ³ãƒˆå‹ã‚’ä½œã‚‹ğŸ“£ğŸ§©

`src/ch20/events.ts`

```ts
// src/ch20/events.ts
export type EventBase = {
  eventId: string;        // é‡è¤‡æ’é™¤ç”¨ï¼ˆã®ã¡ã®ç« ã®å†ªç­‰ã«ã‚‚ã¤ãªãŒã‚‹ã‚ˆğŸ§·ï¼‰
  occurredAt: string;     // ISOæ–‡å­—åˆ—
  orderId: string;
};

export type OrderPlaced = EventBase & {
  type: "OrderPlaced";
  items: Array<{ sku: string; qty: number; price: number }>;
};

export type TagAdded = EventBase & {
  type: "TagAdded";
  tag: string;
};

export type TagRemoved = EventBase & {
  type: "TagRemoved";
  tag: string;
};

export type PaymentAuthorized = EventBase & {
  type: "PaymentAuthorized";
  paymentId: string;
};

export type PaymentFailed = EventBase & {
  type: "PaymentFailed";
  reason: string;
};

export type Shipped = EventBase & {
  type: "Shipped";
  trackingNo: string;
};

export type OrderCanceled = EventBase & {
  type: "OrderCanceled";
  reason: string;
};

export type OrderEvent =
  | OrderPlaced
  | TagAdded
  | TagRemoved
  | PaymentAuthorized
  | PaymentFailed
  | Shipped
  | OrderCanceled;
```

---

### 20.5.3 ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã€Œè¿½è¨˜ã§ä¿å­˜ã€ã™ã‚‹ï¼ˆJSONLï¼‰ğŸ“ğŸ“š

`src/ch20/eventStore.ts`

```ts
// src/ch20/eventStore.ts
import { promises as fs } from "node:fs";
import path from "node:path";
import { OrderEvent } from "./events";

const dataDir = path.join(process.cwd(), "data");
const logPath = path.join(dataDir, "order-events.jsonl");

export async function appendEvent(ev: OrderEvent) {
  await fs.mkdir(dataDir, { recursive: true });
  const line = JSON.stringify(ev) + "\n";
  await fs.appendFile(logPath, line, "utf8");
}

export async function readAllEvents(): Promise<OrderEvent[]> {
  try {
    const raw = await fs.readFile(logPath, "utf8");
    return raw
      .split("\n")
      .filter(Boolean)
      .map((line) => JSON.parse(line) as OrderEvent);
  } catch (e: any) {
    if (e?.code === "ENOENT") return [];
    throw e;
  }
}
```

ãƒã‚¤ãƒ³ãƒˆã¯ã“ã‚Œã ã‘ã§ã™ğŸ‘‡ğŸ˜Š
**ã€Œä¸Šæ›¸ãã€ã˜ã‚ƒãªãã¦ã€èµ·ããŸã“ã¨ã‚’â€œè¿½è¨˜â€ã—ã¦ã„ãã ã‘**ğŸ“Œâœ¨

---

### 20.5.4 é›†è¨ˆï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ã§è¡¨ç¤ºç”¨ã®çŠ¶æ…‹ã‚’ä½œã‚‹ğŸ§®ğŸ‘€âœ¨

`src/ch20/projector.ts`

```ts
// src/ch20/projector.ts
import { OrderEvent } from "./events";

export type OrderView = {
  orderId: string;
  status:
    | "Pending"
    | "Paid"
    | "PaymentFailed"
    | "Shipped"
    | "Canceled";
  total: number;
  items: Array<{ sku: string; qty: number; price: number }>;
  tags: string[];
  timeline: Array<{ occurredAt: string; type: OrderEvent["type"]; note?: string }>;
};

function compareEvents(a: OrderEvent, b: OrderEvent) {
  // ã¾ãšæ™‚åˆ»ã§ä¸¦ã¹ã‚‹ï¼ˆåŒæ™‚åˆ»ãªã‚‰eventIdã§å®‰å®šåŒ–ï¼‰
  if (a.occurredAt < b.occurredAt) return -1;
  if (a.occurredAt > b.occurredAt) return 1;
  return a.eventId.localeCompare(b.eventId);
}

export function projectOrder(events: OrderEvent[], orderId: string): OrderView | null {
  const filtered = events.filter((e) => e.orderId === orderId);

  // é‡è¤‡æ’é™¤ï¼ˆåŒã˜eventIdãŒè¤‡æ•°å›æ¥ã¦ã‚‚1å›ã ã‘æ‰±ã†ğŸ§·ï¼‰
  const seen = new Set<string>();
  const deduped: OrderEvent[] = [];
  for (const e of filtered) {
    if (seen.has(e.eventId)) continue;
    seen.add(e.eventId);
    deduped.push(e);
  }

  deduped.sort(compareEvents);

  let status: OrderView["status"] = "Pending";
  let items: OrderView["items"] = [];
  let total = 0;

  // ã€Œã‚¿ã‚°ï¼é›†åˆã€è¡¨ç¾ï¼šSetã§æŒã£ã¦ã€è¡¨ç¤ºã™ã‚‹ã¨ãé…åˆ—ã«ã™ã‚‹ğŸ·ï¸âœ¨
  const tagSet = new Set<string>();

  const timeline: OrderView["timeline"] = [];

  for (const e of deduped) {
    timeline.push({ occurredAt: e.occurredAt, type: e.type });

    switch (e.type) {
      case "OrderPlaced": {
        items = e.items;
        total = e.items.reduce((sum, it) => sum + it.qty * it.price, 0);
        status = "Pending";
        break;
      }
      case "TagAdded": {
        tagSet.add(e.tag);
        break;
      }
      case "TagRemoved": {
        tagSet.delete(e.tag);
        break;
      }
      case "PaymentAuthorized": {
        // â€œæ”¯æ‰•ã„OKã«ãªã£ãŸâ€ã¨ã„ã†äº‹å®ŸãŒæ¥ãŸã‚‰Paidã«ã™ã‚‹ğŸ’³âœ…
        status = status === "Canceled" ? status : "Paid";
        break;
      }
      case "PaymentFailed": {
        status = status === "Canceled" ? status : "PaymentFailed";
        timeline[timeline.length - 1].note = e.reason;
        break;
      }
      case "Shipped": {
        status = status === "Canceled" ? status : "Shipped";
        timeline[timeline.length - 1].note = e.trackingNo;
        break;
      }
      case "OrderCanceled": {
        status = "Canceled";
        timeline[timeline.length - 1].note = e.reason;
        break;
      }
    }
  }

  // æ³¨æ–‡ãŒä¸€åº¦ã‚‚ä½œã‚‰ã‚Œã¦ãªã„ãªã‚‰è¡¨ç¤ºã—ãªã„
  if (!deduped.some((e) => e.type === "OrderPlaced")) return null;

  return {
    orderId,
    status,
    total,
    items,
    tags: [...tagSet].sort(),
    timeline,
  };
}
```

ã“ã“ã€ã‚ã¡ã‚ƒå¤§äº‹ğŸ‘€âœ¨

* **ä¿å­˜ã—ã¦ã‚‹ã®ã¯ â€œå‡ºæ¥äº‹ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆï¼‰â€**
* **ç”»é¢ã«å‡ºã™ â€œçŠ¶æ…‹â€ ã¯é›†è¨ˆã§ä½œã‚‹**

ã ã‹ã‚‰ã€ã‚ã¨ã§ã‚¤ãƒ™ãƒ³ãƒˆãŒå¢—ãˆã¦ã‚‚ã€**é›†è¨ˆã—ç›´ã›ã°æ•´åˆãŒå–ã‚Šã‚„ã™ã„**ã‚“ã§ã™ğŸ§ âœ¨

---

### 20.5.5 ãƒ‡ãƒ¢ï¼š2äººãŒåŒæ™‚ã«ã‚¿ã‚°ã‚’è¿½åŠ ã—ã¦ã‚‚æ¶ˆãˆãªã„ğŸğŸ·ï¸âœ¨

`src/ch20/demo.ts`

```ts
// src/ch20/demo.ts
import { appendEvent, readAllEvents } from "./eventStore";
import { projectOrder } from "./projector";
import { OrderEvent } from "./events";

const now = () => new Date().toISOString();
const id = () => crypto.randomUUID();

async function main() {
  const orderId = "ORD-1001";

  const events: OrderEvent[] = [
    {
      type: "OrderPlaced",
      eventId: id(),
      occurredAt: now(),
      orderId,
      items: [
        { sku: "COFFEE", qty: 1, price: 500 },
        { sku: "MUFFIN", qty: 2, price: 300 },
      ],
    },
    // Aã•ã‚“ï¼šSALEè¿½åŠ 
    { type: "TagAdded", eventId: id(), occurredAt: now(), orderId, tag: "SALE" },
    // Bã•ã‚“ï¼šGIFTè¿½åŠ ï¼ˆã»ã¼åŒæ™‚ï¼‰
    { type: "TagAdded", eventId: id(), occurredAt: now(), orderId, tag: "GIFT" },
    { type: "PaymentAuthorized", eventId: id(), occurredAt: now(), orderId, paymentId: "PAY-9" },
  ];

  for (const e of events) await appendEvent(e);

  const all = await readAllEvents();
  const view = projectOrder(all, orderId);

  console.log(view);
}

main().catch((e) => {
  console.error(e);
  process.exit(1);
});
```

å®Ÿè¡ŒğŸ‘‡

```bash
npx tsx src/ch20/demo.ts
```

æœŸå¾…ã™ã‚‹è¦‹ãŸç›®ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰ğŸ‘‡ğŸ˜Š

* `tags: ["GIFT","SALE"]` â† **ä¸¡æ–¹æ®‹ã‚‹**ğŸ‰
* `status: "Paid"` â† æ”¯æ‰•ã„ã‚¤ãƒ™ãƒ³ãƒˆã§å¤‰ã‚ã‚‹ğŸ’³âœ…

---

## 20.6 ã“ã“ãŒã€Œãƒãƒ¼ã‚¸ã—ã‚„ã™ã„ã€ç†ç”±ğŸ¤âœ¨

### é›†åˆã¯ã€Œåˆä½“ã€ã§ãã‚‹ğŸ§º

* Aãƒãƒ¼ãƒ‰ï¼š`{"SALE"}`
* Bãƒãƒ¼ãƒ‰ï¼š`{"GIFT"}`
* ãƒãƒ¼ã‚¸ï¼š`{"SALE","GIFT"}` ğŸ‰

ä¸Šæ›¸ãé…åˆ—ã¿ãŸã„ã«ã€Œæœ€å¾Œã®äººã ã‘å‹ã¤ã€ãŒèµ·ãã«ãã„ğŸ˜Œâœ¨

---

### ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€Œè¶³ã—ç®—ã€ã§ãã‚‹ğŸ“£

ã‚¤ãƒ™ãƒ³ãƒˆã¯åŸºæœ¬ â€œæ¶ˆã•ãªã„â€ ã‹ã‚‰ã€

* å—ã‘å–ã£ãŸã‚¤ãƒ™ãƒ³ãƒˆã‚’è¶³ã™ï¼ˆè¿½è¨˜ï¼‰
* ã‚ã¨ã§ã¾ã¨ã‚ã¦é›†è¨ˆã—ç›´ã™ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ï¼‰

ã“ã‚Œã§ã‚ºãƒ¬ã‚’åŸ‹ã‚ã‚„ã™ã„ã§ã™ğŸ§ âœ¨

---

## 20.7 ãƒ†ã‚¹ãƒˆï¼šã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ã‚‚åŒã˜è¡¨ç¤ºã«ãªã‚‹ï¼ŸğŸ§ªğŸ”€

`src/ch20/projector.test.ts`

```ts
import { describe, it, expect } from "vitest";
import { projectOrder } from "./projector";
import { OrderEvent } from "./events";

const ev = (partial: Omit<OrderEvent, "orderId" | "occurredAt" | "eventId"> & { orderId?: string; occurredAt?: string; eventId?: string }): OrderEvent => {
  return {
    orderId: partial.orderId ?? "ORD-1",
    occurredAt: partial.occurredAt ?? "2026-01-30T00:00:00.000Z",
    eventId: partial.eventId ?? crypto.randomUUID(),
    ...(partial as any),
  };
};

describe("Chapter20 projector", () => {
  it("ã‚¿ã‚°ã¯é›†åˆã¨ã—ã¦ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ï¼ˆä¸¡æ–¹æ®‹ã‚‹ï¼‰ğŸ·ï¸âœ¨", () => {
    const events: OrderEvent[] = [
      ev({ type: "OrderPlaced", items: [{ sku: "A", qty: 1, price: 100 }] }),
      ev({ type: "TagAdded", tag: "SALE" }),
      ev({ type: "TagAdded", tag: "GIFT" }),
    ];

    const view = projectOrder(events, "ORD-1")!;
    expect(view.tags.sort()).toEqual(["GIFT", "SALE"]);
  });

  it("åŒã˜eventIdãŒé‡è¤‡ã—ã¦ã‚‚1å›æ‰±ã„ï¼ˆé‡è¤‡æ’é™¤ï¼‰ğŸ§·", () => {
    const dupId = "E-dup";

    const events: OrderEvent[] = [
      ev({ type: "OrderPlaced", items: [{ sku: "A", qty: 1, price: 100 }] }),
      ev({ type: "TagAdded", tag: "SALE", eventId: dupId }),
      ev({ type: "TagAdded", tag: "SALE", eventId: dupId }), // ãƒªãƒˆãƒ©ã‚¤ã§2å›æ¥ãŸæƒ³å®š
    ];

    const view = projectOrder(events, "ORD-1")!;
    expect(view.tags).toEqual(["SALE"]);
  });

  it("ã‚¤ãƒ™ãƒ³ãƒˆãŒå¤šå°‘å…¥ã‚Œæ›¿ã‚ã£ã¦ã‚‚ï¼ˆæ™‚åˆ»ã§æ•´åˆ—ã§ãã‚‹ç¯„å›²ãªã‚‰ï¼‰çµæœãŒå®‰å®šã™ã‚‹ğŸ”€âœ¨", () => {
    const events: OrderEvent[] = [
      ev({ type: "OrderPlaced", items: [{ sku: "A", qty: 2, price: 100 }], occurredAt: "2026-01-30T00:00:01.000Z" }),
      ev({ type: "PaymentAuthorized", paymentId: "PAY-1", occurredAt: "2026-01-30T00:00:03.000Z" }),
      ev({ type: "TagAdded", tag: "GIFT", occurredAt: "2026-01-30T00:00:02.000Z" }),
    ];

    const shuffled = [events[2], events[0], events[1]];
    const view = projectOrder(shuffled, "ORD-1")!;

    expect(view.total).toBe(200);
    expect(view.status).toBe("Paid");
    expect(view.tags).toEqual(["GIFT"]);
  });
});
```

å®Ÿè¡ŒğŸ‘‡

```bash
npx vitest
```

---

## 20.8 ã‚ˆãã‚ã‚‹è½ã¨ã—ç©´ï¼ˆã§ã‚‚ä»Šã¯æ°—ã«ã—ã™ããªãã¦OKï¼‰ğŸ˜µâ€ğŸ’«âš ï¸

* ã‚¤ãƒ™ãƒ³ãƒˆãŒ**é€†é †ã§å±Šã**ï¼**åŒæ™‚åˆ»**ãŒå¤šã„ã¨ã€é †åºã§æ‚©ã‚€ğŸ”€
  â†’ ã“ã“ã¯ **å¾ŒåŠã®ã€Œé †åºãƒ»å› æœãƒ»CRDTã€**ã§ã¡ã‚ƒã‚“ã¨å¼·ããªã‚‹ã‚ˆğŸ’ªâœ¨
* ã€Œå‰Šé™¤ã€ã‚„ã€Œå–ã‚Šæ¶ˆã—ã€ã¯ **ã‚¤ãƒ™ãƒ³ãƒˆã§è¡¨ç¾**ã™ã‚‹ã®ãŒã‚³ãƒ„ğŸ§½

  * ä¾‹ï¼šã‚¿ã‚°ã‚’æ¶ˆã™ãªã‚‰ `TagRemoved`
  * æ³¨æ–‡ã‚’å–ã‚Šæ¶ˆã™ãªã‚‰ `OrderCanceled`

---

## 20.9 AIæ´»ç”¨ï¼šã‚¤ãƒ™ãƒ³ãƒˆå‘½åã‚’ä¸€æ°—ã«ä½œã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆğŸ¤–ğŸ·ï¸âœ¨

### å‘½åæ¡ˆã‚’å‡ºã—ã¦ã‚‚ã‚‰ã†ğŸ“

```text
åœ¨åº«ãƒ»æ³¨æ–‡ãƒ»æ±ºæ¸ˆã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã€Œèµ·ããŸäº‹å®Ÿã€ã‚’ã‚¤ãƒ™ãƒ³ãƒˆã¨ã—ã¦è¨­è¨ˆã—ãŸã„ã§ã™ã€‚
æ¬¡ã‚’æº€ãŸã™ã‚¤ãƒ™ãƒ³ãƒˆåï¼ˆè‹±èªPascalCaseï¼‰ã‚’20å€‹ææ¡ˆã—ã¦ã€‚

- æ³¨æ–‡ã®é–‹å§‹ã€æ”¯æ‰•ã„æˆåŠŸ/å¤±æ•—ã€åœ¨åº«ç¢ºä¿/å¤±æ•—ã€ç™ºé€ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€è¿”é‡‘
- â€œçŠ¶æ…‹â€ã§ã¯ãªãâ€œäº‹å®Ÿâ€ã«ãªã‚‹åå‰
- ãã‚Œãã‚Œã€Œã„ã¤ç™ºç”Ÿã™ã‚‹ã‹ã€ã¨ã€Œå«ã‚ã‚‹ã¹ããƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¾‹ã€ã‚‚æ·»ãˆã¦
```

### å¤‰ãªå‘½åã‚’å¼¾ããƒã‚§ãƒƒã‚¯ğŸ§ âœ…

```text
ä»¥ä¸‹ã®ã‚¤ãƒ™ãƒ³ãƒˆåä¸€è¦§ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ã€‚
ã€ŒçŠ¶æ…‹ã£ã½ã„/æ›–æ˜§/å®Ÿè£…ä¾å­˜ã€ã«ãªã£ã¦ã‚‹ã‚‚ã®ã‚’æŒ‡æ‘˜ã—ã¦ã€
ã‚ˆã‚Šâ€œäº‹å®Ÿâ€ã¨ã—ã¦è‰¯ã„åå‰ã«ç›´ã—ã¦ã€‚
ã•ã‚‰ã«ã€1ã‚¤ãƒ™ãƒ³ãƒˆã«ã¤ãpayloadã«æœ€ä½é™å…¥ã‚Œã‚‹ã¹ããƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ææ¡ˆã—ã¦ã€‚
```

---

## 20.10 ã“ã®ç« ã®ã¾ã¨ã‚ï¼ˆçµè«–1è¡Œï¼‰âœï¸âœ¨

**ä¸Šæ›¸ãã—ãªã„ã§ã€Œé›†åˆãƒ»å±¥æ­´ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆã€ã§è¡¨ç¾ã™ã‚‹ã¨ã€ã‚ã¨ã‹ã‚‰åˆä½“ï¼ˆãƒãƒ¼ã‚¸ï¼‰ã—ã‚„ã™ããªã£ã¦ã€æœ€çµ‚çš„æ•´åˆæ€§ã®ä¸–ç•Œã§å¼·ããªã‚‹ã‚ˆğŸ§©ğŸ¤âœ¨**

[1]: https://www.npmjs.com/package/typescript?utm_source=chatgpt.com "TypeScript"
[2]: https://devblogs.microsoft.com/typescript/progress-on-typescript-7-december-2025/?utm_source=chatgpt.com "Progress on TypeScript 7 - December 2025"
[3]: https://github.com/privatenumber/tsx?utm_source=chatgpt.com "privatenumber/tsx: âš¡ï¸ TypeScript Execute | The easiest ..."
[4]: https://vitest.dev/blog/vitest-4?utm_source=chatgpt.com "Vitest 4.0 is out!"
[5]: https://nodejs.org/en/about/previous-releases?utm_source=chatgpt.com "Node.js Releases"
