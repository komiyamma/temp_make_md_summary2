# ç¬¬31ç« ï¼šåˆ†æ•£ã£ã½ã„ãƒã‚°ã‚’æ•ã¾ãˆã‚‹ãƒ†ã‚¹ãƒˆï¼ˆæ•…éšœæ³¨å…¥ï¼‰ğŸ§ªğŸ²

## ã“ã®ç« ã§ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ âœ…âœ¨

* é…å»¶â³ãƒ»å¤±æ•—ğŸ’¥ãƒ»åˆ†æ–­ğŸ”Œãƒ»é‡è¤‡ğŸ“¨ãƒ»é †åºã‚ºãƒ¬ğŸ”€ ã‚’ **ãƒ†ã‚¹ãƒˆã§ã‚ã–ã¨èµ·ã“ã™**
* â€œå£Šã‚Œã‚‹ã®ãŒæ™®é€šâ€ãªçŠ¶æ³ã§ã‚‚è½ã¡ãªã„ã‚ˆã†ã« **ç›´ã™ãƒã‚¤ãƒ³ãƒˆãŒåˆ†ã‹ã‚‹**ğŸ› ï¸
* ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ãŒã‚ã‚‹ã®ã« **ãƒ†ã‚¹ãƒˆãŒãƒ•ãƒ¬ãƒ¼ã‚¯ï¼ˆãŸã¾ã«è½ã¡ã‚‹ï¼‰ã«ãªã‚‰ãªã„**ã‚³ãƒ„ãŒèº«ã«ã¤ãğŸ€

---

# 1) ã¾ãšå¤§äº‹ãªå‰æï¼šåˆ†æ•£ã£ã½ã„ãƒã‚°ã¯ã€Œå†ç¾ã§ããŸç¬é–“ã«å‹ã¡ã€ğŸ†ğŸ˜†

åˆ†æ•£ã®ã¤ã‚‰ã•ã¯ã€ã ã„ãŸã„ã“ã®5ã¤ã«é›†ç´„ã•ã‚Œã‚‹ã‚ˆğŸ‘‡

* é…å»¶ã™ã‚‹ï¼ˆã—ã‹ã‚‚æ¯å›é•ã†ï¼‰ğŸ¢âš¡
* ãŸã¾ã«å¤±æ•—ã™ã‚‹ï¼ˆã—ã‹ã‚‚é€”ä¸­ã¾ã§æˆåŠŸã—ã¦ãŸã‚Šã™ã‚‹ï¼‰ğŸ’¥
* åˆ†æ–­ã™ã‚‹ï¼ˆç‰‡æ–¹ã ã‘è¦‹ãˆã¦ã‚‹ä¸–ç•Œï¼‰ğŸ”ŒğŸŒ
* åŒã˜ã‚‚ã®ãŒè¤‡æ•°å›æ¥ã‚‹ï¼ˆå†é€ãƒ»ãƒªãƒˆãƒ©ã‚¤ã®å‰¯ä½œç”¨ï¼‰ğŸ“¨ğŸ“¨ğŸ“¨
* é †åºãŒå…¥ã‚Œæ›¿ã‚ã‚‹ï¼ˆâ€œå…ˆã«æ¥ã‚‹ã¯ãšâ€ãŒå´©ã‚Œã‚‹ï¼‰ğŸ”€ğŸ˜µâ€ğŸ’«

ã ã‹ã‚‰ãƒ†ã‚¹ãƒˆã®ã‚´ãƒ¼ãƒ«ã¯ã‚·ãƒ³ãƒ—ãƒ«ğŸ‘‡
**ã€Œãã®5ã¤ã‚’ãƒ†ã‚¹ãƒˆã§å†ç¾ã—ã¦ã€è½ã¡ãªã„ä»•æ§˜ã«ç›´ã™ã€**ğŸ§ªâ¡ï¸ğŸ› ï¸â¡ï¸âœ…

---

# 2) æ•…éšœæ³¨å…¥ï¼ˆFault Injectionï¼‰ã£ã¦ãªã«ï¼ŸğŸ²ğŸ§ª

ã‚ã–ã¨â€œæ‚ªã„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã£ã½ã•â€ã‚’å…¥ã‚Œã‚‹ã“ã¨ã ã‚ˆï¼

## ä»Šå›å…¥ã‚ŒãŸã„æ•…éšœãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆæœ€å°ã‚»ãƒƒãƒˆï¼‰ğŸ§°âœ¨

1. **ãƒ©ãƒ³ãƒ€ãƒ é…å»¶** â³ï¼ˆ0ã€œ500msã¿ãŸã„ã«ãƒ–ãƒ¬ã‚‹ï¼‰
2. **ãƒ©ãƒ³ãƒ€ãƒ å¤±æ•—** ğŸ’¥ï¼ˆä¸€å®šç¢ºç‡ã§ã‚¨ãƒ©ãƒ¼ã«ã™ã‚‹ï¼‰
3. **åˆ†æ–­ï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ï¼‰** ğŸ”Œï¼ˆé€ã£ãŸã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¨ã¦ã‚‹ï¼‰
4. **é‡è¤‡é…é”** ğŸ“¨ï¼ˆåŒã˜ã‚¤ãƒ™ãƒ³ãƒˆã‚’2ã€œ3å›æµã™ï¼‰
5. **é †åºã‚·ãƒ£ãƒƒãƒ•ãƒ«** ğŸ”€ï¼ˆã‚­ãƒ¥ãƒ¼ã§ä¸¦ã³æ›¿ãˆã¦å±Šã‘ã‚‹ï¼‰

---

# 3) æ–¹é‡ï¼šã‚¢ãƒ—ãƒªæœ¬ä½“ã‚’æ±šã•ãšã€ãƒ†ã‚¹ãƒˆå´ã‹ã‚‰â€œæ•…éšœã‚¹ã‚¤ãƒƒãƒâ€ã‚’å·®ã—è¾¼ã‚€ğŸ›ï¸âœ¨

ãŠã™ã™ã‚ã¯ã“ã®2ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ä½œã‚‹ã“ã¨ğŸ‘‡

* **(A) ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£å±¤**ï¼šé…å»¶/å¤±æ•—/é‡è¤‡/é †åºã‚ºãƒ¬ã‚’ä½œã‚‹éƒ¨å“ğŸ§©
* **(B) ä½¿ã†å ´æ‰€**ï¼šHTTPå‘¼ã³å‡ºã—ã€ã‚­ãƒ¥ãƒ¼ã€DBã‚¢ã‚¯ã‚»ã‚¹â€¦ã®â€œå¢ƒç•Œâ€ã«å·®ã—è¾¼ã‚€ğŸšª

ç‰¹ã«ãƒ†ã‚¹ãƒˆã§åŠ¹ãå¢ƒç•Œã¯ã“ã®3ã¤ğŸ‘‡

* API â†’ Worker ã¸ã®ã€Œã‚¤ãƒ™ãƒ³ãƒˆ/ã‚¸ãƒ§ãƒ–æŠ•å…¥ã€ğŸ“®
* Worker â†’ DB ã®ã€Œæ›´æ–°ã€ğŸ—ƒï¸
* API â†’ å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®ã€ŒHTTPã€ğŸŒï¼ˆå¤–éƒ¨ã¯ãƒ¢ãƒƒã‚¯ã—ã‚„ã™ã„ï¼‰

---

# 4) ãƒãƒ³ã‚ºã‚ªãƒ³â‘ ï¼šæ•…éšœæ³¨å…¥ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ä½œã‚‹ğŸ§°ğŸ²

## 4-1. â€œãƒ†ã‚¹ãƒˆå°‚ç”¨ã®æ•…éšœè¨­å®šâ€ã‚’ç”¨æ„ã™ã‚‹ğŸ›ï¸

ãƒ†ã‚¹ãƒˆä¸­ã ã‘ONã«ã—ãŸã„ã®ã§ã€è¨­å®šã¯ **1ã¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ** ã«ã¾ã¨ã‚ã‚‹ã®ãŒæ¥½ã ã‚ˆğŸ˜Š

```ts
// test/faults/faultConfig.ts
export type FaultConfig = {
  enabled: boolean;

  // é…å»¶
  delayMsMin: number;
  delayMsMax: number;

  // å¤±æ•—ï¼ˆ0.0ã€œ1.0ï¼‰
  failRate: number;

  // åˆ†æ–­ï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ï¼‰
  dropRate: number;

  // é‡è¤‡é…é”
  duplicateRate: number;

  // é †åºã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆã‚­ãƒ¥ãƒ¼å´ã§ä½¿ã†æƒ³å®šï¼‰
  shuffleRate: number;

  // ãƒ†ã‚¹ãƒˆã‚’å†ç¾ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã® seed
  seed: number;
};

export const defaultFaultConfig: FaultConfig = {
  enabled: false,
  delayMsMin: 0,
  delayMsMax: 0,
  failRate: 0,
  dropRate: 0,
  duplicateRate: 0,
  shuffleRate: 0,
  seed: 1,
};
```

## 4-2. â€œseedä»˜ãç–‘ä¼¼ä¹±æ•°â€ã§ãƒ†ã‚¹ãƒˆã‚’å®‰å®šã•ã›ã‚‹ğŸ€ğŸ¯

`Math.random()`ã®ã¾ã¾ã ã¨ã€ŒãŸã¾ã«è½ã¡ã‚‹ã€åœ°ç„ã«ãªã‚ŠãŒã¡ğŸ˜‡
ãªã®ã§ã€**ç°¡å˜ãªseedä»˜ãPRNG**ã‚’è‡ªå‰ã§ç”¨æ„ã—ã‚ˆã†ï¼

```ts
// test/faults/prng.ts
export class PRNG {
  private state: number;

  constructor(seed: number) {
    this.state = seed >>> 0;
  }

  // 0.0 <= x < 1.0
  nextFloat(): number {
    // LCG (è¶…ç°¡æ˜“) : ãƒ†ã‚¹ãƒˆç”¨é€”ãªã‚‰ã“ã‚Œã§ååˆ†
    this.state = (1664525 * this.state + 1013904223) >>> 0;
    return this.state / 0x100000000;
  }

  nextInt(min: number, max: number): number {
    const f = this.nextFloat();
    return Math.floor(min + f * (max - min + 1));
  }
}
```

## 4-3. é…å»¶ãƒ»å¤±æ•—ãƒ»ãƒ‰ãƒ­ãƒƒãƒ—ãƒ»é‡è¤‡ã‚’â€œ1ã‹æ‰€ã§â€é©ç”¨ã™ã‚‹ğŸ²

ã€Œé€ã‚‹ç›´å‰ã€ã«å·®ã—è¾¼ã‚€ã®ãŒã„ã¡ã°ã‚“åˆ†ã‹ã‚Šã‚„ã™ã„ã‚ˆğŸ“®âœ¨

```ts
// test/faults/applyFaults.ts
import { FaultConfig } from "./faultConfig";
import { PRNG } from "./prng";

export type FaultResult<T> =
  | { type: "dropped" }
  | { type: "ok"; items: T[] };

const sleep = (ms: number) => new Promise<void>(r => setTimeout(r, ms));

export async function applyFaults<T>(
  config: FaultConfig,
  prng: PRNG,
  item: T
): Promise<FaultResult<T>> {
  if (!config.enabled) return { type: "ok", items: [item] };

  // é…å»¶
  const delay = prng.nextInt(config.delayMsMin, config.delayMsMax);
  if (delay > 0) await sleep(delay);

  // å¤±æ•—ï¼ˆä¾‹å¤–ã«ã™ã‚‹ï¼‰
  if (prng.nextFloat() < config.failRate) {
    throw new Error("Injected fault: random failure ğŸ’¥");
  }

  // ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆåˆ†æ–­ã£ã½ã„ï¼‰
  if (prng.nextFloat() < config.dropRate) {
    return { type: "dropped" };
  }

  // é‡è¤‡é…é”ï¼ˆåŒã˜ã‚‚ã®ã‚’ã‚‚ã†ä¸€å›ï¼‰
  if (prng.nextFloat() < config.duplicateRate) {
    return { type: "ok", items: [item, item] };
  }

  return { type: "ok", items: [item] };
}
```

---

# 5) ãƒãƒ³ã‚ºã‚ªãƒ³â‘¡ï¼šã‚­ãƒ¥ãƒ¼ã«â€œæ•…éšœæ³¨å…¥ç‰ˆãƒ©ãƒƒãƒ‘ãƒ¼â€ã‚’ã‹ã¶ã›ã‚‹ğŸ“®ğŸ²

APIâ†’Workerã®å¢ƒç•Œã¯ã‚­ãƒ¥ãƒ¼ãŒå¤šã„ã®ã§ã€ã“ã“ã«å…¥ã‚Œã‚‹ã¨ã‚ã¡ã‚ƒåŠ¹ãï¼âœ¨

## 5-1. InMemoryQueueï¼ˆä¾‹ï¼‰ã«ã€ãƒ‰ãƒ­ãƒƒãƒ—/é‡è¤‡/é †åºã‚ºãƒ¬ã‚’å…¥ã‚Œã‚‹ğŸ”€ğŸ“¨

```ts
// test/faults/faultyQueue.ts
import { FaultConfig } from "./faultConfig";
import { PRNG } from "./prng";
import { applyFaults } from "./applyFaults";

export type Queue<T> = {
  push(item: T): Promise<void>;
  pop(): Promise<T | undefined>;
  size(): number;
};

export function createFaultyQueue<T>(
  base: Queue<T>,
  config: FaultConfig
): Queue<T> {
  const prng = new PRNG(config.seed);

  return {
    async push(item) {
      const r = await applyFaults(config, prng, item);
      if (r.type === "dropped") return;

      // é‡è¤‡ã®å¯èƒ½æ€§ã‚’å«ã‚€ items ã‚’æŠ•å…¥
      for (const it of r.items) {
        await base.push(it);
      }

      // ãŸã¾ã«é †åºã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆã‚­ãƒ¥ãƒ¼ã®ä¸­èº«ã‚’æ··ãœã‚‹ï¼‰
      if (config.enabled && prng.nextFloat() < config.shuffleRate) {
        // baseãŒInMemoryå®Ÿè£…ãªã‚‰ â€œä¸­èº«ã‚’å–ã‚Šå‡ºã—ã¦æ··ãœã¦æˆ»ã™â€ ãŒã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¨â—
        // ã“ã“ã§ã¯ã€Œã‚·ãƒ£ãƒƒãƒ•ãƒ«ã§ãã‚‹baseã€ã‚’æ¸¡ã™å‰æã«ã—ã¦ã‚‚OKï¼ˆå®Ÿè£…ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ã¦ã­ï¼‰
      }
    },
    pop: base.pop,
    size: base.size,
  };
}
```

> ãƒã‚¤ãƒ³ãƒˆğŸ’¡
> â€œåˆ†æ•£ã£ã½ã„â€ã¯ **å¢ƒç•Œã«å…¥ã‚Œã‚‹**ã®ãŒã‚³ãƒ„ã€‚å†…éƒ¨ãƒ­ã‚¸ãƒƒã‚¯ã«ãƒ©ãƒ³ãƒ€ãƒ ã‚’å…¥ã‚Œã‚‹ã¨ãƒ†ã‚¹ãƒˆãŒèª­ã¿ã«ãããªã‚‹ã‚ˆğŸ˜µâ€ğŸ’«

---

# 6) ãƒãƒ³ã‚ºã‚ªãƒ³â‘¢ï¼šãƒ†ã‚¹ãƒˆåŸºç›¤ï¼ˆVitest + MSWï¼‰ã‚’æ•´ãˆã‚‹ğŸ§ªğŸ§°

HTTPãƒ¢ãƒƒã‚¯ã¯ **MSW** ãŒå®šç•ªãƒ«ãƒ¼ãƒˆã ã‚ˆâœ¨
Vitestå…¬å¼ã§ã‚‚ã€Œãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ¢ãƒƒã‚¯ã«MSWãŒãŠã™ã™ã‚ã€ã£ã¦æ›¸ã‹ã‚Œã¦ã‚‹ğŸ“([Vitest][1])
MSWã¯Nodeç’°å¢ƒã§HTTP/HTTPSãªã©ã‚’ãƒ‘ãƒƒãƒã—ã¦å¤–å‘ãé€šä¿¡ã‚’è¦³æ¸¬ãƒ»åˆ¶å¾¡ã§ãã‚‹ã‚ˆ([Mock Service Worker][2])
Vitestã®å°å…¥/åŸºæœ¬ã‚‚å…¬å¼ã‚¬ã‚¤ãƒ‰ãŒåˆ†ã‹ã‚Šã‚„ã™ã„ã‚ˆ([Vitest][3])

## 6-1. MSWï¼ˆNodeï¼‰æœ€å°ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¾‹ ğŸ§ªğŸŒ

```ts
// test/msw/server.ts
import { setupServer } from "msw/node";
import { http, HttpResponse, delay } from "msw";

export const server = setupServer(
  http.post("https://payments.example/charge", async () => {
    await delay(200); // é…å»¶ã‚‚å…¥ã‚Œã‚‰ã‚Œã‚‹
    return HttpResponse.json({ ok: true, paymentId: "p_123" });
  })
);
```

```ts
// test/setup.ts
import { beforeAll, afterAll, afterEach } from "vitest";
import { server } from "./msw/server";

beforeAll(() => server.listen({ onUnhandledRequest: "error" }));
afterEach(() => server.resetHandlers());
afterAll(() => server.close());
```

> MSW + Vitestã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ã¯ã€MSWå…¬å¼ã®Quick startã§ã‚‚æ¡ˆå†…ã•ã‚Œã¦ã‚‹ã‚ˆ([Mock Service Worker][4])

---

# 7) â€œåˆ†æ•£ã£ã½ã„ãƒã‚°â€ã‚’æ•ã¾ãˆã‚‹ãƒ†ã‚¹ãƒˆè¨­è¨ˆï¼ˆå‹ï¼‰ğŸ“âœ¨

## ãƒ†ã‚¹ãƒˆã¯3æ®µéšã«åˆ†ã‘ã‚‹ã¨ãƒ©ã‚¯ã ã‚ˆğŸ˜Š

1. **ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ**ï¼šå°ã•ã„é–¢æ•°ï¼ˆå†ªç­‰ã‚­ãƒ¼ç”Ÿæˆã€çŠ¶æ…‹é·ç§»ï¼‰ğŸ§©
2. **ãƒ—ãƒ­ã‚»ã‚¹å†…çµ±åˆãƒ†ã‚¹ãƒˆ**ï¼šAPIâ†’Queueâ†’Workerâ†’DBã‚’â€œåŒä¸€ãƒ—ãƒ­ã‚»ã‚¹ã§â€å†ç¾ğŸ“¦
3. **æ€§è³ªï¼ˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼‰ãƒ†ã‚¹ãƒˆ**ï¼šã„ã‚ã‚“ãªå…¥åŠ›ã¨é †åºã§ã€Œå£Šã‚Œãªã„æ€§è³ªã€ã‚’æ¤œè¨¼ğŸŒ€

Property-based testing ã‚’ã‚„ã‚‹ãªã‚‰ **fast-check** ãŒå®šç•ªã§ã€JS/TSã§ä½¿ãˆã‚‹ã‚ˆ([fast-check.dev][5])

---

# 8) ãƒãƒ³ã‚ºã‚ªãƒ³â‘£ï¼šæ•…éšœæ³¨å…¥ONã§ã‚‚è½ã¡ãªã„çµ±åˆãƒ†ã‚¹ãƒˆã‚’æ›¸ã“ã†ğŸ§ªğŸ”¥

## 8-1. ã¾ãšã¯â€œå®ˆã‚ŠãŸã„æ€§è³ªâ€ã‚’1è¡Œã§æ›¸ãâœï¸âœ¨

ä¾‹ï¼ˆæ³¨æ–‡ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰ğŸ‘‡

* **åŒã˜æ³¨æ–‡ã‚¤ãƒ™ãƒ³ãƒˆãŒè¤‡æ•°å›å±Šã„ã¦ã‚‚ã€åœ¨åº«ã¯1å›åˆ†ã—ã‹æ¸›ã‚‰ãªã„**ğŸ§·âœ…
* **æ”¯æ‰•ã„æˆåŠŸã‚¤ãƒ™ãƒ³ãƒˆãŒå…ˆã«æ¥ã¦ã‚‚ã€æœ€çµ‚çš„ã«æ³¨æ–‡ãŒç¢ºå®šã§ãã‚‹ï¼ˆã¾ãŸã¯å†è©¦è¡Œã•ã‚Œã‚‹ï¼‰**ğŸ”€âœ…
* **ä¸€æ™‚çš„ã«ã‚­ãƒ¥ãƒ¼ãŒè½ã¡ã¦ã‚‚ã€å¾©å¸°å¾Œã«åæŸã™ã‚‹**ğŸ”Œâ¡ï¸âœ…

## 8-2. ä¾‹ï¼šé‡è¤‡é…é”ã§ã‚‚åœ¨åº«ãŒäºŒé‡ã«æ¸›ã‚‰ãªã„ãƒ†ã‚¹ãƒˆğŸ“¨ğŸ§ª

```ts
// test/order.duplicates.test.ts
import { describe, it, expect } from "vitest";
import { defaultFaultConfig } from "./faults/faultConfig";
import { createFaultyQueue } from "./faults/faultyQueue";

// ä¾‹ï¼šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå´ã®é–¢æ•°ï¼ˆä»®ï¼‰
// - apiPlaceOrder: æ³¨æ–‡å—ä»˜ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’push
// - workerDrainOnce: ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å–ã‚Šå‡ºã—ã¦1ä»¶å‡¦ç†
// - readInventory: åœ¨åº«æ•°ã‚’èª­ã‚€
import { createInMemoryQueue } from "../src/infra/inMemoryQueue";
import { createApp } from "../src/app/createApp";

describe("é‡è¤‡é…é”ã§ã‚‚å£Šã‚Œãªã„ï¼ˆå†ªç­‰ï¼‰ğŸ§·", () => {
  it("åŒã˜ã‚¤ãƒ™ãƒ³ãƒˆãŒ2å›å±Šã„ã¦ã‚‚åœ¨åº«ã¯1å›ã—ã‹æ¸›ã‚‰ãªã„ğŸ“¦", async () => {
    const baseQueue = createInMemoryQueue<any>();
    const faultConfig = {
      ...defaultFaultConfig,
      enabled: true,
      duplicateRate: 1.0, // å¿…ãšé‡è¤‡ã•ã›ã‚‹
      seed: 42,
    };

    const queue = createFaultyQueue(baseQueue, faultConfig);
    const app = createApp({ queue }); // queueã‚’DIã§ãã‚‹è¨­è¨ˆãŒæœ€é«˜âœ¨

    const before = await app.readInventory("item_apple");
    await app.apiPlaceOrder({ orderId: "o_1", itemId: "item_apple", qty: 1 });

    // Workerã‚’2å›å›ã—ã¦ã‚‚ï¼ˆé‡è¤‡åˆ†ãŒã‚ã£ã¦ã‚‚ï¼‰çµæœã¯1å›åˆ†
    await app.workerDrainOnce();
    await app.workerDrainOnce();

    const after = await app.readInventory("item_apple");
    expect(after).toBe(before - 1);
  });
});
```

> ã“ã“ã§è½ã¡ãŸã‚‰ğŸ¯
> ã€Œã‚¤ãƒ™ãƒ³ãƒˆã®å†ªç­‰å‡¦ç†ï¼ˆé‡è¤‡æ’é™¤ï¼‰ã€ãŒè¶³ã‚Šã¦ãªã„ã‚µã‚¤ãƒ³ã ã‚ˆğŸ˜±
> æ¬¡ã®ç¯€ã®â€œç›´ã—æ–¹ãƒ†ãƒ³ãƒ—ãƒ¬â€ã§æ²»ã›ã‚‹ï¼

---

# 9) ã‚ˆãè½ã¡ã‚‹ã¨ã“ã‚ã®â€œç›´ã—æ–¹ãƒ†ãƒ³ãƒ—ãƒ¬â€ğŸ› ï¸ğŸ’–

## 9-1. é‡è¤‡é…é”ã§äºŒé‡åæ˜ ã™ã‚‹ â†’ **å‡¦ç†æ¸ˆã¿ã‚¤ãƒ™ãƒ³ãƒˆIDã‚’ä¿å­˜ã™ã‚‹**ğŸ§·

* Workerå´ã§ `eventId` ã‚’å¿…ãšæŒã¤
* **å‡¦ç†æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—**ï¼ˆDBã«è¨˜éŒ²ãŒç†æƒ³ï¼‰

```ts
// src/domain/processedEventStore.tsï¼ˆä¾‹ï¼‰
export interface ProcessedEventStore {
  has(eventId: string): Promise<boolean>;
  mark(eventId: string): Promise<void>;
}

// Workerã®å‡¦ç†ï¼ˆä¾‹ï¼‰
export async function handleEvent(event: { eventId: string; type: string }, store: ProcessedEventStore) {
  if (await store.has(event.eventId)) return; // âœ… é‡è¤‡æ’é™¤

  // ã“ã“ã§åœ¨åº«æ¸›ç®—ãªã©ã®å‰¯ä½œç”¨
  // ...

  await store.mark(event.eventId);
}
```

## 9-2. é †åºã‚ºãƒ¬ã§å£Šã‚Œã‚‹ â†’ **çŠ¶æ…‹æ©Ÿæ¢°ï¼ˆState Machineï¼‰ã§ã‚¬ãƒ¼ãƒ‰ã™ã‚‹**ğŸ”€ğŸ§ 

ã€Œä»Šãã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’é©ç”¨ã—ã¦ã„ã„çŠ¶æ…‹ï¼Ÿã€ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€ãƒ€ãƒ¡ãªã‚‰å†è©¦è¡Œã¸ğŸ”
ï¼ˆä¾‹ï¼šOrderCreatedå‰ã«PaymentConfirmedãŒæ¥ãŸï¼‰

* å—ã‘ã‚‰ã‚Œãªã„ãªã‚‰

  * **ä¿ç•™ï¼ˆpendingï¼‰ã«ç©ã‚€**ğŸ“¥
  * **å†å–å¾—ãƒ»å†è©¦è¡Œ**ğŸ”
  * **DLQï¼ˆéš”é›¢ï¼‰ã¸**ğŸ—‘ï¸ï¼ˆæ¬¡ç« ä»¥é™ã®é‹ç”¨ã§ã‚‚ä½¿ã†ï¼‰

## 9-3. åˆ†æ–­ï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ï¼‰ã§åæŸã—ãªã„ â†’ **å†é€/å†åŒæœŸã®é“ã‚’ç”¨æ„ã™ã‚‹**ğŸ”Œâ¡ï¸âœ…

* ã‚­ãƒ¥ãƒ¼ãŒè½ã¡ã¦ã‚‚ã€Œã„ã¤ã‹è¿½ã„ã¤ã‘ã‚‹ã€ãƒ«ãƒ¼ãƒˆãŒå¿…è¦
* ä¾‹ï¼š

  * å®šæœŸçš„ã«ã€Œæœªç¢ºå®šæ³¨æ–‡ã€ã‚’å†èµ°æŸ»ã—ã¦è£œæ­£ã™ã‚‹ğŸ§¹
  * â€œã‚¤ãƒ™ãƒ³ãƒˆã‚’å–ã‚Šã“ã¼ã—ãŸâ€å‰æã§ **æ•´åˆæ€§å›å¾©ã‚¸ãƒ§ãƒ–**ã‚’ä½œã‚‹ğŸ§°

---

# 10) â€œãƒ©ãƒ³ãƒ€ãƒ â€ã¨ä»²è‰¯ãã—ã¦ãƒ†ã‚¹ãƒˆã‚’ãƒ•ãƒ¬ãƒ¼ã‚¯ã«ã—ãªã„ã‚³ãƒ„ğŸ€ğŸ˜†

* ãƒ©ãƒ³ãƒ€ãƒ ã¯ **seedå›ºå®š**ï¼ˆã“ã®ç« ã§ã‚„ã£ãŸPRNGæ–¹å¼ãŒå¼·ã„ï¼‰ğŸ¯
* ã€Œç¢ºç‡ã€ã«é ¼ã‚‰ãšã€**ç¢ºå®Ÿã«èµ·ã“ã™ï¼ˆfailRate=1.0ãªã©ï¼‰** ãƒ†ã‚¹ãƒˆã‚‚ä½œã‚‹ğŸ’¥
* å£Šã‚Œæ–¹ã‚’å¢—ã‚„ã™æ™‚ã¯ã€1å›ã«å…¨éƒ¨ç››ã‚Šã—ãªã„ã§ **1ç¨®é¡ãšã¤**ğŸ‘¶âœ¨
* å¤±æ•—ã—ãŸã‚‰ â€œã©ã®æ•…éšœè¨­å®šã ã£ãŸã‹â€ ã‚’ãƒ­ã‚°ã«å‡ºã™ğŸ“‹ğŸ•µï¸â€â™€ï¸

---

# 11) ã‚‚ã†ä¸€æ­©ï¼šæ€§è³ªãƒ†ã‚¹ãƒˆï¼ˆfast-checkï¼‰ã§â€œæƒ³å®šå¤–â€ã‚’æ‹¾ã†ğŸŒ€ğŸ”

ä¾‹ï¼šã€Œã‚¤ãƒ™ãƒ³ãƒˆãŒã©ã‚“ãªé †åºã§æ¥ã¦ã‚‚ã€æœ€çµ‚çš„ã«åœ¨åº«ãŒãƒã‚¤ãƒŠã‚¹ã«ãªã‚‰ãªã„ã€ã¿ãŸã„ãªâ€œæ€§è³ªâ€ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚„ã¤ã ã‚ˆğŸ˜Š
fast-check ã¯JS/TSã®Property-based Testingãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã—ã¦å®šç•ªã ã‚ˆ([fast-check.dev][5])

ï¼ˆã“ã“ã¯æœ€åˆã¯ç„¡ç†ã—ãªãã¦OKï¼ã§ã‚‚ä¸€åº¦ã‚„ã‚‹ã¨ä¸–ç•ŒãŒåºƒãŒã‚‹ğŸŒˆï¼‰

---

# 12) AIã®ä½¿ã„ã©ã“ã‚ï¼ˆã“ã®ç« å‘ãï¼‰ğŸ¤–âœ…

## 12-1. ãƒ†ã‚¹ãƒˆè¦³ç‚¹ã®æ´—ã„å‡ºã—ï¼ˆæœ€å¼·ï¼‰ğŸ“âœ¨

Copilot/Codexã«ã“ã‚“ãªæ„Ÿã˜ã§é ¼ã‚€ã¨è‰¯ã„ã‚ˆğŸ‘‡

* ã€Œæ³¨æ–‡ã€œåœ¨åº«åæ˜ ã¾ã§ã®æµã‚Œã§ã€é…å»¶/å¤±æ•—/é‡è¤‡/é †åºã‚ºãƒ¬/ãƒ‰ãƒ­ãƒƒãƒ—ãŒèµ·ããŸã¨ãã®ãƒã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ—æŒ™ã—ã¦ã€ğŸ§ 
* ã€Œå„ãƒã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å†ç¾ã™ã‚‹æœ€å°ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æ¡ˆã‚’å‡ºã—ã¦ã€ğŸ§ª

## 12-2. â€œè½ã¡ãŸåŸå› ã®æ¨ç†â€ã‚’æ‰‹ä¼ã‚ã›ã‚‹ğŸ•µï¸â€â™€ï¸

* ã€Œã“ã®ãƒ­ã‚°ã‹ã‚‰ã€é‡è¤‡é…é”ã§äºŒé‡æ¸›ç®—ã—ã¦ã‚‹å¯èƒ½æ€§ã‚ã‚‹ï¼Ÿã€ã¿ãŸã„ã«èãã¨é€Ÿã„âš¡

---

# 13) ç™ºå±•ï¼šæœ¬ç‰©ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³ã‚’E2Eã§è©¦ã—ãŸã„äººã¸ğŸŒğŸ”¥

æœ¬æ°—ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ•…éšœï¼ˆé…å»¶ã€åˆ‡æ–­ã€å¸¯åŸŸåˆ¶é™ãªã©ï¼‰ã‚’â€œãƒ—ãƒ­ã‚­ã‚·ã§æ³¨å…¥â€ã™ã‚‹ãªã‚‰ **Toxiproxy** ã¿ãŸã„ãªé“å…·ãŒã‚ã‚‹ã‚ˆğŸ§ªğŸ”Œï¼ˆShopifyã®OSSï¼‰([GitHub][6])
ã“ã®ç« ã§ã¯ã€Œã¾ãšãƒ—ãƒ­ã‚»ã‚¹å†…ã§å†ç¾ã§ãã‚‹ã€ãŒã‚´ãƒ¼ãƒ«ã ã‹ã‚‰ã€ä½™è£•ãŒå‡ºãŸã‚‰ã§OKğŸ˜Šâœ¨

---

# ã“ã®ç« ã®çµè«–1è¡Œ âœï¸âœ¨

**åˆ†æ•£ã£ã½ã„ãƒã‚°ã¯ â€œæ•…éšœã‚’èµ·ã“ã™ãƒ†ã‚¹ãƒˆâ€ ã‚’æŒã£ãŸç¬é–“ã‹ã‚‰ã€æ€–ã•ãŒåŠåˆ†ã«ãªã‚‹ã‚ˆğŸ§ªğŸ²â¡ï¸âœ…**

[1]: https://vitest.dev/guide/mocking/requests?utm_source=chatgpt.com "Mocking Requests"
[2]: https://mswjs.io/docs/integrations/node/?utm_source=chatgpt.com "Node.js integration"
[3]: https://vitest.dev/guide/?utm_source=chatgpt.com "Getting Started | Guide"
[4]: https://mswjs.io/docs/quick-start/?utm_source=chatgpt.com "Quick start"
[5]: https://fast-check.dev/?utm_source=chatgpt.com "fast-check official documentation | fast-check"
[6]: https://github.com/Shopify/toxiproxy?utm_source=chatgpt.com "Shopify/toxiproxy: :alarm_clock: A TCP proxy to simulate ..."
