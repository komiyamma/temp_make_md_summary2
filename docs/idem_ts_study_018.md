# ç¬¬18ç« ï¼šå¤±æ•—ã¯ã©ã†æ‰±ã†ï¼Ÿï¼ˆãƒªãƒˆãƒ©ã‚¤OK/NGã®åˆ†é¡ï¼‰âœ…âŒ

## ã“ã®ç« ã§ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ ğŸ¯âœ¨

* ã€Œå¤±æ•—ã€ã‚’ **ãƒªãƒˆãƒ©ã‚¤ã—ã¦ã„ã„ã‚‚ã®**ï¼**ã—ã¡ã‚ƒãƒ€ãƒ¡ãªã‚‚ã®** ã«åˆ†ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ ğŸ™†â€â™€ï¸ğŸ™…â€â™€ï¸
* **HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹** ã¨ **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¤±æ•—** ã‚’è¦‹ã¦ã€æ¬¡ã®ä¸€æ‰‹ï¼ˆå¾…ã¤/è«¦ã‚ã‚‹/ç¢ºèªã™ã‚‹ï¼‰ã‚’æ±ºã‚ã‚‰ã‚Œã‚‹ ğŸ”ğŸ§ 
* TypeScriptã§ã€Œãƒªãƒˆãƒ©ã‚¤ã®å‹ã€ã‚’ä½œã£ã¦ã€äº‹æ•…ã‚Šã«ãã„é€šä¿¡ã‚’å®Ÿè£…ã§ãã‚‹ ğŸ’»ğŸ”

---

## 18.1 ã€Œå¤±æ•—ã€ã¯ãœã‚“ã¶åŒã˜ã˜ã‚ƒãªã„ ğŸ˜µâ€ğŸ’«â¡ï¸ğŸ§©

å¤±æ•—ã«ã¯ã–ã£ãã‚Š3ç¨®é¡ã‚ã‚‹ã‚ˆã€œï¼ğŸ€

### â‘  ä¸€æ™‚çš„ãªå¤±æ•—ï¼ˆãƒªãƒˆãƒ©ã‚¤OKï¼‰ğŸ”âœ…

ã€Œä»ŠãŸã¾ãŸã¾ç„¡ç†ã ã£ãŸã€ç³»ã€‚å¾…ã£ã¦ã‚‚ã†ä¸€å›ã§ç›´ã‚‹ã“ã¨ãŒå¤šã„âœ¨
ä¾‹ï¼šãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ç¬æ–­ğŸ“¶ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆâ±ï¸ã€ã‚µãƒ¼ãƒãƒ¼éè² è·ğŸ‹ï¸ã€ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã‚¨ãƒ©ãƒ¼ğŸŒ‰

### â‘¡ æ’ä¹…çš„ãªå¤±æ•—ï¼ˆãƒªãƒˆãƒ©ã‚¤NGï¼‰ğŸš«âŒ

ã€ŒåŸå› ãŒâ€œå…¥åŠ›ã‚„æ¨©é™â€ã«ã‚ã‚‹ã€ç³»ã€‚ä½•å›ã‚„ã£ã¦ã‚‚åŒã˜çµæœğŸ˜‡
ä¾‹ï¼šå…¥åŠ›ãƒŸã‚¹ğŸ“ã€èªè¨¼ã‚¨ãƒ©ãƒ¼ğŸ”ã€æ®‹é«˜ä¸è¶³ğŸ’¸ã€å­˜åœ¨ã—ãªã„IDğŸ”

### â‘¢ â€œçµæœãŒã‚ã‹ã‚‰ãªã„â€å¤±æ•—ï¼ˆè¦æ³¨æ„ï¼‰ğŸ¤”âš ï¸

**ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ** ã‚„ **æ¥ç¶šæ–­** ã¯ç‰¹ã«å±é™ºï¼
ã€Œã‚µãƒ¼ãƒãƒ¼å´ã§ã¯æˆåŠŸã—ã¦ãŸã®ã«ã€è¿”äº‹ã ã‘å±Šã‹ãªã‹ã£ãŸã€å¯èƒ½æ€§ãŒã‚ã‚‹ã‹ã‚‰ã€**ç„¡é‚ªæ°—ã«å†é€ã™ã‚‹ã¨äºŒé‡å®Ÿè¡Œ**ã«ãªã‚ŠãŒã¡ğŸ˜±
ã“ã“ã¯å†ªç­‰æ€§ï¼ˆIdempotencyï¼‰ã¨è¶…ç›¸æ€§ãŒã„ã„ã¨ã“ã‚ã ã‚ˆğŸ”‘âœ¨

---

## 18.2 ãƒªãƒˆãƒ©ã‚¤ã®åŸºæœ¬ãƒ«ãƒ¼ãƒ« 6ã¤ ğŸ“ğŸ§ ğŸ”

### ãƒ«ãƒ¼ãƒ«1ï¼šå³ãƒªãƒˆãƒ©ã‚¤ã¯ç¦æ­¢ï¼ã¾ãš â€œå¾…ã¤â€ â³

é€£æ‰“ã™ã‚‹ã¨ã€ã‚µãƒ¼ãƒãƒ¼ãŒä½™è¨ˆã«æ­»ã¬ï¼ˆã‚¹ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³â†’ã•ã‚‰ã«å¤±æ•—â€¦ï¼‰ã®ç„¡é™ãƒ«ãƒ¼ãƒ—ã«ãªã‚ŠãŒã¡ğŸ˜µâ€ğŸ’«
ãªã®ã§ **æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼ˆexponential backoffï¼‰** ãŒç‹é“ã ã‚ˆğŸ“ˆâœ¨ ([Amazon Web Services, Inc.][1])

### ãƒ«ãƒ¼ãƒ«2ï¼šå¾…ã¡æ™‚é–“ã« â€œã‚†ã‚‰ãï¼ˆjitterï¼‰â€ ã‚’å…¥ã‚Œã‚‹ ğŸ²

ã¿ã‚“ãªãŒåŒæ™‚ã«å†è©¦è¡Œã™ã‚‹ã¨ã€Œå†è©¦è¡Œã®å¤§æ¸‹æ»ã€ã«ãªã‚‹ã‹ã‚‰ã€å°‘ã—ãƒ©ãƒ³ãƒ€ãƒ ã«ãšã‚‰ã™ã®ãŒã‚³ãƒ„ğŸ¯ ([Amazon Web Services, Inc.][1])

### ãƒ«ãƒ¼ãƒ«3ï¼šå›æ•°ä¸Šé™ã¯å¿…é ˆï¼ˆç„¡é™ãƒªãƒˆãƒ©ã‚¤ã—ãªã„ï¼‰ğŸ”ğŸ”š

ã€Œæœ€å¤§3å›ã¾ã§ã€ã¿ãŸã„ã«å¿…ãšæ­¢ã‚ã‚‹ğŸ›‘
ï¼ˆæ­¢ã‚ãªã„ã¨ã€éšœå®³æ™‚ã«ã‚¢ãƒ—ãƒªãŒæ°¸é ã«ãƒªãƒˆãƒ©ã‚¤ã—ã¦åœ°ç„ğŸ‘¹ï¼‰

### ãƒ«ãƒ¼ãƒ«4ï¼š`Retry-After` ãŒæ¥ãŸã‚‰æœ€å„ªå…ˆã§å¾“ã† ğŸ«¡ğŸ“¨

ã‚µãƒ¼ãƒãƒ¼ãŒã€Œâ—‹ç§’å¾Œã«æ¥ã¦ã­ã€ã£ã¦æ•™ãˆã¦ãã‚Œã‚‹åˆå›³âœ¨
`Retry-After` ã¯ **ç§’æ•°** ã‹ **æ—¥æ™‚** ã§æ¥ã‚‹ã‚ˆâ±ï¸ğŸ—“ï¸ ([rfc-editor.org][2])

### ãƒ«ãƒ¼ãƒ«5ï¼šHTTPçš„ã« â€œãƒªãƒˆãƒ©ã‚¤ã—ã‚„ã™ã„æ“ä½œâ€ ã‚’çŸ¥ã‚‹ ğŸ”ğŸŒ

HTTPã§ã¯ **å†ªç­‰ãªãƒ¡ã‚½ãƒƒãƒ‰**ï¼ˆPUT/DELETE/å®‰å…¨ãªãƒ¡ã‚½ãƒƒãƒ‰ãªã©ï¼‰ã¯ã€é€šä¿¡å¤±æ•—æ™‚ã«è‡ªå‹•å†è©¦è¡Œã—ã‚„ã™ã„æ€§è³ªã¨ã—ã¦èª¬æ˜ã•ã‚Œã¦ã‚‹ã‚ˆğŸ§ 
ã€ŒåŒã˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¹°ã‚Šè¿”ã—ã¦ã‚‚ã€ã‚µãƒ¼ãƒãƒ¼ä¸Šã®æ„å›³ã—ãŸåŠ¹æœãŒåŒã˜ã€ã£ã¦å®šç¾©ã•ã‚Œã‚‹âœ¨ ([rfc-editor.org][2])

### ãƒ«ãƒ¼ãƒ«6ï¼šPOSTã‚’ãƒªãƒˆãƒ©ã‚¤ã™ã‚‹ãªã‚‰ â€œå†ªç­‰ã‚­ãƒ¼â€ ã¨ã‚»ãƒƒãƒˆ ğŸ”‘ğŸ’¥

POSTã¯ã€Œä½œæˆï¼å¢—ãˆã‚‹ã€ã®ã§ã€ç„¡å¯¾ç­–ã§å†é€ã™ã‚‹ã¨äºŒé‡ä½œæˆã—ã‚„ã™ã„ğŸ˜±
ã ã‹ã‚‰ **Idempotency-Key ã‚’ä»˜ã‘ã‚‹**ï¼ˆï¼†ã‚µãƒ¼ãƒãƒ¼å´ãŒåŒã˜ã‚­ãƒ¼ãªã‚‰åŒã˜çµæœã‚’è¿”ã™ï¼‰ã§å®‰å…¨ã«ã™ã‚‹ã‚ˆğŸ”ğŸ”

---

## 18.3 ã¾ãšã¯ â€œåˆ†é¡è¡¨â€ ã‚’æŒã¨ã† ğŸ“‹âœ¨

### A) HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ï¼šãƒªãƒˆãƒ©ã‚¤åˆ¤å®šï¼ˆè¶…ã‚ˆãä½¿ã†ç‰ˆï¼‰ğŸŒ

| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹   | ã–ã£ãã‚Šæ„å‘³         | ãƒªãƒˆãƒ©ã‚¤    | ã©ã†å‹•ãï¼Ÿ                                                                 |
| ------- | -------------- | ------- | --------------------------------------------------------------------- |
| 429     | ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤šã™ãğŸ’¦     | âœ…       | `Retry-After` ãŒã‚ã‚Œã°å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œï¼ˆãªã‘ã‚Œã°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰ ([MDNã‚¦ã‚§ãƒ–ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][3])             |
| 503     | ä¸€æ™‚çš„ã«åˆ©ç”¨ä¸å¯ğŸ› ï¸    | âœ…       | ã§ãã‚Œã° `Retry-After` ã«å¾“ã†ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã‚‚ä¸€æ™‚çš„ç”¨é€”ï¼†å¾©æ—§è¦‹è¾¼ã¿ã‚’è¼‰ã›ã‚‹ã®ãŒæ¨å¥¨ï¼‰ ([MDNã‚¦ã‚§ãƒ–ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][4]) |
| 500     | ã‚µãƒ¼ãƒãƒ¼å†…éƒ¨ã‚¨ãƒ©ãƒ¼ğŸ”¥    | âœ…ï¼ˆå›æ•°é™å®šï¼‰ | 1ã€œæ•°å›ã ã‘ãƒãƒƒã‚¯ã‚ªãƒ•ã—ã¦å†è©¦è¡Œ                                                      |
| 502     | ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ä¸èª¿ğŸŒ‰     | âœ…ï¼ˆå›æ•°é™å®šï¼‰ | ãƒãƒƒã‚¯ã‚ªãƒ•ã—ã¦å†è©¦è¡Œ                                                            |
| 504     | ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆâ±ï¸ | âœ…ï¼ˆå›æ•°é™å®šï¼‰ | ãƒãƒƒã‚¯ã‚ªãƒ•ã—ã¦å†è©¦è¡Œ                                                            |
| 408     | ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆâŒ›   | âœ…ï¼ˆå›æ•°é™å®šï¼‰ | ãƒãƒƒã‚¯ã‚ªãƒ•ã—ã¦å†è©¦è¡Œï¼ˆãŸã ã—çµæœä¸æ˜æ‰±ã„å¯„ã‚Šï¼‰                                               |
| 400/422 | å…¥åŠ›ãŒãƒ€ãƒ¡ğŸ“        | âŒ       | ãƒªãƒˆãƒ©ã‚¤ã˜ã‚ƒãªãä¿®æ­£ï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰                                                   |
| 401/403 | èªè¨¼/æ¨©é™ãŒãªã„ğŸ”     | âŒ       | ãƒ­ã‚°ã‚¤ãƒ³/æ¨©é™å¯¾å¿œãŒå…ˆ                                                           |
| 404     | ãªã„ã‚ˆğŸ”          | âŒ       | IDã‚„URLã‚’è¦‹ç›´ã™                                                            |
| 409     | ç«¶åˆâš”ï¸           | â–³       | çŠ¶æ³æ¬¡ç¬¬ï¼š**æœ€æ–°çŠ¶æ…‹ã‚’å–å¾—ã—ã¦ã‹ã‚‰**ã‚„ã‚Šç›´ã—ã€ãŒå¤šã„ï¼ˆé—‡é›²ãƒªãƒˆãƒ©ã‚¤ã¯NGï¼‰                               |

> ãƒã‚¤ãƒ³ãƒˆï¼š**429/503ã¯ â€œå¾…ã¦â€ ãŒæ˜ç¤ºã•ã‚Œã‚‹å¯èƒ½æ€§ãŒé«˜ã„**ã‹ã‚‰ã€ã¾ãš `Retry-After` ã‚’æ¢ã™ã®ãŒå‹ã¡ç­‹ã ã‚ˆğŸ† ([rfc-editor.org][2])

---

### B) â€œHTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒå–ã‚Œãªã„â€ç³»ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¤±æ•—ï¼‰ğŸ“¶

| å¤±æ•—            | ä¾‹             | ãƒªãƒˆãƒ©ã‚¤     | æ³¨æ„                               |
| ------------- | ------------- | -------- | -------------------------------- |
| ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ        | å¿œç­”ãŒæ¥ãªã„        | âœ…ï¼ˆå›æ•°é™å®šï¼‰  | **çµæœä¸æ˜** ã«ãªã‚Šã‚„ã™ã„ã®ã§ã€å†ªç­‰ã‚­ãƒ¼ãŒã‚ã‚‹ã¨å®‰å¿ƒğŸ”‘âš ï¸ |
| æ¥ç¶šãƒªã‚»ãƒƒãƒˆ/åˆ‡æ–­     | ECONNRESET ãªã© | âœ…ï¼ˆå›æ•°é™å®šï¼‰  | ã‚µãƒ¼ãƒãƒ¼å´ã¯å‡¦ç†æ¸ˆã¿ã®å¯èƒ½æ€§ã‚ã‚Š                 |
| DNSå¤±æ•—         | åå‰è§£æ±ºã§ããªã„      | âœ…ï¼ˆå°‘ã—å¾…ã£ã¦ï¼‰ | ãƒãƒƒãƒˆè¨­å®š/ä¸€æ™‚éšœå®³ã®å¯èƒ½æ€§                   |
| ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ« | Abort         | â–³        | è‡ªåˆ†ã§æ­¢ã‚ãŸãªã‚‰ã€ã¾ãšåŸå› ã‚’ç¢ºèª                 |

---

## 18.4 è¿·ã£ãŸã‚‰ã“ã‚Œï¼ãƒªãƒˆãƒ©ã‚¤åˆ¤å®šãƒ•ãƒ­ãƒ¼ ğŸ§­âœ¨

1. **ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒã‚ã‚‹ï¼Ÿ**

* ãªã„ â†’ ã€Œçµæœä¸æ˜ã€æ‰±ã„ğŸ¤”âš ï¸ï¼ˆãƒªãƒˆãƒ©ã‚¤ã™ã‚‹ãªã‚‰å†ªç­‰ã‚­ãƒ¼å‰æãŒå®‰å…¨ï¼‰
* ã‚ã‚‹ â†’ æ¬¡ã¸

2. **`Retry-After` ãŒã‚ã‚‹ï¼Ÿ**

* ã‚ã‚‹ â†’ ãã®ç§’æ•°/æ—¥æ™‚ã¾ã§å¾…ã¤ğŸ«¡â³ ([rfc-editor.org][2])
* ãªã„ â†’ æ¬¡ã¸

3. **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ 429/503/5xx/408ï¼Ÿ**

* ã¯ã„ â†’ ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‹å›æ•°åˆ¶é™ã§ãƒªãƒˆãƒ©ã‚¤ğŸ”ğŸ“ˆ
* ã„ã„ãˆï¼ˆ4xxä¸­å¿ƒï¼‰â†’ ãƒªãƒˆãƒ©ã‚¤ã—ãªã„ğŸ™…â€â™€ï¸ï¼ˆå…¥åŠ›ãƒ»èªè¨¼ãƒ»ä»•æ§˜ã®å•é¡Œï¼‰

---

## 18.5 TypeScriptãƒŸãƒ‹å®Ÿè£…ï¼šå®‰å…¨å¯„ã‚Šãƒªãƒˆãƒ©ã‚¤ `retryFetch` ğŸ§ªğŸ’»ğŸ”

### ç›®æ¨™ ğŸ¯

* 429/503 ã¯ `Retry-After` å„ªå…ˆ
* ãã‚Œä»¥å¤–ã®ä¸€æ™‚ç³»ã¯ã€ŒæŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‹ã‚¸ãƒƒã‚¿ãƒ¼ã€
* 4xxã¯åŸºæœ¬ãƒªãƒˆãƒ©ã‚¤ã—ãªã„
* å›æ•°ä¸Šé™ï¼†ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¤ã

```ts
type RetryOptions = {
  maxAttempts: number;     // ä¾‹: 4ï¼ˆ= åˆå› + ãƒªãƒˆãƒ©ã‚¤3å›ï¼‰
  timeoutMs: number;       // ä¾‹: 8000
  baseDelayMs: number;     // ä¾‹: 300
  maxDelayMs: number;      // ä¾‹: 8000
};

const sleep = (ms: number) => new Promise<void>(r => setTimeout(r, ms));

/**
 * æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ• + ã‚¸ãƒƒã‚¿ãƒ¼ï¼ˆã¡ã‚‡ã„ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
 */
function calcBackoffMs(attemptIndex: number, baseDelayMs: number, maxDelayMs: number) {
  // attemptIndex: 1,2,3...ï¼ˆãƒªãƒˆãƒ©ã‚¤å›æ•°ï¼‰
  const exp = baseDelayMs * Math.pow(2, attemptIndex - 1);
  const capped = Math.min(exp, maxDelayMs);
  const jitter = Math.random() * 0.3 * capped; // 0ã€œ30%ã‚†ã‚‰ã
  return Math.floor(capped * 0.7 + jitter);    // 70%ã€œ100%ãã‚‰ã„
}

/**
 * Retry-After ã‚’ãƒŸãƒªç§’ã«å¤‰æ›ï¼ˆç§’æ•° or HTTP-dateï¼‰
 * ä»•æ§˜ã¨ã—ã¦ç§’æ•° or æ—¥ä»˜ãŒè¨±ã•ã‚Œã‚‹ :contentReference[oaicite:8]{index=8}
 */
function parseRetryAfterMs(value: string | null): number | null {
  if (!value) return null;

  // ç§’æ•°ï¼ˆä¾‹: "120"ï¼‰
  if (/^\d+$/.test(value.trim())) {
    return Number(value.trim()) * 1000;
  }

  // HTTP-dateï¼ˆä¾‹: "Fri, 31 Dec 1999 23:59:59 GMT"ï¼‰
  const t = Date.parse(value);
  if (!Number.isNaN(t)) {
    const diff = t - Date.now();
    return diff > 0 ? diff : 0;
  }

  return null;
}

function isRetryableStatus(status: number) {
  // 429, 503, 500, 502, 504, 408 ãªã©ã‚’å¯¾è±¡ã«ã™ã‚‹
  if (status === 429) return true;
  if (status === 503) return true;
  if (status === 408) return true;
  if (status >= 500 && status <= 599) return true;
  return false;
}

/**
 * fetch ã‚’å®‰å…¨å¯„ã‚Šã«ãƒªãƒˆãƒ©ã‚¤ã™ã‚‹
 */
export async function retryFetch(
  input: RequestInfo | URL,
  init: RequestInit,
  opt: RetryOptions
): Promise<Response> {
  let lastError: unknown = null;

  for (let attempt = 1; attempt <= opt.maxAttempts; attempt++) {
    const ac = new AbortController();
    const timeoutId = setTimeout(() => ac.abort(), opt.timeoutMs);

    try {
      const res = await fetch(input, { ...init, signal: ac.signal });

      clearTimeout(timeoutId);

      if (res.ok) return res;

      // ãƒªãƒˆãƒ©ã‚¤å¯¾è±¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã˜ã‚ƒãªã„ãªã‚‰çµ‚äº†ï¼ˆ4xxä¸­å¿ƒï¼‰
      if (!isRetryableStatus(res.status)) return res;

      // Retry-After ãŒã‚ã‚Œã°æœ€å„ªå…ˆã§å¾…ã¤
      const raMs = parseRetryAfterMs(res.headers.get("Retry-After"));
      if (raMs !== null) {
        await sleep(raMs);
        continue;
      }

      // ãªã‘ã‚Œã°ãƒãƒƒã‚¯ã‚ªãƒ•
      if (attempt < opt.maxAttempts) {
        const waitMs = calcBackoffMs(attempt, opt.baseDelayMs, opt.maxDelayMs);
        await sleep(waitMs);
        continue;
      }

      return res; // ã“ã“ã¾ã§æ¥ãŸã‚‰è«¦ã‚ï¼ˆæœ€å¾Œã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ï¼‰
    } catch (e) {
      clearTimeout(timeoutId);
      lastError = e;

      // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¤±æ•—ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç­‰ï¼šå›æ•°é™å®šã§ãƒªãƒˆãƒ©ã‚¤
      if (attempt < opt.maxAttempts) {
        const waitMs = calcBackoffMs(attempt, opt.baseDelayMs, opt.maxDelayMs);
        await sleep(waitMs);
        continue;
      }

      throw lastError;
    }
  }

  // ã“ã“ã«ã¯æ¥ãªã„æƒ³å®šã ã‘ã©ä¿é™º
  throw lastError ?? new Error("retryFetch failed");
}
```

### ä½¿ã„æ–¹ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆæ³¨æ–‡ä½œæˆAPIã‚’å©ãï¼‰ğŸ§¾ğŸ’³ğŸ”‘

ã€Œçµæœä¸æ˜ã€ãŒèµ·ã“ã‚Šã‚„ã™ã„POSTã“ãã€å†ªç­‰ã‚­ãƒ¼ã§å®ˆã‚‹ã®ãŒå®‰å¿ƒã ã‚ˆğŸ›¡ï¸âœ¨

```ts
import { retryFetch } from "./retryFetch";
import { randomUUID } from "node:crypto";

const idempotencyKey = randomUUID();

const res = await retryFetch("http://localhost:3000/orders", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    "Idempotency-Key": idempotencyKey,
  },
  body: JSON.stringify({ itemId: "cake-001", qty: 1 }),
}, {
  maxAttempts: 4,
  timeoutMs: 8000,
  baseDelayMs: 300,
  maxDelayMs: 8000,
});

if (res.ok) {
  const body = await res.json();
  console.log("OK:", body);
} else {
  console.log("NG:", res.status, await res.text());
}
```

---

## 18.6 ãƒŸãƒ‹æ¼”ç¿’ ğŸ“âœ¨ï¼ˆè¡¨ã‚’ä½œã‚‹ã‚ˆï¼ï¼‰

### æ¼”ç¿’1ï¼šã‚¨ãƒ©ãƒ¼åˆ†é¡è¡¨ã‚’ä½œã‚ã†ğŸ“‹âœï¸

æ¬¡ã®å¤±æ•—ã‚’ã€Œãƒªãƒˆãƒ©ã‚¤OK/NG/æ¡ä»¶ä»˜ãã€ã«åˆ†é¡ã—ã¦ã­ğŸ€

* 429ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼‰ğŸ“‰
* 503ï¼ˆãƒ¡ãƒ³ãƒ†ä¸­/éè² è·ï¼‰ğŸ› ï¸
* 400ï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ï¼‰ğŸ“
* ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆå¿œç­”ãŒæ¥ãªã„ï¼‰â±ï¸
* 409ï¼ˆç«¶åˆï¼‰âš”ï¸

ğŸ‘‰ ãã‚Œãã‚Œã€Œæ¬¡ã«ä½•ã‚’ã™ã‚‹ã‹ã€ã‚‚1è¡Œã§æ›¸ã“ã†ï¼ˆå¾…ã¤ï¼Ÿä¿®æ­£ï¼ŸçŠ¶æ…‹ç¢ºèªï¼Ÿï¼‰ğŸ”âœ¨

### æ¼”ç¿’2ï¼š`retryFetch` ã‚’è‡ªåˆ†ç”¨ã«ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ğŸ›ï¸

* `maxAttempts` ã‚’ 3 ã«ã—ãŸç‰ˆï¼5 ã«ã—ãŸç‰ˆã§ä½“æ„Ÿã®é•ã„ã‚’ãƒ¡ãƒ¢ğŸ“
* `baseDelayMs` ã‚’ 200/500 ã§å¤‰ãˆã¦ã€é€šä¿¡ãŒæ··ã‚€ã¨ãã®â€œå„ªã—ã•â€ã‚’æ¯”ã¹ã‚‹ğŸ¢ğŸ‡

---

## 18.7 ğŸ¤–AIæ´»ç”¨ï¼ˆã“ã®ç« å‘ã‘ï¼‰ğŸ’¬âœ¨

### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ1ï¼šåˆ†é¡ã®ç©´ã‚ããƒã‚§ãƒƒã‚¯ğŸ”

ã€Œã“ã®ãƒªãƒˆãƒ©ã‚¤åˆ†é¡è¡¨ã‚’ä½œã£ãŸã‚“ã ã‘ã©ã€å®Ÿå‹™ã§æŠœã‘ã‚„ã™ã„ä¾‹ã‚’è¿½åŠ ã—ã¦ã€‚ç‰¹ã«HTTP 429/503/5xx ã¨ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‘¨ã‚Šã§ã€‚ã€

### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ2ï¼šè‡ªåˆ†ã®APIä»•æ§˜ã«å½“ã¦ã¯ã‚ğŸ§¾

ã€Œç§ã®APIï¼ˆæ³¨æ–‡ä½œæˆ/æ”¯æ‰•ã„ç¢ºå®šï¼‰ã§èµ·ã“ã‚Šã†ã‚‹å¤±æ•—ã‚’10å€‹æŒ™ã’ã¦ã€ãƒªãƒˆãƒ©ã‚¤OK/NG/æ¡ä»¶ä»˜ãã«åˆ†é¡ã—ã¦ã€‚æ¡ä»¶ä»˜ãã®å ´åˆã¯â€œä½•ã‚’ç¢ºèªã—ã¦ã‹ã‚‰â€ã‹ã‚‚æ›¸ã„ã¦ã€‚ã€

### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ3ï¼š`Retry-After` ã®æ‰±ã„ç¢ºèªğŸ•°ï¸

ã€ŒRetry-After ãŒç§’æ•°ã¨HTTP-dateä¸¡æ–¹ã‚ã‚‹ã¨èã„ãŸã€‚å®Ÿè£…ã§æ°—ã‚’ã¤ã‘ã‚‹ç‚¹ã¨ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æ¡ˆã‚’å‡ºã—ã¦ã€‚ã€

ï¼ˆ`Retry-After` ãŒç§’æ•°oræ—¥æ™‚ã§æ¥ã‚‹ã®ã¯ä»•æ§˜ã¨ã—ã¦æ˜ç¢ºã ã‚ˆğŸ“Œï¼‰ ([rfc-editor.org][2])

---

## ã‚ˆãã‚ã‚‹äº‹æ•…ãƒã‚¤ãƒ³ãƒˆé›† ğŸ˜±ğŸ§¯

* **4xxï¼ˆå…¥åŠ›ãƒŸã‚¹ï¼‰ã‚’ãƒªãƒˆãƒ©ã‚¤ã—ã¦æ°¸é ã«å¤±æ•—** ğŸŒ€ğŸ™…â€â™€ï¸
* **å³ãƒªãƒˆãƒ©ã‚¤ã§ã‚µãƒ¼ãƒãƒ¼ã‚’è¿½ã„è¾¼ã‚€**ï¼ˆéšœå®³ã‚’æ‚ªåŒ–ã•ã›ã‚‹ï¼‰ğŸ”¥
* **`Retry-After` ã‚’ç„¡è¦–ã—ã¦BANã•ã‚Œã‚‹** ğŸ¥¶ï¼ˆ429ã®ã¨ãç‰¹ã«ï¼‰ ([MDNã‚¦ã‚§ãƒ–ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][3])
* **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’â€œå¤±æ•—ç¢ºå®šâ€ã¨æ€ã„è¾¼ã‚“ã§äºŒé‡ä½œæˆ** ğŸ§¨ï¼ˆçµæœä¸æ˜ãªã®ãŒæ€–ã„ï¼‰

---

## ã¾ã¨ã‚ ğŸŒ¸âœ…

* ãƒªãƒˆãƒ©ã‚¤ã—ã¦ã„ã„ã®ã¯ã€Œä¸€æ™‚çš„ã€ãªå¤±æ•—ã ã‘ğŸ”
* 429/503ã¯ `Retry-After` ã‚’æœ€å„ªå…ˆã§å°Šé‡ğŸ«¡ ([rfc-editor.org][2])
* ãƒªãƒˆãƒ©ã‚¤ã¯ **ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‹ã‚¸ãƒƒã‚¿ãƒ¼ï¼‹å›æ•°ä¸Šé™** ãŒåŸºæœ¬ğŸ“ˆğŸ² ([Amazon Web Services, Inc.][1])
* ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ/æ¥ç¶šæ–­ã¯ **çµæœä¸æ˜** ã«ãªã‚Šã‚„ã™ã„ã‹ã‚‰ã€å†ªç­‰ã‚­ãƒ¼ã¨çµ„ã¿åˆã‚ã›ã‚‹ã¨å®‰å…¨ğŸ”‘âœ¨

[1]: https://aws.amazon.com/builders-library/timeouts-retries-and-backoff-with-jitter/?utm_source=chatgpt.com "Timeouts, retries and backoff with jitter"
[2]: https://www.rfc-editor.org/rfc/rfc9110.html "RFC 9110: HTTP Semantics"
[3]: https://developer.mozilla.org/ja/docs/Web/HTTP/Reference/Status/429?utm_source=chatgpt.com "429 Too Many Requests - HTTP - MDN Web Docs"
[4]: https://developer.mozilla.org/ja/docs/Web/HTTP/Reference/Status/503?utm_source=chatgpt.com "503 Service Unavailable - HTTP - MDN Web Docs"

