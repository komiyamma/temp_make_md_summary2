# ç¬¬22ç«  ã‚¨ãƒ©ãƒ¼åˆ†é¡ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ vs ã‚¤ãƒ³ãƒ•ãƒ©ï¼‰ğŸš§ğŸŒ

## ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ğŸ¯âœ¨

* å¤±æ•—ã‚’ã€Œç¨®é¡ã€ã§åˆ†ã‘ã¦æ•´ç†ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ğŸ§ ğŸ—‚ï¸
* ã©ã“ã§æŠ•ã’ã¦ã€ã©ã“ã§å—ã‘æ­¢ã‚ã¦ã€ã©ã“ã§â€œè¨€ã„æ›ãˆã‚‹â€ã‹ãŒåˆ†ã‹ã‚‹ğŸ”ğŸ’¬
* ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆè¨­è¨ˆã§ã€Œå£Šã‚Œã«ãã„å¤±æ•—ã®æ‰±ã„ã€ã‚’ä½œã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ğŸ›¡ï¸ğŸ“£

---

## 1. ã¾ãšçµè«–ï¼šå¤±æ•—ã¯â€œ2ç¨®é¡ï¼‹Î±â€ã«åˆ†ã‘ã‚‹ã®ãŒãƒ©ã‚¯ğŸ˜ºğŸ€

### âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ï¼ˆDomain Errorï¼‰ğŸ§±ğŸ”’

**æ¥­å‹™ãƒ«ãƒ¼ãƒ«é•å**ãƒ»**çŠ¶æ…‹ãŒè¨±ã•ã‚Œãªã„**ãŒåŸå› ã€‚
ä¾‹ï¼š

* ã™ã§ã«æ”¯æ‰•ã„æ¸ˆã¿ãªã®ã«ã€ã‚‚ã†ä¸€å›æ”¯æ‰•ãŠã†ã¨ã—ãŸğŸ’³âŒ
* åœ¨åº«ãŒ0ãªã®ã«æ³¨æ–‡ã—ã‚ˆã†ã¨ã—ãŸğŸ“¦âŒ
* ã‚¯ãƒ¼ãƒãƒ³æœŸé™åˆ‡ã‚Œãªã®ã«é©ç”¨ã—ã‚ˆã†ã¨ã—ãŸğŸ«â°âŒ

ğŸ‘‰ **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«èª¬æ˜ã§ãã‚‹**ï¼ˆãã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡Œå‹•ã§å›é¿ã§ãã‚‹ï¼‰ã“ã¨ãŒå¤šã„ã‚ˆâœ¨

### âœ… ã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ©ãƒ¼ï¼ˆInfrastructure Errorï¼‰ğŸŒğŸ§¯

**é€šä¿¡ãƒ»DBãƒ»å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹**ãªã© â€œç’°å¢ƒâ€ ãŒåŸå› ã€‚
ä¾‹ï¼š

* DBã«æ¥ç¶šã§ããªã„ğŸ—„ï¸ğŸ”ŒâŒ
* ãƒ¡ãƒ¼ãƒ«é€ä¿¡APIãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãŸğŸ“©â³âŒ
* æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹ãŒä¸€æ™‚çš„ã«è½ã¡ã¦ã‚‹ğŸ’³âš¡âŒ

ğŸ‘‰ **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé ‘å¼µã£ã¦ã‚‚ç›´ã‚‰ãªã„**ã“ã¨ãŒå¤šã„ã‚ˆğŸ˜µâ€ğŸ’«

### âœ… ãã—ã¦â€œÎ±â€ï¼šæœªçŸ¥ã®ã‚¨ãƒ©ãƒ¼ï¼ˆBug/Unknownï¼‰ğŸ›â“

* ã¬ã‚‹ã½ã€å‹ãƒŸã‚¹ã€æƒ³å®šå¤–ã®ãƒ‡ãƒ¼ã‚¿å½¢å¼â€¦ãªã©
  ğŸ‘‰ ã“ã‚Œã¯ã€Œåˆ†é¡ã§ããªã„ã€ã˜ã‚ƒãªãã¦ã€**ã¾ãšãƒã‚°ã¨ã—ã¦æ‰±ã†**ã®ãŒå®‰å…¨ğŸ™†â€â™€ï¸

---

## 2. ãªã‚“ã§åˆ†é¡ãŒå¿…è¦ãªã®ï¼Ÿï¼ˆè¶…ã ã„ã˜ï¼‰ğŸ’¡ğŸ’–

åˆ†é¡ã§ãã‚‹ã¨ã€åˆ¤æ–­ãŒä¸€æ°—ã«ãƒ©ã‚¯ã«ãªã‚‹ã‚ˆâœ¨

* **ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼**ï¼š

  * ç”»é¢ã«å‡ºã™æ–‡è¨€ã‚’ç”¨æ„ã—ã‚„ã™ã„ğŸª§
  * ãƒªãƒˆãƒ©ã‚¤ã—ã¦ã‚‚æ„å‘³ãŒãªã„ï¼ˆãƒ«ãƒ¼ãƒ«é•åã¯ç›´ã‚‰ãªã„ï¼‰ğŸ”âŒ
* **ã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ©ãƒ¼**ï¼š

  * ãƒªãƒˆãƒ©ã‚¤å¯¾è±¡ã«ãªã‚Šã‚„ã™ã„ï¼ˆæ¬¡ç« ã§æ·±æ˜ã‚ŠğŸ”ğŸ§¯ï¼‰
  * ãƒ­ã‚°ãƒ»ç›£è¦–ãƒ»é‹ç”¨ã®å¯¾è±¡ã«ãªã‚‹ğŸ‘€ğŸ“ˆ
* **æœªçŸ¥ã®ã‚¨ãƒ©ãƒ¼**ï¼š

  * ã¾ãšã‚¢ãƒ©ãƒ¼ãƒˆï¼†èª¿æŸ»ğŸ””ğŸ•µï¸â€â™€ï¸

---

## 3. 3ç§’ã§åˆ†é¡ã™ã‚‹ã‚³ãƒ„â±ï¸ğŸ§ âœ¨

è¿·ã£ãŸã‚‰ã“ã®è³ªå•ğŸ‘‡

### Q1ï¼šã“ã‚Œã¯ã€Œæ¥­å‹™ãƒ«ãƒ¼ãƒ«ã®è©±ã€ï¼ŸğŸ§¾

* YES ğŸ‘‰ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ğŸ§±
* NO ğŸ‘‰ æ¬¡ã¸

### Q2ï¼šã“ã‚Œã¯ã€Œå¤–éƒ¨ãƒ»ç’°å¢ƒã®è©±ã€ï¼Ÿï¼ˆDB/é€šä¿¡/ä¾å­˜ã‚µãƒ¼ãƒ“ã‚¹ï¼‰ğŸŒ

* YES ğŸ‘‰ ã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ©ãƒ¼ğŸŒ
* NO ğŸ‘‰ æ¬¡ã¸

### Q3ï¼šãã‚Œä»¥å¤–ï¼ˆæƒ³å®šå¤–ï¼‰ï¼ŸğŸ›

* YES ğŸ‘‰ æœªçŸ¥ã®ã‚¨ãƒ©ãƒ¼ï¼ˆãƒã‚°æ‰±ã„ï¼‰ğŸ›

---

## 4. â€œå¢ƒç•Œã§å¤‰æ›ã™ã‚‹â€ã£ã¦ã©ã†ã„ã†ã“ã¨ï¼ŸğŸ”ğŸšª

ã–ã£ãã‚Šå›³ã«ã™ã‚‹ã¨ã“ã†ğŸ‘‡

* **ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤**ï¼šãƒ«ãƒ¼ãƒ«é•åãªã‚‰ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã™ğŸ§±
* **ã‚¤ãƒ³ãƒ•ãƒ©å±¤**ï¼šé€šä¿¡ã‚„DBå¤±æ•—ãªã‚‰ã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦åŒ…ã‚€ğŸŒ
* **ã‚¢ãƒ—ãƒª/UIå±¤ï¼ˆå¢ƒç•Œï¼‰**ï¼šå—ã‘å–ã£ãŸã‚¨ãƒ©ãƒ¼ã‚’ã€Œç”»é¢ãƒ»HTTPãƒ»ãƒ­ã‚°å‘ã‘ã€ã«è¨€ã„æ›ãˆã‚‹ğŸ’¬ğŸ—‚ï¸

---

## 5. TypeScriptã®â€œä»Šã©ãâ€ãƒã‚¤ãƒ³ãƒˆï¼ˆæœ€æ–°å¯„ã‚Šï¼‰ğŸ§·âœ¨

### 5.1 `catch (err)` ã® `err` ã¯ `unknown` ãŒåŸºæœ¬ãƒ ãƒ¼ãƒ‰ğŸ™‹â€â™€ï¸

TypeScriptã«ã¯ `useUnknownInCatchVariables` ã¨ã„ã†ãƒ•ãƒ©ã‚°ãŒã‚ã‚Šã€`catch` å¤‰æ•°ã‚’ `unknown` ã¨ã—ã¦æ‰±ã†æ–¹é‡ãŒç”¨æ„ã•ã‚Œã¦ã‚‹ã‚ˆï¼ˆç‹™ã„ã¯ã€Œå®‰å…¨ã«çµã‚Šè¾¼ã‚ï¼ã€ã£ã¦ã“ã¨ï¼‰ğŸ›¡ï¸âœ¨ ([TypeScript][1])

ã ã‹ã‚‰ã€**catchã—ãŸç¬é–“ã« `err.message` ã‚’è§¦ã‚‹ã®ã¯NG**ã«ãªã‚ŠãŒã¡ğŸ˜¿
â†’ ã¡ã‚ƒã‚“ã¨çµã‚Šè¾¼ã¿ï¼ˆnarrowingï¼‰ã—ã‚ˆã†ã­ï¼

### 5.2 â€œåŸå› ã‚’æŒãŸã›ã‚‹â€ `Error.cause` ãŒè¶…ä¾¿åˆ©ğŸ§ ğŸ”—

ã‚¨ãƒ©ãƒ¼ã‚’ã€ŒåŒ…ã¿ç›´ã™ã€ã¨ãã«ã€å…ƒã‚¨ãƒ©ãƒ¼ã‚’ `cause` ã«æ®‹ã›ã‚‹ã‚ˆâœ¨

* ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚‚åºƒãä½¿ãˆã‚‹ä»•æ§˜ã«ãªã£ã¦ã‚‹ğŸŒ ([MDN Web Docs][2])
* Node.jsã§ã‚‚ `error.cause` ãŒã‚ã‚Šã€`new Error(message, { cause })` ã§æ‰±ãˆã‚‹ï¼ˆNodeã§ã¯ v16.9.0 è¿½åŠ ï¼‰ğŸ“Œ ([Node.js][3])

ã“ã‚ŒãŒã‚ã‚‹ã¨ã€Œè¡¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯åˆ†ã‹ã‚Šã‚„ã™ãã€ã§ã‚‚åŸå› ã¯å¤±ã‚ãªã„ã€ãŒã§ãã‚‹ğŸ˜»

---

## 6. å®Ÿè£…ã—ã¦ã¿ã‚ˆã†ï¼šã‚¨ãƒ©ãƒ¼å‹ã‚’2ç³»çµ±ã«åˆ†ã‘ã‚‹ğŸ§©ğŸ§±ğŸŒ

ã“ã“ã§ã¯ **â€œä¾‹å¤–ï¼ˆthrowï¼‰ã§è¡¨ç¾ã™ã‚‹ç‰ˆâ€** ã‚’ä½œã‚‹ã‚ˆï¼ˆã¾ãšã¯ã‚·ãƒ³ãƒ—ãƒ«å„ªå…ˆï¼‰âœ¨

### 6.1 ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼åŸºåº•ã‚¯ãƒ©ã‚¹ğŸ§±

```ts
// domain/errors/DomainError.ts
export abstract class DomainError extends Error {
  readonly category = "domain" as const;

  constructor(message: string, options?: { cause?: unknown }) {
    super(message, options);
    this.name = new.target.name;
  }
}
```

ä¾‹ï¼šæ”¯æ‰•ã„æ¸ˆã¿ãªã®ã«æ”¯æ‰•ã„ã€ã‚’ç¦æ­¢ğŸ’³âŒ

```ts
// domain/errors/OrderAlreadyPaidError.ts
import { DomainError } from "./DomainError";

export class OrderAlreadyPaidError extends DomainError {
  constructor(orderId: string) {
    super(`æ³¨æ–‡(${orderId})ã¯ã™ã§ã«æ”¯æ‰•ã„æ¸ˆã¿ã ã‚ˆğŸ’³âœ…ï¼ˆäºŒé‡æ‰•ã„é˜²æ­¢ï¼‰`);
  }
}
```

---

### 6.2 ã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ©ãƒ¼åŸºåº•ã‚¯ãƒ©ã‚¹ğŸŒğŸ§¯ï¼ˆcause ã§åŸå› ã‚’ä¿æŒï¼‰

```ts
// infrastructure/errors/InfrastructureError.ts
export abstract class InfrastructureError extends Error {
  readonly category = "infrastructure" as const;

  constructor(message: string, options?: { cause?: unknown }) {
    super(message, options);
    this.name = new.target.name;
  }
}
```

ä¾‹ï¼šæ±ºæ¸ˆAPIå‘¼ã³å‡ºã—å¤±æ•—ã‚’ â€œæ–‡è„ˆã¤ãâ€ ã§åŒ…ã‚€ğŸ’³ğŸŒ©ï¸

```ts
// infrastructure/errors/PaymentGatewayError.ts
import { InfrastructureError } from "./InfrastructureError";

export class PaymentGatewayError extends InfrastructureError {
  constructor(orderId: string, options?: { cause?: unknown }) {
    super(`æ±ºæ¸ˆå‡¦ç†ã«å¤±æ•—ã—ãŸã‚ˆğŸ’³âš ï¸ orderId=${orderId}`, options);
  }
}
```

> `cause` ã‚’ä½¿ã†ã¨ã€è¡¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰ãˆã¦ã‚‚ã€Œå…ƒã®å¤±æ•—ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç­‰ï¼‰ã€ã‚’å¤±ã‚ãªã„ã‚ˆğŸ”—âœ¨ ([MDN Web Docs][2])

---

## 7. ã©ã“ã§æŠ•ã’ã‚‹ï¼Ÿã©ã“ã§å¤‰æ›ã™ã‚‹ï¼Ÿï¼ˆãƒŸãƒ‹ECã§æµã‚Œã‚’ä½œã‚‹ï¼‰ğŸ›’ğŸ§©

### 7.1 ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆé›†ç´„ï¼‰ã§ã¯ã€Œãƒ«ãƒ¼ãƒ«é•åã ã‘ã€ã‚’æŠ•ã’ã‚‹ğŸ§±

```ts
// domain/order/Order.ts
import { OrderAlreadyPaidError } from "../errors/OrderAlreadyPaidError";

type OrderStatus = "pending" | "paid";

export class Order {
  private status: OrderStatus = "pending";
  private domainEvents: Array<{ type: string; payload: unknown }> = [];

  constructor(private readonly id: string) {}

  pay(paymentId: string) {
    if (this.status === "paid") {
      throw new OrderAlreadyPaidError(this.id);
    }

    this.status = "paid";

    // ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€Œèµ·ããŸäº‹å®Ÿã€ğŸ“£
    this.domainEvents.push({
      type: "OrderPaid",
      payload: { orderId: this.id, paymentId },
    });
  }

  pullDomainEvents() {
    const events = this.domainEvents;
    this.domainEvents = [];
    return events;
  }
}
```

ãƒã‚¤ãƒ³ãƒˆğŸ’¡

* ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯ **é€šä¿¡/DBã‚’çŸ¥ã‚‰ãªã„** ğŸ™…â€â™€ï¸
* ã ã‹ã‚‰ã€ã“ã“ã§å‡ºã‚‹ã®ã¯ **ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ä¸­å¿ƒ** ğŸ§±âœ¨

---

### 7.2 ã‚¤ãƒ³ãƒ•ãƒ©ï¼ˆå¤–éƒ¨I/Oï¼‰ã§ã¯ã€Œå¤±æ•—ã‚’åŒ…ã‚“ã§æŠ•ã’ã‚‹ã€ğŸŒ

```ts
// infrastructure/payment/PaymentGateway.ts
import { PaymentGatewayError } from "../errors/PaymentGatewayError";

export class PaymentGateway {
  async charge(orderId: string, amount: number) {
    try {
      // ã“ã“ã§å¤–éƒ¨APIå‘¼ã³å‡ºã—ã‚’ã™ã‚‹æƒ³å®š
      // await fetch(...)

      // ã‚ã–ã¨å¤±æ•—ä¾‹ï¼š
      throw new Error("timeout");
    } catch (err) {
      // err ã¯ unknown ã«ãªã‚ŠãŒã¡ãªã®ã§çµã‚Šè¾¼ã¿ãŒå¤§äº‹ğŸ›¡ï¸ :contentReference[oaicite:4]{index=4}
      throw new PaymentGatewayError(orderId, { cause: err });
    }
  }
}
```

---

### 7.3 å¢ƒç•Œï¼ˆã‚¢ãƒ—ãƒªå±¤ï¼‰ã§ â€œè¨€ã„æ›ãˆâ€ ã™ã‚‹ğŸ”ğŸ’¬

ã“ã“ãŒç¬¬22ç« ã®æœ¬ä½“âœ¨
ã€Œå—ã‘å–ã£ãŸã‚¨ãƒ©ãƒ¼ã€ã‚’ã€**å‘¼ã³å‡ºã—å…ƒãŒæ‰±ã„ã‚„ã™ã„å½¢**ã«å¤‰æ›ã™ã‚‹ã‚ˆï¼

#### ã¾ãš â€œã‚¢ãƒ—ãƒªå‘ã‘ã‚¨ãƒ©ãƒ¼â€ ã‚’å®šç¾©ğŸ§¾

```ts
// application/errors/AppError.ts
export type AppError =
  | { kind: "validation"; message: string }   // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«èª¬æ˜ã—ã‚„ã™ã„
  | { kind: "temporary"; message: string }    // ä¸€æ™‚çš„ï¼ˆãƒªãƒˆãƒ©ã‚¤å€™è£œï¼‰
  | { kind: "unexpected"; message: string };  // ãƒã‚°/æƒ³å®šå¤–
```

#### å¤‰æ›é–¢æ•°ï¼ˆã“ã“ãŒå¢ƒç•Œã§ã®ç¿»è¨³æ©Ÿï¼‰ğŸ—£ï¸ğŸ”

```ts
// application/errors/toAppError.ts
import { DomainError } from "../../domain/errors/DomainError";
import { InfrastructureError } from "../../infrastructure/errors/InfrastructureError";
import { AppError } from "./AppError";

export function toAppError(err: unknown): AppError {
  if (err instanceof DomainError) {
    return { kind: "validation", message: err.message };
  }

  if (err instanceof InfrastructureError) {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãã®ã¾ã¾å‡ºã™ã®ã¯å±é™ºãªã“ã¨ãŒå¤šã„ã®ã§ã€æ–‡è¨€ã¯æ§ãˆã‚ã«âœ¨
    return { kind: "temporary", message: "ãŸã ã„ã¾æ··ã¿åˆã£ã¦ã‚‹ã¿ãŸã„â€¦ğŸ’¦ ã‚‚ã†ä¸€åº¦ãŸã‚ã—ã¦ã­ğŸ™" };
  }

  if (err instanceof Error) {
    return { kind: "unexpected", message: "æƒ³å®šå¤–ã®ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã‚ˆğŸ˜µâ€ğŸ’«ï¼ˆé‹å–¶ã«é€£çµ¡ã—ã¦ã­ï¼‰" };
  }

  return { kind: "unexpected", message: "æƒ³å®šå¤–ã®ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã‚ˆğŸ˜µâ€ğŸ’«" };
}
```

---

## 8. ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆçš„ã«ã€åˆ†é¡ãŒåŠ¹ãå ´é¢ğŸ“£ğŸ§©

### âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã‚‰

* çŠ¶æ…‹å¤‰æ›´ã§ããªã„
* å½“ç„¶ã‚¤ãƒ™ãƒ³ãƒˆã‚‚å‡ºãªã„ï¼ˆâ€œèµ·ãã¦ãªã„â€ã‹ã‚‰ï¼‰ğŸ“£âŒ

### âœ… ã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã‚‰ï¼ˆä¿å­˜ãƒ»é€ä¿¡ãƒ»å¤–éƒ¨é€£æºï¼‰

* â€œèµ·ããŸäº‹å®Ÿâ€ ã¯ã‚ã‚‹ã®ã«ã€å¤–ã¸å±Šã‘ã‚‰ã‚Œãªã„ã“ã¨ãŒã‚ã‚‹ğŸ˜¿
* ã ã‹ã‚‰ Outboxï¼ˆç¬¬20ã€œ21ç« ï¼‰ã‚„ã€å¤±æ•—æ™‚æ–¹é‡ï¼ˆç¬¬23ç« ï¼‰ã«ç¹‹ãŒã‚‹ğŸ”—âœ¨

ã“ã®ç« ã§ã¯ã¾ãš **ã€Œãã‚Œã¯ã©ã£ã¡ã®å¤±æ•—ï¼Ÿã€** ã‚’ãƒ–ãƒ¬ãšã«è¨€ãˆã‚‹ã‚ˆã†ã«ã—ã‚ˆã†ã­ğŸ¯

---

## 9. ã‚„ã£ã¦ã¿ã‚ˆã†æ¼”ç¿’ğŸ“ğŸ’–

### æ¼”ç¿’1ï¼šåˆ†é¡ã‚²ãƒ¼ãƒ ï¼ˆ5å•ï¼‰ğŸ§ ğŸ®

æ¬¡ã‚’ **domain / infrastructure / unknown** ã«åˆ†ã‘ã¦ã¿ã¦ã­ğŸ‘‡

1. `æ³¨æ–‡åˆè¨ˆãŒ0å††` ã®æ³¨æ–‡ã‚’ä½œã‚ã†ã¨ã—ãŸğŸ§¾
2. `DBæ¥ç¶š` ãŒåˆ‡ã‚Œã¦ä¿å­˜ã§ããªã„ğŸ—„ï¸
3. `ãƒ¡ãƒ¼ãƒ«é€ä¿¡API` ãŒ 503 ã‚’è¿”ã—ãŸğŸ“©
4. `ã™ã§ã«ç™ºé€æ¸ˆã¿` ãªã®ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã‚ˆã†ã¨ã—ãŸğŸ“¦
5. `JSON.parse` ãŒè½ã¡ãŸï¼ˆæƒ³å®šå¤–å½¢å¼ãŒæ¥ãŸï¼‰ğŸ§©ğŸ’¥

---

### æ¼”ç¿’2ï¼šå¢ƒç•Œã§å¤‰æ›ã—ã¦è¿”ã™ğŸ”ğŸ’¬

`toAppError()` ã‚’ä½¿ã£ã¦ã€ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‹ã‚‰æˆ»ã™å½¢ã‚’ä½œã£ã¦ã¿ã‚ˆã†âœ¨

```ts
// application/usecases/payOrder.ts
import { toAppError } from "../errors/toAppError";
import { AppError } from "../errors/AppError";

export async function payOrder(): Promise<{ ok: true } | { ok: false; error: AppError }> {
  try {
    // ã“ã“ã§ã€ãƒ‰ãƒ¡ã‚¤ãƒ³æ›´æ–° â†’ ä¿å­˜ â†’ ã‚¤ãƒ™ãƒ³ãƒˆé…é€â€¦ã¨ã„ã†æµã‚Œã‚’å‘¼ã¶æƒ³å®š
    // ä¾‹ï¼šorder.pay(); repo.save(order); dispatcher.dispatch(order.pullDomainEvents());

    return { ok: true };
  } catch (err) {
    return { ok: false, error: toAppError(err) };
  }
}
```

---

## 10. AIæ´»ç”¨ï¼ˆã‚³ãƒ”ãƒšã§ä½¿ãˆã‚‹ï¼‰ğŸ¤–âœ¨ğŸ’¬

* ã€ŒãƒŸãƒ‹ECã§èµ·ã“ã‚Šã†ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’10å€‹ã€ã‚¤ãƒ™ãƒ³ãƒˆåã‚‚æ·»ãˆã¦å‡ºã—ã¦ã€ğŸ§¾ğŸ“£
* ã€Œã“ã®å¤±æ•—ã‚±ãƒ¼ã‚¹ä¸€è¦§ã‚’ domain / infrastructure / unknown ã«åˆ†é¡ã—ã¦ã€ç†ç”±ã‚‚ä¸€è¨€ã§ã€ğŸ§ ğŸ—‚ï¸
* ã€ŒInfrastructureError ã«åŒ…ã‚€ã¨ãã® message ã®ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’3æ¡ˆï¼ˆãƒ­ã‚°å‘ã‘/é‹ç”¨å‘ã‘/ç”»é¢å‘ã‘ï¼‰ã§ã€ğŸŒğŸ§¯
* ã€ŒtoAppError ã®åˆ†å²ã€æ¼ã‚Œã¦ã‚‹ã‚±ãƒ¼ã‚¹ã‚ã‚‹ï¼Ÿè¿½åŠ ã™ã‚‹ãªã‚‰ä½•ï¼Ÿã€ğŸ”âœ…

---

## 11. ã¾ã¨ã‚ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆâœ…ğŸ§¡

* ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã§æŠ•ã’ã‚‹ã®ã¯ **æ¥­å‹™ãƒ«ãƒ¼ãƒ«é•å** ã ã‘ğŸ§±
* é€šä¿¡/DB/å¤–éƒ¨APIã®å¤±æ•—ã¯ **ã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ©ãƒ¼** ã¨ã—ã¦åŒ…ã‚€ğŸŒ
* `catch` ã¯ `unknown` å‰æã§ **çµã‚Šè¾¼ã¿**ã™ã‚‹ğŸ›¡ï¸ ([TypeScript][1])
* `Error.cause` ã§ **åŸå› ã‚’ä¿æŒ**ã—ã¦ã€èª¿æŸ»åŠ›ã‚’ä¸Šã’ã‚‹ğŸ”—âœ¨ ([MDN Web Docs][2])
* å¢ƒç•Œï¼ˆã‚¢ãƒ—ãƒªå±¤ï¼‰ã§ â€œè¨€ã„æ›ãˆâ€ ã—ã¦ã€å‘¼ã³å‡ºã—å…ƒã«è¿”ã™ğŸ”ğŸ’¬

---

[1]: https://www.typescriptlang.org/docs/handbook/release-notes/typescript-4-4.html?utm_source=chatgpt.com "Documentation - TypeScript 4.4"
[2]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error/cause?utm_source=chatgpt.com "Error: cause - JavaScript - MDN Web Docs"
[3]: https://nodejs.org/api/errors.html?utm_source=chatgpt.com "Errors | Node.js v25.4.0 Documentation"
