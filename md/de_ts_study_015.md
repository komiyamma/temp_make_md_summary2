# ç¬¬15ç«  ãƒãƒ³ãƒ‰ãƒ©åˆ†å‰²ã®è¨­è¨ˆï¼ˆå¢—ãˆã¦ã‚‚ç ´ç¶»ã—ãªã„ï¼‰ğŸ±â¡ï¸ğŸ§©

## 15.0 ã“ã®ç« ã®ã‚´ãƒ¼ãƒ« ğŸ¯âœ¨

* ãƒãƒ³ãƒ‰ãƒ©ãŒå¢—ãˆã¦ã‚‚ã€Œã©ã“ã«ä½•ãŒã‚ã‚‹ã‹ã€è¿·å­ã«ãªã‚‰ãªã„æ•´ç†è¡“ãŒã‚ã‹ã‚‹ ğŸ—‚ï¸ğŸ§­
* ã€Œé€šçŸ¥ç³»ã€ã€Œé›†è¨ˆç³»ã€ã€Œé€£æºç³»ã€ã¿ãŸã„ã«**åˆ†é¡ãƒ«ãƒ¼ãƒ«**ã‚’ä½œã£ã¦ã€ãƒãƒ¼ãƒ ã§ã‚‚ãƒ–ãƒ¬ãªã„ç½®ãæ–¹ã«ã§ãã‚‹ ğŸ“šâœ…
* â€œ1ãƒãƒ³ãƒ‰ãƒ©ï¼1é–¢å¿ƒâ€ ã‚’å®ˆã£ãŸã¾ã¾ã€æ‹¡å¼µã—ã¦ã‚‚ç ´ç¶»ã—ãªã„è¨­è¨ˆã«ã§ãã‚‹ ğŸ±ğŸ’ª

---

## 15.1 ãã‚‚ãã‚‚ã€ãªãœåˆ†å‰²ãŒå¿…è¦ï¼ŸğŸ¤”ğŸ’¥

ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½¿ã†ã¨ã€æ©Ÿèƒ½ãŒå¢—ãˆã‚‹ãŸã³ã«ã€Œã‚¤ãƒ™ãƒ³ãƒˆã®åå¿œå…ˆã€ãŒå¢—ãˆã¾ã™ ğŸ“ˆâœ¨
ä¾‹ï¼š`OrderPaid` ãŒèµ·ããŸã‚‰â€¦

* ãƒ¬ã‚·ãƒ¼ãƒˆãƒ¡ãƒ¼ãƒ«é€ã‚‹ ğŸ“©
* ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ã™ã‚‹ ğŸª™
* å£²ä¸Šé›†è¨ˆã®ReadModelæ›´æ–°ã™ã‚‹ ğŸ“Š
* CRMã¸é€£æºã™ã‚‹ ğŸ”—
* ç›£è¦–ãƒ­ã‚°ã‚„ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ®‹ã™ ğŸ‘€

ã“ã“ã§åˆ†å‰²ã—ãªã„ã¨ã€ã“ã†ãªã‚‹äº‹æ•…ãŒå¤šã„ã§ã™ğŸ‘‡ğŸ˜µâ€ğŸ’«

* 1ãƒ•ã‚¡ã‚¤ãƒ«ãŒå·¨å¤§åŒ–ã—ã¦ â€œç¥ãƒãƒ³ãƒ‰ãƒ©â€ ã«ãªã‚‹ ğŸ‘‘ğŸ’£
* `if (event.type === ...)` ã®å·¨å¤§switchãŒç”Ÿã¾ã‚Œã‚‹ ğŸ§Ÿâ€â™‚ï¸
* è¿½åŠ ã®ãŸã³ã«ã€Œã©ã“ã‚’è§¦ã‚Œã°ã„ã„ï¼Ÿã€ãŒæ¯å›ä¸æ˜ ğŸŒ€

ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€Œèµ·ããŸäº‹å®Ÿã€ã‚’ä¼ãˆã‚‹ä»•çµ„ã¿ã§ã€ãã“ã‹ã‚‰ã®å‰¯ä½œç”¨ï¼ˆé€šçŸ¥ãƒ»é€£æºãªã©ï¼‰ã‚’å¤–ã«å‡ºã›ã‚‹ã®ãŒå¼·ã¿ã§ã™ ğŸ””â¡ï¸ğŸŒ ([Microsoft Learn][1])
ã ã‹ã‚‰ã“ãã€**å¤–ã«å‡ºã—ãŸå‰¯ä½œç”¨ã‚’â€œæ•´ç†ã—ã¦å¢—ã‚„ã™è¨­è¨ˆâ€**ãŒå¿…è¦ã«ãªã‚Šã¾ã™ ğŸ±ğŸ§©

---

## 15.2 ãƒãƒ³ãƒ‰ãƒ©åˆ†é¡ã®â€œè¶…ä½¿ãˆã‚‹â€3åˆ†é¡ ğŸ“šâœ¨ï¼ˆã¾ãšã¯ã“ã‚Œã ã‘ã§OKï¼‰

ã“ã®ç« ã§ã¯ã€ã¾ãšè¿·ã‚ãªã„ãŸã‚ã®3åˆ†é¡ã‹ã‚‰å…¥ã‚Šã¾ã™ ğŸ˜ŠğŸ€

### â‘  é€šçŸ¥ç³»ï¼ˆNotificationï¼‰ğŸ“©âœ¨

* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚„é‹ç”¨æ‹…å½“ã«ã€Œä¼ãˆã‚‹ã€
* ä¾‹ï¼šãƒ¡ãƒ¼ãƒ«ã€Pushã€Slackã€ã‚¢ãƒ—ãƒªå†…é€šçŸ¥ ãªã©

**ç‰¹å¾´**ï¼šUI/æ–‡è¨€/ãƒãƒ£ãƒãƒ«å¤‰æ›´ãŒå¤šã„ï¼ˆä»•æ§˜å¤‰æ›´ã®ç†ç”±ãŒã€Œä¼ãˆæ–¹ã€ï¼‰ğŸ’¬

---

### â‘¡ é›†è¨ˆãƒ»æŠ•å½±ç³»ï¼ˆProjection / ReadModelï¼‰ğŸ“ŠğŸ”

* èª­ã¿å–ã‚Šã‚’é€Ÿãã—ãŸã‚Šã€ä¸€è¦§è¡¨ç¤ºç”¨ã«æ•´å½¢ã—ãŸã‚Šã™ã‚‹
* ä¾‹ï¼šæ³¨æ–‡ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ã€å£²ä¸Šé›†è¨ˆã‚«ã‚¦ãƒ³ã‚¿æ›´æ–° ãªã©

**ç‰¹å¾´**ï¼šã€Œè¡¨ç¤ºã®éƒ½åˆã€ã€Œæ¤œç´¢ã®éƒ½åˆã€ã§å¤‰ã‚ã‚‹ï¼ˆä»•æ§˜å¤‰æ›´ã®ç†ç”±ãŒã€Œè¦‹ã›æ–¹ã€ï¼‰ğŸª„

---

### â‘¢ é€£æºç³»ï¼ˆIntegrationï¼‰ğŸ”—ğŸŒ

* å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã«é€ã£ãŸã‚Šã€å¤–éƒ¨APIã‚’å©ã„ãŸã‚Šã™ã‚‹
* ä¾‹ï¼šCRMã€æ±ºæ¸ˆé€£æºã€é…é€SaaSé€£æºã€ä¼šè¨ˆã‚·ã‚¹ãƒ†ãƒ é€£æº ãªã©

**ç‰¹å¾´**ï¼šç›¸æ‰‹éƒ½åˆï¼ˆAPIä»•æ§˜ã€éšœå®³ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰ãŒå¤šã„ ğŸ“¡âš ï¸

---

## 15.3 åˆ†é¡ãƒ«ãƒ¼ãƒ«ã‚’ä½œã‚‹ã‚³ãƒ„ ğŸ“ğŸ§ ï¼ˆâ€œå¤‰æ›´ç†ç”±â€ã§åˆ†ã‘ã‚‹ï¼‰

åˆ†é¡ã§ä¸€ç•ªå¼·ã„è€ƒãˆæ–¹ã¯ã“ã‚ŒğŸ‘‡âœ¨
**ã€Œä½•ãŒå¤‰ã‚ã£ãŸã‚‰ã€ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ç›´ã™ï¼Ÿã€**ã§åˆ†ã‘ã‚‹ ğŸ§©ğŸ”

* æ–‡è¨€ãƒ»é€ä¿¡å…ˆãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ãŒå¤‰ã‚ã£ãŸã‚‰ç›´ã™ â†’ é€šçŸ¥ç³» ğŸ“©
* ç”»é¢ã®ä¸€è¦§è¡¨ç¤ºãŒå¤‰ã‚ã£ãŸã‚‰ç›´ã™ â†’ é›†è¨ˆ/æŠ•å½±ç³» ğŸ“Š
* å¤–éƒ¨APIãŒå¤‰ã‚ã£ãŸã‚‰ç›´ã™ â†’ é€£æºç³» ğŸ”—

ã“ã†ã—ã¦ãŠãã¨ã€ã€Œå¤‰æ›´ã®æ³¢ã€ãŒæ¥ã¦ã‚‚è¢«å®³ãŒå°ã•ã„ã§ã™ ğŸŒŠğŸ›Ÿ
ï¼ˆSoCã®æ„Ÿè¦šãŒã€ã“ã“ã§ã‚ã¡ã‚ƒåŠ¹ãã¾ã™ğŸ§±âœ¨ï¼‰

---

## 15.4 å‘½åãƒ«ãƒ¼ãƒ«ï¼šã‚¤ãƒ™ãƒ³ãƒˆåï¼‹ã‚„ã‚‹ã“ã¨ï¼è¿·å­ã‚¼ãƒ­ ğŸ§­âœ…

### ãƒ«ãƒ¼ãƒ«Aï¼ˆãŠã™ã™ã‚ï¼‰ï¼š`<Event>_<Action>Handler` ğŸ§©

* `OrderPaid_SendReceiptEmailHandler` ğŸ“©
* `OrderPaid_GrantPointsHandler` ğŸª™
* `OrderPaid_UpdateSalesSummaryHandler` ğŸ“Š
* `OrderPaid_SyncCrmHandler` ğŸ”—

**ã„ã„ã¨ã“ã‚**ï¼šãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¦‹ãŸã ã‘ã§ã€Œã„ã¤ä½•ã‚’ã™ã‚‹ã€ãŒä¸€ç™ºã§ã‚ã‹ã‚‹ ğŸ‘€âœ¨

> ğŸ’¡ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€Œèµ·ããŸäº‹å®Ÿã€ã‚’è¡¨ã™ã®ã§ã€éå»å½¢ã®ã‚¤ãƒ™ãƒ³ãƒˆåã«ã—ã¦ãŠãã¨æ•´ç†ã—ã‚„ã™ã„ã§ã™ â³âœ… ([Stack Overflow][2])

---

## 15.5 ãƒ•ã‚©ãƒ«ãƒ€è¨­è¨ˆï¼šå¢—ãˆã¦ã‚‚ç ´ç¶»ã—ãªã„â€œç½®ãå ´æ‰€ã®å‹â€ğŸ—‚ï¸âœ¨

ã“ã“ã¯æµæ´¾ãŒã‚ã‚‹ã‘ã©ã€åˆå¿ƒè€…ãŒäº‹æ•…ã‚Šã«ãã„â€œé‰„æ¿3ã¤â€ã‚’å‡ºã—ã¾ã™ ğŸ€

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³1ï¼šã‚«ãƒ†ã‚´ãƒªï¼ˆé€šçŸ¥/é›†è¨ˆ/é€£æºï¼‰ã§åˆ‡ã‚‹ ğŸ“šğŸ—‚ï¸ï¼ˆãŠã™ã™ã‚ï¼‰

ã€Œä½•ã®ãŸã‚ã®ãƒãƒ³ãƒ‰ãƒ©ï¼Ÿã€ã§ç½®ãå ´æ‰€ãŒæ±ºã¾ã‚‹ã®ã§ã€è¿·ã„ã¥ã‚‰ã„ã§ã™ ğŸ˜Š

```text
src/
  application/
    handlers/
      notification/
        order/
          OrderPaid_SendReceiptEmailHandler.ts
      projection/
        sales/
          OrderPaid_UpdateSalesSummaryHandler.ts
      integration/
        crm/
          OrderPaid_SyncCrmHandler.ts
```

**å‘ã„ã¦ã‚‹**ï¼šãƒãƒ³ãƒ‰ãƒ©ãŒå¢—ãˆã‚‹ã»ã©å¼·ã„ ğŸ’ªğŸ“ˆ
**å¼±ç‚¹**ï¼šåŒã˜ã‚¤ãƒ™ãƒ³ãƒˆãŒè¤‡æ•°ãƒ•ã‚©ãƒ«ãƒ€ã«æ•£ã‚‹ï¼ˆã§ã‚‚åˆ†é¡ã®å‹ã¡ï¼ï¼‰ğŸ§ âœ¨

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³2ï¼šã‚¤ãƒ™ãƒ³ãƒˆã”ã¨ã«æŸã­ã‚‹ ğŸ””ğŸ“¦ï¼ˆå°è¦æ¨¡å‘ã‘ï¼‰

ã€Œã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã«ä½•ãŒã¶ã‚‰ä¸‹ãŒã£ã¦ã‚‹ï¼Ÿã€ãŒè¦‹ã‚„ã™ã„ã§ã™ ğŸ‘€

```text
src/
  application/
    handlers/
      order-paid/
        SendReceiptEmailHandler.ts
        GrantPointsHandler.ts
        UpdateSalesSummaryHandler.ts
        SyncCrmHandler.ts
```

**å‘ã„ã¦ã‚‹**ï¼šã‚¤ãƒ™ãƒ³ãƒˆæ•°ãŒå°‘ãªãã€1ã‚¤ãƒ™ãƒ³ãƒˆã®åå¿œãŒå¤šã„ã¨ã ğŸ¯
**å¼±ç‚¹**ï¼šã€Œé€šçŸ¥ã ã‘è¦‹ãŸã„ã€ãŒã‚„ã‚Šã«ãã„ ğŸ“©ğŸ˜µâ€ğŸ’«

---

### ãƒ‘ã‚¿ãƒ¼ãƒ³3ï¼šå¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ å˜ä½ã§æŸã­ã‚‹ ğŸ”—ğŸ¢ï¼ˆé€£æºãŒå¤šã„ã¨ãï¼‰

```text
src/
  application/
    handlers/
      integration/
        crm/
          OrderPaid.ts
          OrderShipped.ts
        accounting/
          OrderPaid.ts
```

**å‘ã„ã¦ã‚‹**ï¼šã€Œç›¸æ‰‹ã®APIéƒ½åˆã€ã§å¤‰æ›´ãŒæ¥ã‚‹ç¾å ´ ğŸ“¡âš ï¸
**å¼±ç‚¹**ï¼šã‚¤ãƒ™ãƒ³ãƒˆèµ·ç‚¹ã®æ¢ç´¢ãŒå¼±ã„ ğŸ”

---

## 15.6 â€œç™»éŒ²ã®ã—ã‹ãŸâ€ãŒæ•´ç†ã®9å‰² ğŸ“£ğŸ§©ï¼ˆå¢—ãˆã¦ã‚‚å£Šã‚Œãªã„ä»•çµ„ã¿ï¼‰

ãƒãƒ³ãƒ‰ãƒ©ãŒå¢—ãˆã‚‹ã¨ã€æœ€å¤§ã®åœ°é›·ã¯ã“ã‚ŒğŸ‘‡ğŸ’¥

* ã©ã“ã§ãƒãƒ³ãƒ‰ãƒ©ãŒå‘¼ã°ã‚Œã¦ã‚‹ã‹è¿½ãˆãªã„
* è¿½åŠ ã—ãŸã®ã«ç™»éŒ²ã—å¿˜ã‚Œã‚‹
* ã€Œãªãœã‹å‹•ã‹ãªã„ã€ğŸ˜‡

ã ã‹ã‚‰ **ç™»éŒ²ã®å…¥å£ã‚’1ã‹æ‰€**ã«ã—ã¾ã™ ğŸšªâœ¨

---

### 15.6.1 æœ€å°ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ ğŸ€

```ts
// src/application/eventing/EventHandler.ts
export type AnyDomainEvent = Readonly<{
  type: string;
  eventId: string;
  occurredAt: string; // ISOæ–‡å­—åˆ—ã§OK
  aggregateId: string;
  payload: unknown;
}>;

export interface EventHandler<E extends AnyDomainEvent = AnyDomainEvent> {
  readonly eventType: E["type"];
  handle(event: E): Promise<void>;
}
```

---

### 15.6.2 ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ£ï¼ˆé…ã‚‹äººï¼‰ğŸ“£ğŸšš

```ts
// src/application/eventing/DomainEventDispatcher.ts
import type { AnyDomainEvent, EventHandler } from "./EventHandler.js";

export class DomainEventDispatcher {
  private readonly handlersByType = new Map<string, EventHandler[]>();

  register(handler: EventHandler) {
    const list = this.handlersByType.get(handler.eventType) ?? [];
    list.push(handler);
    this.handlersByType.set(handler.eventType, list);
  }

  registerMany(handlers: readonly EventHandler[]) {
    for (const h of handlers) this.register(h);
  }

  async dispatch(events: readonly AnyDomainEvent[]) {
    for (const event of events) {
      const handlers = this.handlersByType.get(event.type) ?? [];
      for (const handler of handlers) {
        await handler.handle(event);
      }
    }
  }
}
```

> âš¡ã€ŒåŒæœŸ/éåŒæœŸã®é †åºã©ã†ã™ã‚‹ï¼Ÿã€ã¯æ¬¡ç« ã§ã‚„ã‚‹ã®ã§ã€ã“ã®ç« ã§ã¯ã¾ãš â€œã¡ã‚ƒã‚“ã¨æ•´ç†ã§ãã‚‹â€ ã‚’å„ªå…ˆã§OKã§ã™ ğŸ•°ï¸âœ¨

---

## 15.7 å…·ä½“ä¾‹ï¼š`OrderPaid` ã®ãƒãƒ³ãƒ‰ãƒ©ã‚’3åˆ†é¡ã§åˆ†ã‘ã‚‹ ğŸ±âœ¨

### 15.7.1 ã‚¤ãƒ™ãƒ³ãƒˆå‹ï¼ˆä¾‹ï¼‰ğŸ””

```ts
// src/domain/order/events/OrderPaid.ts
export type OrderPaid = Readonly<{
  type: "OrderPaid";
  eventId: string;
  occurredAt: string;
  aggregateId: string; // orderIdã§ã‚‚OK
  payload: Readonly<{
    orderId: string;
    userId: string;
    amount: number;
    currency: "JPY";
  }>;
}>;
```

---

### 15.7.2 é€šçŸ¥ç³»ï¼šãƒ¬ã‚·ãƒ¼ãƒˆãƒ¡ãƒ¼ãƒ« ğŸ“©âœ¨

```ts
// src/application/handlers/notification/order/OrderPaid_SendReceiptEmailHandler.ts
import type { EventHandler } from "../../../eventing/EventHandler.js";
import type { OrderPaid } from "../../../../domain/order/events/OrderPaid.js";

export interface EmailSender {
  sendReceipt(input: { userId: string; orderId: string; amount: number }): Promise<void>;
}

export class OrderPaid_SendReceiptEmailHandler implements EventHandler<OrderPaid> {
  readonly eventType = "OrderPaid" as const;

  constructor(private readonly emailSender: EmailSender) {}

  async handle(event: OrderPaid) {
    const { userId, orderId, amount } = event.payload;
    await this.emailSender.sendReceipt({ userId, orderId, amount });
  }
}
```

* **ã“ã®ãƒãƒ³ãƒ‰ãƒ©ãŒå¤‰ã‚ã‚‹ç†ç”±**ï¼šãƒ¡ãƒ¼ãƒ«æ–‡è¨€ã€é€ä¿¡æ¡ä»¶ã€ãƒ†ãƒ³ãƒ—ãƒ¬ã€é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹å¤‰æ›´ ğŸ“©ğŸ“
* ã ã‹ã‚‰ã€Œé€šçŸ¥ã€ã«ç½®ãã®ãŒè‡ªç„¶ã§ã™ âœ…âœ¨

---

### 15.7.3 é›†è¨ˆãƒ»æŠ•å½±ç³»ï¼šå£²ä¸Šã‚µãƒãƒªæ›´æ–° ğŸ“Šâœ¨

```ts
// src/application/handlers/projection/sales/OrderPaid_UpdateSalesSummaryHandler.ts
import type { EventHandler } from "../../../eventing/EventHandler.js";
import type { OrderPaid } from "../../../../domain/order/events/OrderPaid.js";

export interface SalesSummaryRepository {
  addRevenue(input: { date: string; amount: number; currency: "JPY" }): Promise<void>;
}

export class OrderPaid_UpdateSalesSummaryHandler implements EventHandler<OrderPaid> {
  readonly eventType = "OrderPaid" as const;

  constructor(private readonly repo: SalesSummaryRepository) {}

  async handle(event: OrderPaid) {
    const date = event.occurredAt.slice(0, 10); // YYYY-MM-DD
    await this.repo.addRevenue({ date, amount: event.payload.amount, currency: event.payload.currency });
  }
}
```

* **å¤‰ã‚ã‚‹ç†ç”±**ï¼šç”»é¢ã§æ¬²ã—ã„é›†è¨ˆãŒå¤‰ã‚ã‚‹ã€ç²’åº¦ãŒå¤‰ã‚ã‚‹ ğŸ“ˆ
* ã ã‹ã‚‰ã€Œprojectionã€ã«ç½®ãã®ãŒè‡ªç„¶ã§ã™ âœ…âœ¨

---

### 15.7.4 é€£æºç³»ï¼šCRMã¸åŒæœŸ ğŸ”—âœ¨

```ts
// src/application/handlers/integration/crm/OrderPaid_SyncCrmHandler.ts
import type { EventHandler } from "../../../eventing/EventHandler.js";
import type { OrderPaid } from "../../../../domain/order/events/OrderPaid.js";

export interface CrmClient {
  upsertPurchase(input: { userId: string; orderId: string; amount: number; occurredAt: string }): Promise<void>;
}

export class OrderPaid_SyncCrmHandler implements EventHandler<OrderPaid> {
  readonly eventType = "OrderPaid" as const;

  constructor(private readonly crm: CrmClient) {}

  async handle(event: OrderPaid) {
    const { userId, orderId, amount } = event.payload;
    await this.crm.upsertPurchase({ userId, orderId, amount, occurredAt: event.occurredAt });
  }
}
```

* **å¤‰ã‚ã‚‹ç†ç”±**ï¼šç›¸æ‰‹APIã®ä»•æ§˜ãƒ»èªè¨¼æ–¹å¼ãƒ»ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãªã© ğŸ”ğŸ“¡
* ã ã‹ã‚‰ã€Œintegrationã€ã«ç½®ãã®ãŒè‡ªç„¶ã§ã™ âœ…âœ¨

---

## 15.8 â€œç™»éŒ²ã®å…¥å£â€ã‚’1ã‹æ‰€ã«ã™ã‚‹ï¼ˆã“ã‚Œã§è¿·å­ãŒæ¶ˆãˆã‚‹ï¼‰ğŸ§­âœ¨

```ts
// src/application/handlers/index.ts
import type { EventHandler } from "../eventing/EventHandler.js";
import { OrderPaid_SendReceiptEmailHandler } from "./notification/order/OrderPaid_SendReceiptEmailHandler.js";
import { OrderPaid_UpdateSalesSummaryHandler } from "./projection/sales/OrderPaid_UpdateSalesSummaryHandler.js";
import { OrderPaid_SyncCrmHandler } from "./integration/crm/OrderPaid_SyncCrmHandler.js";

// ã“ã“ã§ã¯ã€Œnewã€ã—ã¦ã‚‹ã‘ã©ã€DIã¯å¾Œã®ç« ã§ç¾ã—ãã§ãã‚‹ã‚ˆğŸª„
// ã„ã£ãŸã‚“æœ€å°ã§OKï¼
export function buildHandlers(deps: {
  emailSender: ConstructorParameters<typeof OrderPaid_SendReceiptEmailHandler>[0];
  salesRepo: ConstructorParameters<typeof OrderPaid_UpdateSalesSummaryHandler>[0];
  crmClient: ConstructorParameters<typeof OrderPaid_SyncCrmHandler>[0];
}): EventHandler[] {
  return [
    new OrderPaid_SendReceiptEmailHandler(deps.emailSender),
    new OrderPaid_UpdateSalesSummaryHandler(deps.salesRepo),
    new OrderPaid_SyncCrmHandler(deps.crmClient),
  ];
}
```

ãã—ã¦ã‚¢ãƒ—ãƒªå±¤ã®èµ·å‹•æ™‚ã«ğŸ‘‡

```ts
import { DomainEventDispatcher } from "./eventing/DomainEventDispatcher.js";
import { buildHandlers } from "./handlers/index.js";

const dispatcher = new DomainEventDispatcher();
dispatcher.registerMany(buildHandlers({ emailSender, salesRepo, crmClient }));

// ã‚ã¨ã¯ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ events ã‚’é›†ã‚ã¦ dispatch ã™ã‚‹ã ã‘ğŸ“£âœ¨
```

---

## 15.9 ã¡ã‚‡ã„æœ€æ–°ãƒˆãƒ”ãƒƒã‚¯ï¼šãƒãƒ³ãƒ‰ãƒ©ã‚’â€œé…å»¶ãƒ­ãƒ¼ãƒ‰â€ã™ã‚‹ï¼ˆä¸Šç´šï¼‰ğŸ¢â¡ï¸âš¡

TypeScript 5.9 ã§ã¯ `import defer` ãŒå…¥ã‚Šã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è©•ä¾¡ï¼ˆå®Ÿè¡Œï¼‰ã‚’é…ã‚‰ã›ã‚‰ã‚Œã¾ã™ ğŸ§ âœ¨
ã€Œæ™®æ®µã¯ä½¿ã‚ãªã„åˆ†æç³»ãƒãƒ³ãƒ‰ãƒ©ã€ã‚’ã€å¿…è¦ãªã¨ãã ã‘èª­ã¿è¾¼ã‚€â€¦ã¿ãŸã„ãªè¨­è¨ˆãŒã—ã‚„ã™ããªã‚Šã¾ã™ ğŸ“¦ğŸ•°ï¸ ([TypeScript][3])

```ts
// ä¾‹ï¼šåˆ†æç³»ã®ç™»éŒ²ã‚’é…ã‚‰ã›ã‚‹ï¼ˆé›°å›²æ°—ï¼‰
import defer * as analytics from "./handlers/analytics/index.js";

if (process.env.ENABLE_ANALYTICS === "1") {
  // æœ€åˆã« analytics ã‚’è§¦ã£ãŸç¬é–“ã«è©•ä¾¡ã•ã‚Œã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸âœ¨
  dispatcher.registerMany(analytics.buildAnalyticsHandlers());
}
```

> ğŸ’¡ã€Œä»Šã™ãå¿…é ˆã€ã˜ã‚ƒãªã„ã‘ã©ã€ãƒãƒ³ãƒ‰ãƒ©ãŒå¢—ãˆã¦ããŸæœªæ¥ã«åŠ¹ãå°æŠ€ã§ã™ ğŸª„

---

## 15.10 ã‚ˆãã‚ã‚‹å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨å›é¿ ğŸ§¯âœ…

### å¤±æ•—Aï¼š1ãƒãƒ³ãƒ‰ãƒ©ã§å…¨éƒ¨ã‚„ã‚‹ ğŸ‘‘ğŸ’£

* ãƒ¡ãƒ¼ãƒ«ã‚‚ãƒã‚¤ãƒ³ãƒˆã‚‚CRMã‚‚1ã‚¯ãƒ©ã‚¹ã§â€¦
  â†’ **å¤‰æ›´ç†ç”±ãŒæ··ã–ã£ã¦çˆ†ç™º**ã—ã¾ã™ ğŸ’¥

âœ…å›é¿ï¼š**â€œ1ãƒãƒ³ãƒ‰ãƒ©ï¼1é–¢å¿ƒâ€**ï¼ˆ1ç›®çš„ï¼‰ğŸ¯

---

### å¤±æ•—Bï¼šå·¨å¤§switchã§åˆ†å²ã™ã‚‹ ğŸ§Ÿâ€â™‚ï¸ğŸª“

* `handle(event){ switch(event.type){...}}`
  â†’ è¿½åŠ ã®ãŸã³ã«å·¨å¤§åŒ–ã€å½±éŸ¿ç¯„å›²ãŒèª­ã‚ãªã„ ğŸ˜µâ€ğŸ’«

âœ…å›é¿ï¼š**å‹ + ç™»éŒ²**ã§ã€Œè¿½åŠ ã¯ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ ã€ã§çµ‚ã‚ã‚‰ã›ã‚‹ ğŸ—‚ï¸âœ¨

---

### å¤±æ•—Cï¼šãƒ•ã‚©ãƒ«ãƒ€ãŒæ°—åˆ†ã§å¢—ãˆã‚‹ ğŸŒ€ğŸ“

* `misc/`, `temp/`, `new/` ãŒç”Ÿã¾ã‚Œã‚‹
  â†’ 3ãƒ¶æœˆå¾Œã«èª°ã‚‚æ¢ã›ãªã„ ğŸ« 

âœ…å›é¿ï¼š**åˆ†é¡ã¯æœ€åˆã«3ã¤ã«å›ºå®š**ï¼ˆé€šçŸ¥/æŠ•å½±/é€£æºï¼‰ğŸ“šâœ…
å¢—ã‚„ã™ã®ã¯â€œå¿…è¦ã«ãªã£ã¦ã‹ã‚‰â€ã§OKï¼

---

## 15.11 æ¼”ç¿’ï¼šãƒãƒ³ãƒ‰ãƒ©ã‚’ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«æ•´ç†ã—ã‚ˆã† ğŸ“ğŸ’–

### æ¼”ç¿’1ï¼šåˆ†é¡ã—ã¦ã¿ã‚ˆã† ğŸ“š

æ¬¡ã‚’ã€Œé€šçŸ¥/æŠ•å½±/é€£æºã€ã«æŒ¯ã‚Šåˆ†ã‘ã¦ã­ğŸ‘‡âœ¨

* `OrderPaid` â†’ ãƒ¬ã‚·ãƒ¼ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ ğŸ“©
* `OrderPaid` â†’ å£²ä¸Šæ—¥æ¬¡ã‚µãƒãƒªæ›´æ–° ğŸ“Š
* `OrderPaid` â†’ CRMåŒæœŸ ğŸ”—
* `OrderShipped` â†’ ç™ºé€é€šçŸ¥ ğŸ“¦ğŸ“©
* `OrderShipped` â†’ é…é€ä¼šç¤¾APIã¸ç™ºé€ãƒ‡ãƒ¼ã‚¿é€ä¿¡ ğŸššğŸ”—

---

### æ¼”ç¿’2ï¼šãƒ•ã‚©ãƒ«ãƒ€è¨­è¨ˆã‚’æ±ºã‚ã‚ˆã† ğŸ—‚ï¸

ãƒ‘ã‚¿ãƒ¼ãƒ³1ï¼ˆã‚«ãƒ†ã‚´ãƒªã§åˆ‡ã‚‹ï¼‰ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€ã‚ãªãŸã®é¡Œæã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œã£ã¦ã¿ã‚ˆã† âœ¨
`notification / projection / integration` ã®3ã¤ã¯å›ºå®šã§OKã§ã™ ğŸ“Œ

---

### æ¼”ç¿’3ï¼šå‘½åã‚’æ•´ãˆã‚ˆã† âœï¸

å‘½ä»¤ã£ã½ã„åå‰ã‚’ã€ã‚¤ãƒ™ãƒ³ãƒˆèµ·ç‚¹ã§â€œä½•ã‚’ã™ã‚‹ã‹â€ãŒè¦‹ãˆã‚‹å½¢ã«ç›´ã—ã¦ã­ğŸ˜Š

* `SendMailHandler` â†’ âœ… `OrderPaid_SendReceiptEmailHandler`
* `UpdateDbHandler` â†’ âœ… `OrderPaid_UpdateSalesSummaryHandler`

---

## 15.12 AIæ´»ç”¨ï¼ˆã¶ã‚Œãªã„åˆ†é¡ãƒ«ãƒ¼ãƒ«ã‚’ä½œã‚‹ï¼‰ğŸ¤–ğŸ“âœ¨

### ä½¿ãˆã‚‹èãæ–¹ãƒ†ãƒ³ãƒ—ãƒ¬ ğŸ§ 

* ã€Œã“ã®ãƒãƒ³ãƒ‰ãƒ©ä¸€è¦§ã‚’â€œé€šçŸ¥/æŠ•å½±/é€£æºâ€ã«åˆ†é¡ã—ã¦ã€‚åˆ†é¡ç†ç”±ã‚‚1è¡Œã§ã€ğŸ“š
* ã€Œå‘½åãƒ«ãƒ¼ãƒ«ã‚’1ã¤æ±ºã‚ã¦ã€æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¨éƒ¨ãƒªãƒãƒ¼ãƒ æ¡ˆå‡ºã—ã¦ã€ğŸ“
* ã€Œãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆãŒæ•£ã‚‰ã‹ã‚Šãã†ãªãƒã‚¤ãƒ³ãƒˆã‚’æŒ‡æ‘˜ã—ã¦ã€è¦ç´„æ¡ˆã‚’ä½œã£ã¦ã€ğŸ—‚ï¸âœ…

### ã‚³ãƒ„ ğŸ€

AIã«ä¸¸æŠ•ã’ã˜ã‚ƒãªãã¦ã€**â€œåˆ†é¡è»¸ï¼ˆå¤‰æ›´ç†ç”±ï¼‰â€**ã‚’å…ˆã«æ¸¡ã™ã¨ç²¾åº¦ãŒè·³ã­ã¾ã™ ğŸ“ˆâœ¨
ï¼ˆä¾‹ï¼šã€Œé€šçŸ¥ï¼ä¼ãˆæ–¹ãŒå¤‰ã‚ã‚‹ã€ã€ŒæŠ•å½±ï¼è¡¨ç¤ºéƒ½åˆã€ã€Œé€£æºï¼ç›¸æ‰‹éƒ½åˆã€ï¼‰

---

## 15.13 ã¾ã¨ã‚ ğŸâœ¨

* ãƒãƒ³ãƒ‰ãƒ©ã¯å¢—ãˆã‚‹å‰æï¼ã ã‹ã‚‰æœ€åˆã« **åˆ†é¡ï¼ˆé€šçŸ¥/æŠ•å½±/é€£æºï¼‰** ã‚’å›ºå®šã™ã‚‹ ğŸ“šâœ…
* å‘½åã¯ **ã‚¤ãƒ™ãƒ³ãƒˆåï¼‹ã‚„ã‚‹ã“ã¨** ã§è¿·å­ã‚¼ãƒ­ ğŸ§­âœ¨
* ç™»éŒ²ã®å…¥å£ã‚’ **1ã‹æ‰€**ã«ã—ã¦ã€è¿½åŠ ã‚’â€œãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ ã ã‘â€ã«ã™ã‚‹ ğŸ—‚ï¸ğŸ“£
* `import defer` ã¿ãŸã„ãªæ–°ã—ã‚æ©Ÿèƒ½ã§ã€å°†æ¥ã®ã‚¹ã‚±ãƒ¼ãƒ«ã«ã‚‚å‚™ãˆã‚‰ã‚Œã‚‹ ğŸ¢âš¡ ([TypeScript][3])

æ¬¡ç« ã¯ã€ŒåŒæœŸ/éåŒæœŸã¨é †åºã€âš¡ğŸ•°ï¸
ã“ã“ã§æ•´ç†ã—ãŸãƒãƒ³ãƒ‰ãƒ©ãŸã¡ã‚’ã€ã©ã†å®Ÿè¡Œã™ã¹ãã‹åˆ¤æ–­ã—ã¦ã„ãã¾ã™ ğŸ±â¡ï¸ğŸš€

[1]: https://learn.microsoft.com/en-us/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/domain-events-design-implementation?utm_source=chatgpt.com "Domain events: Design and implementation - .NET"
[2]: https://stackoverflow.com/questions/12510535/naming-convention-for-commands-events?utm_source=chatgpt.com "Naming Convention for Commands & Events"
[3]: https://www.typescriptlang.org/docs/handbook/release-notes/typescript-5-9.html?utm_source=chatgpt.com "Documentation - TypeScript 5.9"
